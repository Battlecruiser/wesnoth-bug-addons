#textdomain wesnoth-loti

#define DROPS CHANCE CHANCE_GEM WEAPONS BOSSES ENEMIES
    #Adjust this macro to control drops better
    [event]
        name=die
        first_time_only=no
        [filter]
            side={ENEMIES}
        [/filter]
        {VARIABLE_OP did_drop rand (1..100)}
        [if]
            [variable]
                name=did_drop
                less_than_equal_to={CHANCE}
            [/variable]
            [then]
                [set_variable]
                    name=item_unknown_x
                    value=$x1
                [/set_variable]
                [set_variable]
                    name=item_unknown_y
                    value=$y1
                [/set_variable]
                {GENERATE_ITEM {WEAPONS}}
                [set_variables]
                    name=items
                    mode=append
                    [value]
                        x=$item_unknown_x
                        y=$item_unknown_y
                        type=$item_type
                    [/value]
                [/set_variables]
                {PLACE_ITEM_EVENT $x1 $y1}
                {DRAW_ITEM}
            [/then]
        [/if]
        [if]
            [variable]
                name=unit.canrecruit
                equals=yes
            [/variable]
            [and]
                [variable]
                    name=unit.canrecruit
                    equals={BOSSES}
                [/variable]
            [/and]
            [then]
                [set_variable]
                    name=item_unknown_x
                    value=$x1
                [/set_variable]
                [set_variable]
                    name=item_unknown_y
                    value=$y1
                [/set_variable]
                {GENERATE_ITEM {WEAPONS}}
                [set_variables]
                    name=items
                    mode=append
                    [value]
                        x=$item_unknown_x
                        y=$item_unknown_y
                        type=$item_type
                        turn=$turn_number
                    [/value]
                [/set_variables]
                {PLACE_ITEM_EVENT $item_unknown_x $item_unknown_y}
                {DRAW_ITEM}
            [/then]
        [/if]
        {CLEAR_VARIABLE did_drop}
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter]
            side={ENEMIES}
        [/filter]
        {VARIABLE_OP did_drop rand (1..100)}
        [if]
            [variable]
                name=did_drop
                less_than_equal_to={CHANCE_GEM}
            [/variable]
	    [or]
	        [variable]
	            name=unit.variables.bonus_boss
	            equals=yes
	        [/variable]
	    [/or]
            [then]
                [set_variable]
                    name=item_unknown_x
                    value=$x1
                [/set_variable]
                [set_variable]
                    name=item_unknown_y
                    value=$y1
                [/set_variable]
                {VARIABLE_OP item_type rand (521,521,521,521,521,521,521,521,521,521,522,522,522,522,522,522,523,523,523,523,523,524,524,524,524,524,524)}
                [if]
                    [variable]
                        name=item_type
                        equals=524
                    [/variable]
		    [or]
		        [variable]
		            name=unit.variables.bonus_boss
		            equals=yes
		        [/variable]
		    [/or]
                    [then]
#ifdef LOTI_LOW_DROPS
                        {VARIABLE_OP item_type rand (524,524,524,524,524,524,524,524,524,525,525,525,525,526,526,527,527)}
#else
                        {VARIABLE_OP item_type rand (524,524,524,524,524,524,524,524,524,525,525,525,525,525,525,526,526,526,526,527,527,527,527,527,527)}
#endif
                        [if]
                            [variable]
                                name=item_type
                                equals=527
                            [/variable]
			    [or]
			        [variable]
			            name=unit.variables.bonus_boss
			            equals=yes
			        [/variable]
			    [/or]
                            [then]
                                {VARIABLE_OP item_type rand (530,530,529,529,529,528,528,528,528,528,527,527,527,527,527,527,527,527)}
                            [/then]
                        [/if]
                    [/then]
                [/if]
                [set_variables]
                    name=items
                    mode=append
                    [value]
                        x=$item_unknown_x
                        y=$item_unknown_y
                        type=$item_type
                    [/value]
                [/set_variables]
                {PLACE_ITEM_EVENT $item_unknown_x $item_unknown_y}
                {DRAW_ITEM}
            [/then]
        [/if]
        {CLEAR_VARIABLE did_drop,item_type}
    [/event]
    [event]
        name=prestart
        {VARIABLE enemy_sides ({ENEMIES})}
    [/event]
#enddef

#define REMOVE_SPECIALS_RECALL SPECIAL
    {FOREACH side[$i].attack[$j].specials.{SPECIAL} k}
        [if]
            [variable]
                name=side[$i].attack[$j].specials.{SPECIAL}[$k].id
                contains="latent"
            [/variable]
            [then]
                {CLEAR_VARIABLE side[$i].attack[$j].specials.{SPECIAL}[$k]}
                {VARIABLE_OP k sub 1}
            [/then]
        [/if]
    {NEXT k}
#enddef

#define PLACE_ITEM_EVENT X Y
    [set_variables]
        name=item_event
        mode=replace
        [literal]
            name=moveto
            first_time_only=no	#This would cause a neglectful delay and break the 'press t to keep moving' thing when stepping on places where items dropped, but the delay
            [filter]		#is really neglectful and the player is not very likely to discover some units when walking where items already dropped. It might be more
                x,y={X},{Y}	#significant in HotOW, but it would just fool the player to assure that he won't notice enemy spawns due to the delays when they are created.
#ifndef MULTIPLAYER
                side=1
#else
                side=1,2,3,4,5
#endif
                [not]
                    [filter_wml]
                        [variables]
                            cant_pick=yes
                        [/variables]
                    [/filter_wml]
                [/not]
            [/filter]
            [fire_event]
                name=item_pick
                [primary_unit]
                    x,y=$x1,$y1
                [/primary_unit]
            [/fire_event]
        [/literal]
    [/set_variables]
    {VARIABLE item_event.id "ie{X}|{Y}"}
    {VARIABLE item_event.filter.x {X}}
    {VARIABLE item_event.filter.y {Y}}
    [insert_tag]
        name=event
        variable=item_event
    [/insert_tag]
    {CLEAR_VARIABLE item_event}
#enddef

#define CREATE_OPTION_FOR_STORAGE_SORT SORT
    [if]
        [variable]
            name=item_storage.{SORT}.length
            greater_than=0
        [/variable]
        [then]
            {VARIABLE inventory_message.option[$inventory_message.option.length].message "$item_type_translations.{SORT}.translation ($item_storage.{SORT}.length|)"}
            {VARIABLE "inventory_message.option[$($inventory_message.option.length-1)].command.set_variable.name" item_sort_chosen}
            {VARIABLE "inventory_message.option[$($inventory_message.option.length-1)].command.set_variable.value" {SORT}}
        [/then]
    [/if]
#enddef

#define TEXT_COUNT VARIABLE_NAME FROM TO
    [if]
        [variable]
            name={VARIABLE_NAME}
            equals="{FROM}"
        [/variable]
        [then]
            {VARIABLE {VARIABLE_NAME} {TO}}
        [/then]
    [/if]
#enddef

#define NARRATOR_MESSAGE TEXT
    [message]
        speaker=narrator
        image="wesnoth-icon.png"
        message={TEXT}
    [/message]
#enddef
#define SET_ZEROES VARIABLE_NAME
    [if]
        [variable]
            name={VARIABLE_NAME}
            greater_than=0
        [/variable]
        [else]
            {VARIABLE {VARIABLE_NAME} 0}
        [/else]
    [/if]
#enddef
#define CHECK_FOR MATERIAL
    [and]
        [variable]
            name=item_list.object[$item_chosen].{MATERIAL}
            less_than_equal_to=${MATERIAL}
        [/variable]
    [/and]
#enddef

#define LIST_MATERIAL_REQUIREMENTS MATERIAL LANGUAGE_MATERIAL
    [if]
        [variable]
            name=item_list.object[$i].{MATERIAL}
            greater_than=0
        [/variable]
        [then]
            [if]
                [variable]
                    name=item_list.object[$i].{MATERIAL}
                    less_than_equal_to=${MATERIAL}
                [/variable]
                [then]
                    [set_variable]
                        name=gem_list[$gem_list.length].message
                        value="$item_list.object[$i].{MATERIAL} "+{LANGUAGE_MATERIAL}
                    [/set_variable]
                [/then]
                [else]
                    [set_variable]
                        name=gem_list[$gem_list.length].message
                        value=_"<span color='red'>"+"$item_list.object[$i].{MATERIAL} "+{LANGUAGE_MATERIAL}+_"</span>"
                    [/set_variable]
                    {VARIABLE cannot_make yes}
                [/else]
            [/if]
        [/then]
    [/if]
#enddef

#define REMOVE_OPTION NUMBER
    [option]
        message=_"Remove "+"$item_type_translations.$drops[{NUMBER}].sort|.translation|:"+" "+"$drops[{NUMBER}].name"+_"
"+"$drops[{NUMBER}].description"
        [command]
            {VARIABLE to_remove $drops[{NUMBER}].number}
            {VARIABLE to_remove_sort $drops[{NUMBER}].sort}
            {VARIABLE item_chosen -1}
        [/command]
        [show_if]
            [variable]
                name=drops.length
                greater_than={NUMBER}
            [/variable]
        [/show_if]
    [/option]
#enddef

#define ITEM_DROP_IMAGE NUMBER IMAGE
    [if]
        [variable]
            name=item_type
            equals={NUMBER}
        [/variable]
        [then]
            [item]
                halo=halo/misc/leadership-flare-1.png:20,halo/misc/leadership-flare-2.png:20,halo/misc/leadership-flare-3.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-6.png:20,halo/misc/leadership-flare-7.png:20,halo/misc/leadership-flare-8.png:20,halo/misc/leadership-flare-9.png:20,halo/misc/leadership-flare-10.png:20,halo/misc/leadership-flare-11.png:20,halo/misc/leadership-flare-12.png:20,halo/misc/leadership-flare-13.png:20,misc/blank-hex.png:1000
                x,y=$item_unknown_x,$item_unknown_y
                image={IMAGE}
            [/item]
        [/then]
    [/if]
#enddef

#define DRAW_ITEM
    {FOREACH item_list.object p}
        [if]
            [variable]
                name=item_type
                equals=$item_list.object[$p].number
            [/variable]
            [then]
                [item]
                    halo=halo/misc/leadership-flare-1.png:20,halo/misc/leadership-flare-2.png:20,halo/misc/leadership-flare-3.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-6.png:20,halo/misc/leadership-flare-7.png:20,halo/misc/leadership-flare-8.png:20,halo/misc/leadership-flare-9.png:20,halo/misc/leadership-flare-10.png:20,halo/misc/leadership-flare-11.png:20,halo/misc/leadership-flare-12.png:20,halo/misc/leadership-flare-13.png:20,misc/blank-hex.png:1000
                    x,y=$item_unknown_x,$item_unknown_y
                    image=$item_list.object[$p].image
                [/item]
            [/then]
        [/if]
    {NEXT p}
    {CLEAR_VARIABLE item_type}
    {CLEAR_VARIABLE item_unknown_x}
    {CLEAR_VARIABLE item_unknown_y}
#enddef

#define RANDOM_ITEM X Y
    #Careful, this does not work in start events!
    [set_variable]
        name=item_unknown_x
        value={X}
    [/set_variable]
    [set_variable]
        name=item_unknown_y
        value={Y}
    [/set_variable]
    {GENERATE_ITEM (sword,axe,staff,bow,sword,axe,staff,bow,sword,axe,staff,bow,dagger,xbow,knife,mace)}
    [set_variables]
        name=items
        mode=append
        [value]
            x=$item_unknown_x
            y=$item_unknown_y
            type=$item_type
        [/value]
    [/set_variables]
    {PLACE_ITEM_EVENT {X} {Y}}
    {DRAW_ITEM}
#enddef

#define PLACE_ITEM NUMBER X Y
    [set_variable]
        name=item_unknown_x
        value={X}
    [/set_variable]
    [set_variable]
        name=item_unknown_y
        value={Y}
    [/set_variable]
    [set_variable]
        name=item_type
        value={NUMBER}
    [/set_variable]
    [set_variables]
        name=items
        mode=append
        [value]
            x={X}
            y={Y}
            type={NUMBER}
        [/value]
    [/set_variables]
    {PLACE_ITEM_EVENT {X} {Y}}
    {DRAW_ITEM}
#enddef

#define GLOBAL_EVENTS
#ifndef DISABLE_AMLA_WORKAROUND
#ifver WESNOTH_VERSION >= 1.13.0
    [event]
      name=pre advance
      first_time_only=no
      [pre_advance_stuff]
	id=$unit.id
      [/pre_advance_stuff]
    [/event]

    [event]
      name=advance
      first_time_only=no
      [advance_stuff]
	id=$unit.id
      [/advance_stuff]
    [/event]
#else
    [event]
        name=post advance
        first_time_only=no
        {VARIABLE x1 $advanced4.x}
        {VARIABLE y1 $advanced4.y}
        [if]
            [variable]
                name=skip_post_advance
                equals=yes
            [/variable]
            [else]
                [unstore_unit]
                    variable=advanced4
                    find_vacant=no
                [/unstore_unit]
                [set_variables]
                    name=advanced2
                    to_variable=advanced4
                    mode=replace
                [/set_variables]
                {CLEAR_VARIABLE advanced2.status.incinerated}
                {FOREACH advanced2.modifications.object i}
                    [if]
                        [variable]
                            name=advanced2.modifications.object[$i].sort
                            contains=potion
                        [/variable]
                        [then]
                            {CLEAR_VARIABLE advanced2.modifications.object[$i]}
                            {VARIABLE_OP i sub 1}
                        [/then]
                    [/if]
                {NEXT i}
                [unstore_unit]
                    variable=advanced2
                    find_vacant=no
                [/unstore_unit]
            [/else]
            [then]
                {FOREACH unit.modifications.object i}
                    [if]
                        [variable]
                            name=unit.modifications.object[$i].sort
                            contains=potion
                        [/variable]
                        [then]
                            {CLEAR_VARIABLE unit.modifications.object[$i]}
                            {VARIABLE_OP i sub 1}
                        [/then]
                    [/if]
                {NEXT i}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
            [/then]
        [/if]
        {UPDATE_STATS}
        {CLEAR_VARIABLE advanced,advanced4,advanced3,skip_post_advance}
    [/event]
#endif
#endif
    [event]
        name=prestart
        [unit]
            type=Event Loader
            side=1
            x,y=1,1
        [/unit]
        [kill]
            type=Event Loader
            animate=no
        [/kill]
    [/event]
#enddef

#define GLOBAL_EVENTS_LIST
    {ABILITIES_EVENTS}
    {SOUL_EATER}
    {REDEEMING}
    [event]
        name=victory
        {FOREACH items k}
            [remove_item]
                x,y=$items[$k].x,$items[k$].y
            [/remove_item]
            [if]
                [variable]
                    name=items[$k].turn
                    equals=$turn_number
                [/variable]
                [then]
                    {FOREACH item_list.object i}
                        [if]
                            [variable]
                                name=item_list.object[$i].number
                                equals=$items[$k].type
                            [/variable]
                            [then]
                                {VARIABLE_OP length to_variable "item_storage.$item_list.object[$i].sort|.length"}
                                [set_variables]
                                    name=item_storage.$item_list.object[$i].sort|[$length]
                                    mode=replace
                                    [value]
                                        type=$items[$k].type
                                    [/value]
                                [/set_variables]
                                {CLEAR_VARIABLE length}
                            [/then]
                        [/if]
                    {NEXT i}
                [/then]
            [/if]
        {NEXT k}
        {CLEAR_VARIABLE item_x,item_y,items}
    [/event]
    [event]
        name=victory
        id=kill_walking_corpses
        [kill]
            type=Walking Corpse
            side=1
            [not]
                [filter_wml]
                    [variables]
                        geared=yes
                    [/variables]
                [/filter_wml]
            [/not]
            fire_event=no
            animate=no
        [/kill]
    [/event]
    {ITEM_PICK}
    [event]
        name=update_stats
        first_time_only=no
        {BACKUP_UNIT_STATS}
        {CALCULATE_WEAPONS_ONLY}
        {CALCULATE_LAST_THINGS}
        {CALCULATIONS_END}
    [/event]
#ifdef DISABLE_AMLA_WORKAROUND
    [event] # Clean version that unfortunately can't be used.
        name=post advance
        first_time_only=no
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=advanced2
            kill=yes
        [/store_unit]
        {CLEAR_VARIABLE advanced2.status.incinerated}
        [if]
            [variable]
                name=advanced2.type
                equals=Elvish Assassin
            [/variable]
            [then]
                [set_variables]
                    mode=replace
#ifver WESNOTH_VERSION >= 1.13.2
                    name=advanced2.modifications.advancement[1]
#else
                    name=advanced2.modifications.advance[1]
#endif
                    [value]
                        max_times=1
                        always_display=yes
                        id=execution
                        image=attacks/bow-elven-magic.png
                        strict_amla=yes
                        require_amla=""
                        [effect]
                            apply_to=remove_attack
                            name=execution
                        [/effect]
                        [effect]
                            apply_to=bonus_attack
                            name=execution
                            description= _ "execution"
                            icon=attacks/bow-elven-magic.png
                            range=ranged
                            defense_weight=0
                            damage=-40
                            merge=yes
                            force_original_attack=longbow
                        [/effect]
                    [/value]
                [/set_variables]
            [/then]
        [/if]
        {FOREACH advanced2.modifications.object i}
            [if]
                [variable]
                    name=advanced2.modifications.object[$i].sort
                    contains=potion
                [/variable]
                [then]
                    {CLEAR_VARIABLE advanced2.modifications.object[$i]}
                    {VARIABLE_OP i sub 1}
                [/then]
            [/if]
        {NEXT i}
        [unstore_unit]
            variable=advanced2
            find_vacant=no
        [/unstore_unit]
        {UPDATE_STATS}
    [/event]
#else
#ifver WESNOTH_VERSION >= 1.13.0

#else
    [event]
        name=advance
        first_time_only=no
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=advanced3
            kill=no
        [/store_unit]
        [if]
            [variable]
                name=advanced3.advancement.id
                equals=backup_amla
            [/variable]
            [then]
                [store_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    variable=advanced3
                    kill=yes
                [/store_unit]
                [if]
                    [variable]
                        name=advanced3.side
                        not_equals=$side_number
                    [/variable]
                    [then]
                        {VARIABLE advanced3.variables.may_need_respec yes}
                        {VARIABLE advanced3.variables.achieved_amla yes}
                        {VARIABLE advanced3.hitpoints $advanced3.max_hitpoints}
                        {CLEAR_VARIABLE advanced3.status.poisoned}
                        {CLEAR_VARIABLE advanced3.status.slowed}
                        [set_variables]
                            name=advanced4
                            to_variable=advanced3
                            mode=replace
                        [/set_variables]
                    [/then]
                    [else]
                        {CLEAR_VARIABLE advanced3.status.poisoned}
                        {CLEAR_VARIABLE advanced3.status.slowed}
                        {CLEAR_VARIABLE advanced3.status.incinerated}
                        [unit]
                            side=$advanced3.side
                            x=$advanced3.x
                            y=$advanced3.y
                            experience=$advanced3.experience
                            canrecruit=$advanced3.canrecruit
                            variation=$advanced3.variation
                            type=Advancing $advanced3.type
                            id=$advanced3.id
                            moves=$advanced3.moves
                            gender=$advanced3.gender
                            name=$advanced3.name
                            facing=$advanced3.facing
                            extra_recruit=$advanced3.extra_recruit
                            underlying_id=$advanced3.underlying_id
                            unrenamable=$advanced3.unrenamable
                            overlays=$advanced3.overlays
                            animate=no
                            [insert_tag]
                                name=status
                                variable=advanced3.status
                            [/insert_tag]
                            [insert_tag]
                                name=modifications
                                variable=advanced3.modifications
                            [/insert_tag]
                            [insert_tag]
                                name=variables
                                variable=advanced3.variables
                            [/insert_tag]
                            to_variable=advancing_store
                        [/unit]
                        [unstore_unit]
                            variable=advancing_store
                            find_vacant=no
                        [/unstore_unit]
                        [store_unit]
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            variable=advanced1
                        [/store_unit]
                        [unit]
                            side=$advanced3.side
                            x=$advanced3.x
                            y=$advanced3.y
                            experience=$advanced1.experience
                            canrecruit=$advanced3.canrecruit
                            variation=$advanced3.variation
                            type=$advanced3.type
                            id=$advanced3.id
                            moves=$advanced3.moves
                            gender=$advanced3.gender
                            name=$advanced3.name
                            facing=$advanced3.facing
                            extra_recruit=$advanced3.extra_recruit
                            underlying_id=$advanced3.underlying_id
                            unrenamable=$advanced3.unrenamable
                            animate=no
                            attacks_left=$advanced3.attacks_left
                            overlays=$advanced3.overlays
                            [insert_tag]
                                name=status
                                variable=advanced3.status
                            [/insert_tag]
                            [insert_tag]
                                name=modifications
                                variable=advanced1.modifications
                            [/insert_tag]
                            [insert_tag]
                                name=variables
                                variable=advanced3.variables
                            [/insert_tag]
                            to_variable=advanced4
                        [/unit]
                        {VARIABLE advanced4.variables.achieved_amla yes}
                    [/else]
                [/if]
#ifver WESNOTH_VERSION >= 1.11.1
                [fire_event]
                    name=post advance
                    [primary_unit]
                        id=$advanced4.id
                    [/primary_unit]
                [/fire_event]
#endif
            [/then]
            [else]
#ifver WESNOTH_VERSION >= 1.11.1
                [set_variables]
                    name="advanced4"
                    to_variable="advanced3"
                    mode="replace"
                [/set_variables]
#endif
                {VARIABLE skip_post_advance yes}
            [/else]
        [/if]
        {CLEAR_VARIABLE advancing_store,advanced1,advanced}
    [/event]
#endif
#endif
    [event]
        name=start
        {VARIABLE bosses "Umbra4,Akula,Achilles,Baal,Shadowlord,Lethalia_evil,Niflheim,Uria,Lilith,Abaddon"} #Some abilities have no effect on bosses, the game needs to know who the bosses are
        {GENERATE_ITEM_LIST}
        [set_menu_item]
            id=3dropping
            description=_"Items"
#ifver WESNOTH_VERSION >= 1.11.7
            use_hotkey=yes
            [default_hotkey]
                key=i
                shift=yes
            [/default_hotkey]
#endif
            [show_if]
                [have_unit]
                    x,y=$x1,$y1
                    side=$side_number
                    [not]
                        [filter_wml]
                            [variables]
                                cant_pick=yes
                            [/variables]
                        [/filter_wml]
                    [/not]
                [/have_unit]
            [/show_if]
            [command]
                [store_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    variable=unit
                    kill=no
                [/store_unit]
                {FOREACH unit.modifications.object i}
                    [if]
                        [variable]
                            name=unit.modifications.object[$i].sort
                            equals=sword
                        [/variable]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=axe
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=staff
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=dagger
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=armour
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=amulet
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=ring
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=cloak
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=bow
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=xbow
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=knife
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=helm
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=gauntlets
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=boots
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=mace
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=spear
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=sling
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=polearm
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=thunderstick
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=claws
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=exotic
                            [/variable]
                        [/or]
                        [or]
                            [variable]
                                name=unit.modifications.object[$i].sort
                                equals=essence
                            [/variable]
                        [/or]
                        [then]
                            [set_variables]
                                name=drops
                                mode=append
                                [value]
                                    number=$unit.modifications.object[$i].number
                                    name=$unit.modifications.object[$i].name
                                    description=$unit.modifications.object[$i].description
                                    sort=$unit.modifications.object[$i].sort
                                [/value]
                            [/set_variables]
                        [/then]
                    [/if]
                {NEXT i}
                [message]
                    speaker=narrator
                    message=_"What do you want to do?"
                    side_for=$side_number
                    [option]
                        message=_"View the item storage"
                        [show_if]
                            [not]
                                [variable]
                                    name=no_inventory
                                    equals=yes
                                [/variable]
                            [/not]
                        [/show_if]
                        [command]
                            [store_locations]
                                x,y=$x1,$y1
                                variable=standing_on
                            [/store_locations]
                            {VARIABLE number_of_items 0}
                            [if]
                                [variable]
                                    name=turn_number
                                    less_than=3
                                [/variable]
                                [or]
                                    [variable]
                                        name=standing_on.terrain
                                        contains="C"
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=standing_on.terrain
                                        contains="K"
                                    [/variable]
                                [/or]
                                [then]
                                    {VARIABLE_OP number_of_items add $item_storage.ring.length}
                                    {VARIABLE_OP number_of_items add $item_storage.amulet.length}
                                    {VARIABLE_OP number_of_items add $item_storage.cloak.length}
                                    {VARIABLE_OP number_of_items add $item_storage.armour.length}
                                    {VARIABLE_OP number_of_items add $item_storage.helm.length}
                                    {VARIABLE_OP number_of_items add $item_storage.gauntlets.length}
                                    {VARIABLE_OP number_of_items add $item_storage.boots.length}
                                    {VARIABLE_OP number_of_items add $item_storage.sword.length}
                                    {VARIABLE_OP number_of_items add $item_storage.axe.length}
                                    {VARIABLE_OP number_of_items add $item_storage.bow.length}
                                    {VARIABLE_OP number_of_items add $item_storage.staff.length}
                                    {VARIABLE_OP number_of_items add $item_storage.xbow.length}
                                    {VARIABLE_OP number_of_items add $item_storage.dagger.length}
                                    {VARIABLE_OP number_of_items add $item_storage.knife.length}
                                    {VARIABLE_OP number_of_items add $item_storage.mace.length}
                                    {VARIABLE_OP number_of_items add $item_storage.polearm.length}
                                    {VARIABLE_OP number_of_items add $item_storage.claws.length}
                                    {VARIABLE_OP number_of_items add $item_storage.essence.length}
                                    {VARIABLE_OP number_of_items add $item_storage.sling.length}
                                    {VARIABLE_OP number_of_items add $item_storage.thunderstick.length}
                                    {VARIABLE_OP number_of_items add $item_storage.spear.length}
                                [/then]
                            [/if]
                            {VARIABLE_OP number_of_items add $item_storage.limited.length}
                            {VARIABLE_OP number_of_items add $item_storage.potion.length}
                            {VARIABLE repeat yes}
                            [while]
                                [variable]
                                    name=repeat
                                    equals=yes
                                [/variable]
                                [do]
                                    {VARIABLE repeat no}
                                    [if]
                                        [variable]
                                            name=number_of_items
                                            less_than=20
                                        [/variable]
                                        [then]
                                            {VARIABLE inventory_message.speaker narrator}
                                            {VARIABLE inventory_message.message _"What do you want to unstore? <span color='red'> Keep in mind that after the second turn, you can unstore only items that cannot be unequipped, unless the unit is standing on a castle.</span>"}
                                            {VARIABLE inventory_message.side_for $side_number}
                                            {VARIABLE inventory_message.option.message _"Exit"}
                                            {VARIABLE inventory_message.option.command.set_variable.name item_chosen}
                                            {VARIABLE inventory_message.option.command.set_variable.value -1}
                                            {FOREACH item_storage.potion i}
                                                {FOREACH item_list.object k}
                                                    [if]
                                                        [variable]
                                                            name=item_list.object[$k].number
                                                            equals=$item_storage.potion[$i].type
                                                        [/variable]
                                                        [then]
                                                            [set_variables]
                                                                name=inventory_message.option[$inventory_message.option.length]
                                                                mode=replace
                                                                [value]
                                                                    message=_"$item_list.object[$k].name| (potion):
$item_list.object[$k].description"
                                                                    [command]
                                                                        {VARIABLE item_chosen $k}
                                                                        {VARIABLE inventory_location $i}
                                                                        {CLEAR_VARIABLE item_storage.potion[$i]}
                                                                    [/command]
                                                                [/value]
                                                            [/set_variables]
                                                        [/then]
                                                    [/if]
                                                {NEXT k}
                                            {NEXT i}
                                            {FOREACH item_storage.limited i}
                                                {FOREACH item_list.object k}
                                                    [if]
                                                        [variable]
                                                            name=item_list.object[$k].number
                                                            equals=$item_storage.limited[$i].type
                                                        [/variable]
                                                        [then]
                                                            [set_variables]
                                                                name=inventory_message.option[$inventory_message.option.length]
                                                                mode=replace
                                                                [value]
                                                                    message=_"$item_list.object[$k].name| (limited):
$item_list.object[$k].description"
                                                                    [command]
                                                                        {VARIABLE item_chosen $k}
                                                                        {VARIABLE inventory_location $i}
                                                                        {CLEAR_VARIABLE item_storage.limited[$i]}
                                                                    [/command]
                                                                [/value]
                                                            [/set_variables]
                                                        [/then]
                                                    [/if]
                                                {NEXT k}
                                            {NEXT i}
                                            [if]
                                                [variable]
                                                    name=turn_number
                                                    less_than=3
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=standing_on.terrain
                                                        contains="C"
                                                    [/variable]
                                                [/or]
                                                [or]
                                                    [variable]
                                                        name=standing_on.terrain
                                                        contains="K"
                                                    [/variable]
                                                [/or]
                                                [then]
                                                    {VARIABLE count nothing_yet}
                                                    [while]
                                                        [variable]
                                                            name=count
                                                            not_equals="spear"
                                                        [/variable]
                                                        [do]
                                                            {TEXT_COUNT count sling spear}
                                                            {TEXT_COUNT count claws sling}
                                                            {TEXT_COUNT count polearm essence}
                                                            {TEXT_COUNT count essence claws}
                                                            {TEXT_COUNT count thunderstick polearm}
                                                            {TEXT_COUNT count mace thunderstick}
                                                            {TEXT_COUNT count ring mace}
                                                            {TEXT_COUNT count amulet ring}
                                                            {TEXT_COUNT count cloak amulet}
                                                            {TEXT_COUNT count knife cloak}
                                                            {TEXT_COUNT count dagger knife}
                                                            {TEXT_COUNT count xbow dagger}
                                                            {TEXT_COUNT count staff xbow}
                                                            {TEXT_COUNT count bow staff}
                                                            {TEXT_COUNT count axe bow}
                                                            {TEXT_COUNT count sword axe}
                                                            {TEXT_COUNT count boots sword}
                                                            {TEXT_COUNT count gauntlets boots}
                                                            {TEXT_COUNT count helm gauntlets}
                                                            {TEXT_COUNT count armour helm}
                                                            {TEXT_COUNT count nothing_yet armour}
                                                            {VARIABLE variable_in_foreach "item_storage.$count|.length"}
                                                            [set_variable]
                                                                name="foreach"
                                                                to_variable="$variable_in_foreach"
                                                            [/set_variable]
                                                            [while]
                                                                [variable]
                                                                    name="i"
                                                                    less_than="$foreach"
                                                                [/variable]
                                                                [do]
                                                                    [set_variable]
                                                                        name=variable_in_if
                                                                        to_variable="item_storage.$count|[$i].type"
                                                                    [/set_variable]
                                                                    {FOREACH item_list.object k}
                                                                        [if]
                                                                            [variable]
                                                                                name=item_list.object[$k].number
                                                                                equals=$variable_in_if
                                                                            [/variable]
                                                                            [then]
                                                                                [set_variables]
                                                                                    name=inventory_message.option[$inventory_message.option.length]
                                                                                    mode=replace
                                                                                    [value]
                                                                                        message="$item_list.object[$k].name ($item_type_translations.$count|.translation):
$item_list.object[$k].description"
                                                                                        [command]
                                                                                            {VARIABLE item_chosen $k}
                                                                                            {VARIABLE sort_chosen $count}
                                                                                            {VARIABLE inventory_location $i}
                                                                                            {CLEAR_VARIABLE item_storage.$count|[$i]}
                                                                                        [/command]
                                                                                    [/value]
                                                                                [/set_variables]
                                                                            [/then]
                                                                        [/if]
                                                                    {NEXT k}
                                                                    {VARIABLE_OP i add 1}
                                                                [/do]
                                                            [/while]
                                                            {CLEAR_VARIABLE i}
                                                        [/do]
                                                    [/while]
                                                    {CLEAR_VARIABLE count}
                                                [/then]
                                            [/if]
                                            [insert_tag]			# Insert_tag - a tool that is hard to use, but it is really omnipotent.
                                                name=message
                                                variable=inventory_message
                                            [/insert_tag]
                                            {CLEAR_VARIABLE inventory_message}
                                        [/then]
                                        [else]
                                            {CLEAR_VARIABLE item_chosen}
                                            {VARIABLE inventory_message.speaker narrator}
                                            {VARIABLE inventory_message.message _"You have quite a lot of items there, so they are sorted into submenus. What kind of item do you want to unstore? <span color='red'> Keep on mind that after the second turn, you can unstore only items that cannot be unequipped, unless the unit is standing on a castle.</span>"}
                                            {VARIABLE inventory_message.side_for $side_number}
                                            {VARIABLE inventory_message.option.message _"Exit"}
                                            {VARIABLE inventory_message.option.command.set_variable.name item_chosen}
                                            {VARIABLE inventory_message.option.command.set_variable.value -1}
                                            {CREATE_OPTION_FOR_STORAGE_SORT potion}
                                            {CREATE_OPTION_FOR_STORAGE_SORT limited}
                                            [if]
                                                [variable]
                                                    name=turn_number
                                                    less_than=3
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=standing_on.terrain
                                                        contains="C"
                                                    [/variable]
                                                [/or]
                                                [or]
                                                    [variable]
                                                        name=standing_on.terrain
                                                        contains="K"
                                                    [/variable]
                                                [/or]
                                                [then]
                                                    {CREATE_OPTION_FOR_STORAGE_SORT ring}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT amulet}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT cloak}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT armour}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT helm}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT gauntlets}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT boots}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT sword}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT axe}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT bow}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT staff}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT xbow}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT dagger}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT knife}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT mace}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT polearm}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT claws}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT essence}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT sling}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT thunderstick}
                                                    {CREATE_OPTION_FOR_STORAGE_SORT spear}
                                                [/then]
                                            [/if]
                                            [insert_tag]
                                                name=message
                                                variable=inventory_message
                                            [/insert_tag]
                                            {CLEAR_VARIABLE inventory_message}
                                            [if]
                                                [variable]
                                                    name=item_chosen
                                                    equals=-1
                                                [/variable]
                                                [else]
                                                    {VARIABLE inventory_message.speaker narrator}
                                                    {VARIABLE inventory_message.message _"You have chosen to unstore $item_type_translations.$item_sort_chosen|.translation|. Which one do you want to unstore?"}
                                                    {VARIABLE inventory_message.side_for $side_number}
                                                    {VARIABLE inventory_message.option.message _"Back"}
                                                    {VARIABLE inventory_message.option.command.set_variable.name item_chosen}
                                                    {VARIABLE inventory_message.option.command.set_variable.value -1}
                                                    {VARIABLE inventory_message.option.command.set_variable[1].name repeat}
                                                    {VARIABLE inventory_message.option.command.set_variable[1].value yes}
                                                    {VARIABLE variable_in_foreach "item_storage.$item_sort_chosen|.length"}
                                                    [set_variable]
                                                        name="foreach"
                                                        to_variable="$variable_in_foreach"
                                                    [/set_variable]
                                                    [while]
                                                        [variable]
                                                            name="i"
                                                            less_than="$foreach"
                                                        [/variable]
                                                        [do]
                                                            [set_variable]
                                                                name=variable_in_if
                                                                to_variable="item_storage.$item_sort_chosen|[$i].type"
                                                            [/set_variable]
                                                            {FOREACH item_list.object k}
                                                                [if]
                                                                    [variable]
                                                                        name=item_list.object[$k].number
                                                                        equals=$variable_in_if
                                                                    [/variable]
                                                                    [then]
                                                                        [set_variables]
                                                                            name=inventory_message.option[$inventory_message.option.length]
                                                                            mode=replace
                                                                            [value]
                                                                                message="$item_list.object[$k].name:
$item_list.object[$k].description"
                                                                                [command]
                                                                                    {VARIABLE item_chosen $k}
                                                                                    {VARIABLE sort_chosen $item_sort_chosen}
                                                                                    {VARIABLE inventory_location $i}
                                                                                    {CLEAR_VARIABLE item_storage.$item_sort_chosen|[$i]}
                                                                                [/command]
                                                                            [/value]
                                                                        [/set_variables]
                                                                    [/then]
                                                                [/if]
                                                            {NEXT k}
                                                            {VARIABLE_OP i add 1}
                                                        [/do]
                                                    [/while]
                                                    {CLEAR_VARIABLE i}
                                                    [insert_tag]
                                                        name=message
                                                        variable=inventory_message
                                                    [/insert_tag]
                                                    {CLEAR_VARIABLE inventory_message}
                                                [/else]
                                            [/if]
                                            {CLEAR_VARIABLE item_sort_chosen}
                                        [/else]
                                    [/if]
                                    [if]
                                        [variable]
                                            name=item_chosen
                                            equals=-1
                                        [/variable]
                                        [else]
                                            [item]
                                                halo=halo/misc/leadership-flare-1.png:20,halo/misc/leadership-flare-2.png:20,halo/misc/leadership-flare-3.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-6.png:20,halo/misc/leadership-flare-7.png:20,halo/misc/leadership-flare-8.png:20,halo/misc/leadership-flare-9.png:20,halo/misc/leadership-flare-10.png:20,halo/misc/leadership-flare-11.png:20,halo/misc/leadership-flare-12.png:20,halo/misc/leadership-flare-13.png:20,misc/blank-hex.png:1000
                                                x,y=$x1,$y1
                                                image=$item_list.object[$item_chosen].image
                                            [/item]
                                            [if]
                                                [variable]
                                                    name=sort_chosen
                                                    equals=""
                                                [/variable]
                                                [then]
                                                    {VARIABLE sort_chosen $item_list.object[$item_chosen].sort}
                                                [/then]
                                            [/if]
                                            [set_variables]
                                                name=items
                                                mode=append
                                                [value]
                                                    x=$x1
                                                    y=$y1
                                                    type=$item_list.object[$item_chosen].number
                                                    sort=$sort_chosen
                                                [/value]
                                            [/set_variables]
                                            {PLACE_ITEM_EVENT $x1 $y1}
                                            {CLEAR_VARIABLE inventory_location,compatibility}
                                            {VARIABLE_OP items_dropped add 1}
                                        [/else]
                                    [/if]
                                    {VARIABLE to_remove -1}
                                [/do]
                            [/while]
                            {CLEAR_VARIABLE repeat,standing_on}
                        [/command]
                    [/option]
                    [option]
                        message=_"Crafting"
                        [command]
                            {SET_ZEROES obsidians}
                            {SET_ZEROES topazes}
                            {SET_ZEROES opals}
                            {SET_ZEROES pearls}
                            {SET_ZEROES diamonds}
                            {SET_ZEROES rubies}
                            {SET_ZEROES emeralds}
                            {SET_ZEROES amethysts}
                            {SET_ZEROES sapphires}
                            {SET_ZEROES black_pearls}
                            [message]
                                speaker=narrator
                                side_for=$side_number
                                message=_"What do you want to craft?
Crafted item types are divided into weapons and armour. Weapons can be any weapon type, armour can be a body armour, a helm, a pair of gloves or a pair of boots (helms, gloves and boots receive only 33% of the resistance).

You have:
$obsidians obsidians
$topazes topazes
$opals opals
$pearls pearls
$diamonds diamonds
$rubies rubies
$emeralds emeralds
$amethysts amethysts
$sapphires sapphires
$black_pearls black pearls"
                                [option]
                                    message=_"Craft a weapon"
                                    [command]
                                        {VARIABLE crafted_type_chosen weaponword}
                                    [/command]
                                [/option]
                                [option]
                                    message=_"Craft an armour"
                                    [command]
                                        {VARIABLE crafted_type_chosen armourword}
                                    [/command]
                                [/option]
                                [option]
                                    message=_"Transmute gems"
                                    [command]
                                        {VARIABLE skip no}
                                        [while]
                                            [variable]
                                                name=skip
                                                equals=no
                                            [/variable]
                                            [do]
                                                [message]
                                                    speaker=narrator
                                                    side_for=$side_number
                                                    message= _ "With a mighty blow of a runesmith's hammer, magical gems can be pressed so hard that their identity vanishes and a completely new precious gem appears. Nobody can foresee what will appear, but it has the power to transform a few pieces of common obsidian even into a legendary black pearl.

Do you want to try this procedure on something?"
                                                    [option]
                                                        message= _ "Use 4 obsidians to get a random gem (you have $obsidians of them)"
                                                        [show_if]
                                                            [variable]
                                                                name=obsidians
                                                                greater_than_equal_to=4
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE_OP obsidians sub 4}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message= _ "Use 2 topazes to get a random gem (you have $topazes of them)"
                                                        [show_if]
                                                            [variable]
                                                                name=topazes
                                                                greater_than_equal_to=2
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE_OP topazes sub 2}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message= _ "Use 1 opal to get a random gem (you have $opals of them)"
                                                        [show_if]
                                                            [variable]
                                                                name=opals
                                                                greater_than_equal_to=1
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE_OP opals sub 1}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message= _ "Use 1 pearl to get a random gem (you have $pearls of them)"
                                                        [show_if]
                                                            [variable]
                                                                name=pearls
                                                                greater_than_equal_to=1
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE_OP pearls sub 1}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message= _ "Better let such experiments be"
                                                        [command]
                                                            {VARIABLE skip yes}
                                                        [/command]
                                                    [/option]
                                                [/message]
                                                [if]
                                                    [variable]
                                                        name=skip
                                                        equals=no
                                                    [/variable]
                                                    [then]
                                                        {VARIABLE_OP item_type rand (521,521,521,521,521,521,521,521,521,521,522,522,522,522,522,522,523,523,523,523,523,524,524,524,524,524,524)}
                                                        [if]
                                                            [variable]
                                                                name=item_type
                                                                equals=524
                                                            [/variable]
                                                            [then]
#ifdef LOTI_LOW_DROPS
                                                                {VARIABLE_OP item_type rand (524,524,524,524,524,524,524,524,524,525,525,525,525,526,526,527,527)}
#else
                                                                {VARIABLE_OP item_type rand (524,524,524,524,524,524,524,524,524,525,525,525,525,525,525,526,526,526,526,527,527,527,527,527,527)}
#endif
                                                                [if]
                                                                    [variable]
                                                                        name=item_type
                                                                        equals=527
                                                                    [/variable]
                                                                    [then]
                                                                        {VARIABLE_OP item_type rand (530,530,529,529,529,528,528,528,528,528,527,527,527,527,527,527,527,527)}
                                                                    [/then]
                                                                [/if]
                                                            [/then]
                                                        [/if]
                                                        {FOREACH item_list.object cv}
                                                            [if]
                                                                [variable]
                                                                    name=item_list.object[$cv].number
                                                                    equals=$item_type
                                                                [/variable]
                                                                [then]
                                                                    {VARIABLE gem_number $cv}
                                                                [/then]
                                                            [/if]
                                                        {NEXT cv}
                                                        [insert_tag]
                                                            name=object
                                                            variable=item_list.object[$gem_number]
                                                        [/insert_tag]
                                                        [switch]
                                                            variable=item_list.object[$gem_number].number
                                                            {GEM_CASE 521 obsidians}
                                                            {GEM_CASE 522 topazes}
                                                            {GEM_CASE 523 opals}
                                                            {GEM_CASE 524 pearls}
                                                            {GEM_CASE 525 diamonds}
                                                            {GEM_CASE 526 rubies}
                                                            {GEM_CASE 527 emeralds}
                                                            {GEM_CASE 528 amethysts}
                                                            {GEM_CASE 529 sapphires}
                                                            {GEM_CASE 530 black_pearls}
                                                        [/switch]
                                                        {CLEAR_VARIABLE gem_number}
                                                    [/then]
                                                [/if]
                                            [/do]
                                        [/while]
                                        {CLEAR_VARIABLE skip}
                                    [/command]
                                [/option]
                                [option]
                                    message=_"Nothing"
                                    [command]
                                    [/command]
                                [/option]
                            [/message]
                            {VARIABLE inventory_message.speaker narrator}
                            {VARIABLE inventory_message.message _"Choose the item to craft. Materials you lack are shown red."}
                            {VARIABLE inventory_message.side_for $side_number}
                            {VARIABLE inventory_message.option.message _"Exit"}
                            {VARIABLE inventory_message.option.command.set_variable.name item_chosen}
                            {VARIABLE inventory_message.option.command.set_variable.value -1}
                            {VARIABLE k 1}
                            {FOREACH item_list.object i}
                                {CLEAR_VARIABLE cannot_make}
                                {LIST_MATERIAL_REQUIREMENTS obsidians _"obsidians"}
                                {LIST_MATERIAL_REQUIREMENTS topazes _"topazes"}
                                {LIST_MATERIAL_REQUIREMENTS opals _"opals"}
                                {LIST_MATERIAL_REQUIREMENTS pearls _"pearls"}
                                {LIST_MATERIAL_REQUIREMENTS diamonds _"diamonds"}
                                {LIST_MATERIAL_REQUIREMENTS rubies _"rubies"}
                                {LIST_MATERIAL_REQUIREMENTS emeralds _"emeralds"}
                                {LIST_MATERIAL_REQUIREMENTS amethysts _"amethysts"}
                                {LIST_MATERIAL_REQUIREMENTS sapphires _"sapphires"}
                                {LIST_MATERIAL_REQUIREMENTS black_pearls _"black pearls"}
                                [set_variable]
                                    name=materials_needed
                                    [join]
                                        variable=gem_list
                                        key=message
                                        separator=_", "
                                        remove_empty=yes
                                    [/join]
                                [/set_variable]
                                {CLEAR_VARIABLE gem_list}
                                [if]
                                    [variable]
                                        name=item_list.object[$i].sort
                                        equals=$crafted_type_chosen
                                    [/variable]
                                    [then]
                                        [if]
                                            [variable]
                                                name=cannot_make
                                                equals=yes
                                            [/variable]
                                            [then]
                                                {VARIABLE "inventory_message.option[$k].message" _"<span color='red'>$item_list.object[$i].name|:</span>
($materials_needed|)
$item_list.object[$i].description"}
                                            [/then]
                                            [else]
                                                {VARIABLE "inventory_message.option[$k].message" _"$item_list.object[$i].name|:
($materials_needed|)
$item_list.object[$i].description"}
                                            [/else]
                                        [/if]
                                        {CLEAR_VARIABLE cannot_make}
                                        {VARIABLE "inventory_message.option[$k].command.set_variable.name" item_chosen}
                                        {VARIABLE "inventory_message.option[$k].command.set_variable.value" $i}
                                        {VARIABLE_OP k add 1}
                                    [/then]
                                [/if]
                            {NEXT i}
                            {CLEAR_VARIABLE k}
                            [if]
                                [variable]
                                    name=crafted_type_chosen
                                    equals=armourword
                                [/variable]
                                [or]
                                    [variable]
                                        name=crafted_type_chosen
                                        equals=weaponword
                                    [/variable]
                                [/or]
                                [then]
                                    [insert_tag]
                                        name=message
                                        variable=inventory_message
                                    [/insert_tag]
                                [/then]
                                [else]
                                    {VARIABLE item_chosen -1}
                                [/else]
                            [/if]
                            {CLEAR_VARIABLE inventory_message}
                            [if]
                                [variable]
                                    name=item_chosen
                                    equals=-1
                                [/variable]
                                [else]
                                    [message]
                                        speaker=narrator
                                        side_for=$side_number
                                        message=_"You have chosen to make $item_list.object[$item_chosen].name|. Its effects are:
$item_list.object[$item_chosen].description

Material needed:
$item_list.object[$item_chosen].obsidians obsidians. You have $obsidians obsidians.
$item_list.object[$item_chosen].topazes topazes. You have $topazes topazes.
$item_list.object[$item_chosen].opals opals. You have $opals opals.
$item_list.object[$item_chosen].pearls pearls. You have $pearls pearls.
$item_list.object[$item_chosen].diamonds diamonds. You have $diamonds diamonds.
$item_list.object[$item_chosen].rubies rubies. You have $rubies rubies.
$item_list.object[$item_chosen].emeralds emeralds. You have $emeralds emeralds.
$item_list.object[$item_chosen].amethysts amethysts. You have $amethysts amethysts.
$item_list.object[$item_chosen].sapphires sapphires. You have $sapphires sapphires.
$item_list.object[$item_chosen].black_pearls black pearls. You have $black_pearls black pearls.

Do you want to create this item?"
                                        [option]
                                            message=_"Yes"
                                            [show_if]
                                                [variable]
                                                    name=item_list.object[$item_chosen].obsidians
                                                    less_than_equal_to=$obsidians
                                                [/variable]
                                                {CHECK_FOR topazes}
                                                {CHECK_FOR opals}
                                                {CHECK_FOR pearls}
                                                {CHECK_FOR diamonds}
                                                {CHECK_FOR rubies}
                                                {CHECK_FOR emeralds}
                                                {CHECK_FOR amethysts}
                                                {CHECK_FOR sapphires}
                                                {CHECK_FOR black_pearls}
                                            [/show_if]
                                            [command]
                                                [message]
                                                    speaker=narrator
                                                    message=_"What item type shall the item be?"
                                                    [option]
                                                        message=_"Armour"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=armourword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen armour}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Helm (only a third of the resistance promised!)"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=armourword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen helm}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Boots (only a third of the resistance promised!)"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=armourword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen boots}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Gauntlets (only a third of the resistance promised!)"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=armourword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen gauntlets}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Sword (or rapier, sabre, greatsword, short sword, ...)"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=weaponword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen sword}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Bow (or longbow, short bow, ...)"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=weaponword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen bow}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Axe (or battle axe, pickaxe,...)"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=weaponword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen axe}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Staff"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=weaponword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen staff}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Mace (or hammer, club, mornig star, scourge, flail, ...)"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=weaponword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen mace}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Crossbow (or slurbow)"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=weaponword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen xbow}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Dagger"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=weaponword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen dagger}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Knife (throwing)"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=weaponword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen knife}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Spear (or javelin, lance, pike, trident)"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=weaponword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen spear}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Polearm (halberd, scythe, ...)"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=weaponword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen polearm}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Sling (or bolas or net)"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=weaponword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen sling}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Thunderstick (or dragonstaff)"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=weaponword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen thunderstick}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Metal claws"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=weaponword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen claws}
                                                        [/command]
                                                    [/option]
                                                    [option]
                                                        message=_"Otherworldly essence (for touch attacks, baneblade, ...)"
                                                        [show_if]
                                                            [variable]
                                                                name=crafted_type_chosen
                                                                equals=weaponword
                                                            [/variable]
                                                        [/show_if]
                                                        [command]
                                                            {VARIABLE crafted_type_chosen essence}
                                                        [/command]
                                                    [/option]
                                                    #													[option]	#No drakes in the campaign, though
                                                    #														message="Exotic blade"
                                                    #														[show_if]
                                                    #															[variable]
                                                    #																name=crafted_type_chosen
                                                    #																equals=weaponword
                                                    #															[/variable]
                                                    #														[/show_if]
                                                    #														[command]
                                                    #															{VARIABLE crafted_type_chosen exotic}
                                                    #														[/command]
                                                    #													[/option]
                                                    [option]
                                                        message=_"No, I never wanted to create anything, I just misclicked..."
                                                        [command]
                                                        [/command]
                                                    [/option]
                                                [/message]
                                                [if]
                                                    [variable]
                                                        name=crafted_type_chosen
                                                        equals=weaponword
                                                    [/variable]
                                                    [or]
                                                        [variable]
                                                            name=crafted_type_chosen
                                                            equals=armourword
                                                        [/variable]
                                                    [/or]
                                                    [else]
                                                        {VARIABLE_OP obsidians sub $item_list.object[$item_chosen].obsidians}
                                                        {VARIABLE_OP topazes sub $item_list.object[$item_chosen].topazes}
                                                        {VARIABLE_OP opals sub $item_list.object[$item_chosen].opals}
                                                        {VARIABLE_OP pearls sub $item_list.object[$item_chosen].pearls}
                                                        {VARIABLE_OP diamonds sub $item_list.object[$item_chosen].diamonds}
                                                        {VARIABLE_OP rubies sub $item_list.object[$item_chosen].rubies}
                                                        {VARIABLE_OP emeralds sub $item_list.object[$item_chosen].emeralds}
                                                        {VARIABLE_OP amethysts sub $item_list.object[$item_chosen].amethysts}
                                                        {VARIABLE_OP sapphires sub $item_list.object[$item_chosen].sapphires}
                                                        {VARIABLE_OP black_pearls sub $item_list.object[$item_chosen].black_pearls}
                                                        [item]
                                                            x,y=$x1,$y1
                                                            image=items/leather-pack.png
                                                            halo=halo/misc/leadership-flare-1.png:20,halo/misc/leadership-flare-2.png:20,halo/misc/leadership-flare-3.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-6.png:20,halo/misc/leadership-flare-7.png:20,halo/misc/leadership-flare-8.png:20,halo/misc/leadership-flare-9.png:20,halo/misc/leadership-flare-10.png:20,halo/misc/leadership-flare-11.png:20,halo/misc/leadership-flare-12.png:20,halo/misc/leadership-flare-13.png:20,misc/blank-hex.png:1000
                                                        [/item]
                                                        [set_variables]
                                                            name=items
                                                            mode=append
                                                            [value]
                                                                x=$x1
                                                                y=$y1
                                                                type=$item_list.object[$item_chosen].number
                                                                sort=$crafted_type_chosen
                                                            [/value]
                                                        [/set_variables]
                                                        {PLACE_ITEM_EVENT $x1 $y1}
                                                        {VARIABLE_OP items_dropped add 1}
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            message=_"No"
                                            [command]
                                            [/command]
                                        [/option]
                                    [/message]
                                [/else]
                            [/if]
                            {CLEAR_VARIABLE crafted_type_chosen,materials_needed}
                            {VARIABLE to_remove -1}
                        [/command]
                    [/option]
                    [option]
                        message=_"Unit information"
                        [command]
                            [fire_event]
                                name=unit information
                                [primary_unit]
                                    find_in=unit
                                [/primary_unit]
                            [/fire_event]
                            {VARIABLE to_remove -1}
                        [/command]
                    [/option]
                    [option]
                        message=_"Disable attacks for retaliation"
                        [command]
                            [set_variables]
                                name=disallowing_message
                                mode=replace
                                [value]
                                    speaker=narrator
                                    message="Which one do you want to disable?"
                                [/value]
                            [/set_variables]
                            {FOREACH unit.attack i}
                                [if]
                                    [variable]
                                        name=unit.attack[$i].defense_weight
                                        equals=0
                                    [/variable]
                                    [else]
                                        [set_variables]
                                            name=disallowing_message.option[$disallowing_message.option.length]
                                            mode=replace
                                            [value]
                                                message="$unit.attack[$i].description"
                                                [command]
                                                    {VARIABLE order $i}
                                                    {VARIABLE name $unit.attack[$i].name}
                                                [/command]
                                            [/value]
                                        [/set_variables]
                                    [/else]
                                [/if]
                            {NEXT i}
                            [insert_tag]
                                name=message
                                variable=disallowing_message
                            [/insert_tag]
                            [set_variables]
                                name=unit.variables.disabled_defences[$unit.variables.disabled_defences.length]
                                mode=replace
                                [value]
                                    order=$order
                                    name=$name
                                [/value]
                            [/set_variables]
                            {CLEAR_VARIABLE disallowing_message,order,name}
                            [unstore_unit]
                                variable=unit
                                find_vacant=no
                            [/unstore_unit]
                            {UPDATE_STATS}
                            {VARIABLE to_remove -1}
                        [/command]
                    [/option]
                    [option]
                        message=_"Re-enable attacks for retaliation"
                        [show_if]
                            [variable]
                                name=unit.variables.disabled_defences.length
                                greater_than=0
                            [/variable]
                        [/show_if]
                        [command]
                            [set_variables]
                                name=allowing_message
                                mode=replace
                                [value]
                                    speaker=narrator
                                    message="Which one do you want to re-enable?"
                                [/value]
                            [/set_variables]
                            {FOREACH unit.variables.disabled_defences i}
                                [set_variables]
                                    name=allowing_message.option[$allowing_message.option.length]
                                    mode=replace
                                    [value]
                                        message="$unit.attack[$unit.variables.disabled_defences[$i].order].description (position: $(1+$unit.variables.disabled_defences[$i].order))"
                                        [command]
                                            {VARIABLE order $i}
                                        [/command]
                                    [/value]
                                [/set_variables]
                            {NEXT i}
                            [insert_tag]
                                name=message
                                variable=allowing_message
                            [/insert_tag]
                            {CLEAR_VARIABLE unit.variables.disabled_defences[$order]}
                            {CLEAR_VARIABLE allowing_message,order}
                            [unstore_unit]
                                variable=unit
                                find_vacant=no
                            [/unstore_unit]
                            {UPDATE_STATS}
                            {VARIABLE to_remove -1}
                        [/command]
                    [/option]
                    [option]
                        message=_"Unequip all items and put them into the item storage"
                        [show_if]
                            [not]
                                [variable]
                                    name=no_inventory
                                    equals=yes
                                [/variable]
                            [/not]
                        [/show_if]
                        [command]
                            [store_unit]
                                [filter]
                                    id=$unit.id
                                [/filter]
                                variable=stripped
                                kill=yes
                            [/store_unit]
                            [fire_event]
                                name=unequip all items
                                [primary_unit]
                                    id=$unit.id
                                [/primary_unit]
                            [/fire_event]
                            {UPDATE_STATS}
                            {VARIABLE to_remove -1}
                        [/command]
                    [/option]
                    [option]
                        message=_"Show items on units on the recall list"
                        [command]
                            [fire_event]
                                name=recall list items
                            [/fire_event]
                            {VARIABLE to_remove -1}
                        [/command]
                    [/option]
                    {REMOVE_OPTION 0}
                    {REMOVE_OPTION 1}
                    {REMOVE_OPTION 2}
                    {REMOVE_OPTION 3}
                    {REMOVE_OPTION 4}
                    {REMOVE_OPTION 5}
                    {REMOVE_OPTION 6}
                    {REMOVE_OPTION 7}
                    {REMOVE_OPTION 8}
                    {REMOVE_OPTION 9}
                    {REMOVE_OPTION 10}
                    {REMOVE_OPTION 11}
                    [option]
                        message=_"Pick up items on the ground"
                        [command]
                            [fire_event]
                                name=item_pick
                                [primary_unit]
                                    find_in=unit
                                [/primary_unit]
                            [/fire_event]
                            {VARIABLE to_remove -1}
                        [/command]
                    [/option]
                    [option]
                        message=_"Nothing."
                        [command]
                            {VARIABLE to_remove -1}
                        [/command]
                    [/option]
                [/message]
                {CLEAR_VARIABLE drops}
                [if]
                    [variable]
                        name=to_remove
                        equals=-1
                    [/variable]
                    [else]
                        {VARIABLE iw 0}
                        [while]
                            [variable]
                                name=iw
                                less_than=$unit.modifications.object.length
                            [/variable]
                            [do]
                                [if]
                                    [variable]
                                        name=unit.modifications.object[$iw].number
                                        equals=$to_remove
                                    [/variable]
                                    [and]
                                        [variable]
                                            name=unit.modifications.object[$iw].sort
                                            equals=$to_remove_sort
                                        [/variable]
                                    [/and]
                                    [then]
                                        {VARIABLE item_removal_sort $unit.modifications.object[$iw].sort}
                                        [message]
                                            speaker=narrator
                                            message=_"Where should that item go?"
                                            side_for=$side_number
                                            [option]
                                                message=_"Into the item storage."
                                                [show_if]
                                                    [not]
                                                        [variable]
                                                            name=no_inventory
                                                            equals=yes
                                                        [/variable]
                                                    [/not]
                                                [/show_if]
                                                [command]
                                                    [while]
                                                        [variable]
                                                            name=k
                                                            less_than=$item_list.object.length
                                                        [/variable]
                                                        [do]
                                                            [if]
                                                                [variable]
                                                                    name=item_list.object[$k].number
                                                                    equals=$to_remove
                                                                [/variable]
                                                                [then]
                                                                    {VARIABLE item_number $k}
                                                                [/then]
                                                            [/if]
                                                            [set_variable]
                                                                name=k
                                                                add=1
                                                            [/set_variable]
                                                        [/do]
                                                    [/while]
                                                    {CLEAR_VARIABLE k}
                                                    [set_variable]
                                                        name=length
                                                        to_variable=item_storage.$item_removal_sort|.length
                                                    [/set_variable]
                                                    [set_variables]
                                                        name=item_storage.$item_removal_sort|[$length]
                                                        mode=replace
                                                        [value]
                                                            type=$item_list.object[$item_number].number
                                                        [/value]
                                                    [/set_variables]
                                                [/command]
                                            [/option]
                                            [option]
                                                message=_"Into a forge to get a random gem."
                                                [command]
                                                    [remove_item]
                                                        x,y=$x1,$y1
                                                        image=$item_list.object[$item_number].image
                                                    [/remove_item]
                                                    {VARIABLE_OP item_type rand (521,521,521,521,521,521,521,521,521,521,522,522,522,522,522,522,523,523,523,523,523,524,524,524,524,524,524)}
                                                    [if]
                                                        [variable]
                                                            name=item_type
                                                            equals=524
                                                        [/variable]
                                                        [then]
#ifdef LOTI_LOW_DROPS
                                                            {VARIABLE_OP item_type rand (524,524,524,524,524,524,524,524,524,525,525,525,525,526,526,527,527)}
#else
                                                            {VARIABLE_OP item_type rand (524,524,524,524,524,524,524,524,524,525,525,525,525,525,525,526,526,526,526,527,527,527,527,527,527)}
#endif
                                                            [if]
                                                                [variable]
                                                                    name=item_type
                                                                    equals=527
                                                                [/variable]
                                                                [then]
                                                                    {VARIABLE_OP item_type rand (530,530,529,529,529,528,528,528,528,528,527,527,527,527,527,527,527,527)}
                                                                [/then]
                                                            [/if]
                                                        [/then]
                                                    [/if]
                                                    {FOREACH item_list.object cv}
                                                        [if]
                                                            [variable]
                                                                name=item_list.object[$cv].number
                                                                equals=$item_type
                                                            [/variable]
                                                            [then]
                                                                {VARIABLE gem_number $cv}
                                                            [/then]
                                                        [/if]
                                                    {NEXT cv}
                                                    [insert_tag]
                                                        name=object
                                                        variable=item_list.object[$gem_number]
                                                    [/insert_tag]
                                                    [switch]
                                                        variable=item_list.object[$gem_number].number
                                                        {GEM_CASE 521 obsidians}
                                                        {GEM_CASE 522 topazes}
                                                        {GEM_CASE 523 opals}
                                                        {GEM_CASE 524 pearls}
                                                        {GEM_CASE 525 diamonds}
                                                        {GEM_CASE 526 rubies}
                                                        {GEM_CASE 527 emeralds}
                                                        {GEM_CASE 528 amethysts}
                                                        {GEM_CASE 529 sapphires}
                                                        {GEM_CASE 530 black_pearls}
                                                    [/switch]
                                                    {CLEAR_VARIABLE gem_number}
                                                [/command]
                                            [/option]
                                            [option]
                                                message=_"On the ground."
                                                [command]
                                                    [item]
                                                        x,y=$x1,$y1
                                                        image=$unit.modifications.object[$iw].image
                                                        halo=halo/misc/leadership-flare-1.png:20,halo/misc/leadership-flare-2.png:20,halo/misc/leadership-flare-3.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-6.png:20,halo/misc/leadership-flare-7.png:20,halo/misc/leadership-flare-8.png:20,halo/misc/leadership-flare-9.png:20,halo/misc/leadership-flare-10.png:20,halo/misc/leadership-flare-11.png:20,halo/misc/leadership-flare-12.png:20,halo/misc/leadership-flare-13.png:20,misc/blank-hex.png:1000
                                                    [/item]
                                                    [set_variables]
                                                        name=items
                                                        mode=append
                                                        [value]
                                                            x=$x1
                                                            y=$y1
                                                            type=$to_remove
                                                            sort=$item_removal_sort
                                                        [/value]
                                                    [/set_variables]
                                                [/command]
                                            [/option]
                                        [/message]
                                        [set_variables]
                                            name=advanced.resistance
                                            mode=replace
                                            to_variable=advanced.variables.resistance
                                        [/set_variables]
                                        [store_unit]
                                            [filter]
                                                x,y=$x1,$y1
                                            [/filter]
                                            variable=gifted
                                            kill=no
                                        [/store_unit]
                                        {VARIABLE i 0}
                                        [while]
                                            [variable]
                                                name=i
                                                less_than=$gifted.modifications.object.length
                                            [/variable]
                                            [do]
                                                [if]
                                                    [variable]
                                                        name=gifted.modifications.object[$i].sort
                                                        equals=$item_removal_sort
                                                    [/variable]
                                                    [then]
                                                        {VARIABLE_OP items_dropped add 1}
                                                        [set_variables]
                                                            name=items_to_add
                                                            mode=append
                                                            [value]
                                                                x=$x1
                                                                y=$y1
                                                                type=$gifted.modifications.object[$i].number
                                                                sort=$item_removal_sort
                                                            [/value]
                                                        [/set_variables]
                                                        {PLACE_ITEM_EVENT $x1 $y1}
                                                        {CLEAR_VARIABLE gifted.modifications.object[$i]}
                                                    [/then]
                                                    [else]
                                                        [set_variable]
                                                            name=i
                                                            add=1
                                                        [/set_variable]
                                                    [/else]
                                                [/if]
                                            [/do]
                                        [/while]
                                        {CLEAR_VARIABLE i}
                                        [unstore_unit]
                                            variable=gifted
                                            find_vacant=no
                                        [/unstore_unit]
                                        {CLEAR_VARIABLE gifted}
                                        {CLEAR_VARIABLE items_to_add}
                                        {UPDATE_STATS}
                                    [/then]
                                [/if]
                                [set_variable]
                                    name=iw
                                    add=1
                                [/set_variable]
                            [/do]
                        [/while]
                        {CLEAR_VARIABLE i}
                    [/else]
                [/if]
                {CLEAR_VARIABLE unit}
                {CLEAR_VARIABLE to_remove}
                {CLEAR_VARIABLE iw}
                [if]
                    [variable]
                        name=item_chosen
                        greater_than=-1
                    [/variable]
                    [then]
                        [fire_event]
                            name=item_pick
                            [primary_unit]
                                x,y=$x1,$y1
                            [/primary_unit]
                        [/fire_event]
                    [/then]
                [/if]
            [/command]
        [/set_menu_item]
        [set_menu_item]
            id=8respec
            description=_"Alter advancement"
            [show_if]
                [have_unit]
                    x,y=$x1,$y1
                    side=$side_number
                    [filter_wml]
                        [variables]
                            achieved_amla=yes
                        [/variables]
                    [/filter_wml]
                    [not]
                        [filter_wml]
                            [variables]
                                cant_pick=yes
                            [/variables]
                        [/filter_wml]
                    [/not]
                [/have_unit]
            [/show_if]
            [command]
                [store_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    variable=worked_on
                    kill=no
                [/store_unit]
                [store_unit_type]
                    type=Advancing $worked_on.type
                    variable=unit_style
                [/store_unit_type]
                {VARIABLE last_advancement_index unused}
#ifver WESNOTH_VERSION >= 1.13.2
                {VARIABLE advancement_number $worked_on.modifications.advancement.length}
#else
                {VARIABLE advancement_number $worked_on.modifications.advance.length}
#endif
                {VARIABLE_OP advancement_number sub 1}

                [while]
                    [variable]
                        name=advancement_number
                        greater_than_equal_to=0
                    [/variable]
                    [and]
                        [variable]
                            name=last_advancement_index
                            equals=unused
                        [/variable]
                    [/and]
                    [do]
                        {FOREACH unit_style.advancement i}
                            [if]
                                [variable]
                                    name=unit_style.advancement[$i].id
#ifver WESNOTH_VERSION >= 1.13.2
                                    equals=$worked_on.modifications.advancement[$advancement_number].id
#else
                                    equals=$worked_on.modifications.advance[$advancement_number].id
#endif
                                [/variable]
                                [then]
                                    {VARIABLE last_advancement_index $advancement_number}

                                [/then]
                            [/if]
                        {NEXT i}
                        {VARIABLE_OP advancement_number sub 1}
                    [/do]
                [/while]
                {CLEAR_VARIABLE advancement_number,unit_style}
                [if]
                    [variable]
                        name=last_advancement_index
                        equals=unused
                    [/variable]
                    [then]
                        {NARRATOR_MESSAGE _"Last advancement not found."}
                    [/then]
                    [else]
                        [message]
                            speaker=narrator
#ifver WESNOTH_VERSION >= 1.13.2
                            message= _ "The last advancement this unit has taken is described as:
<b>$worked_on.modifications.advancement[$last_advancement_index].description </b>
Do you want to change it for something else?"
#else
                            message= _ "The last advancement this unit has taken is described as:
<b>$worked_on.modifications.advance[$last_advancement_index].description </b>
Do you want to change it for something else?"
#endif
                            side_for=$side_number
#ifver WESNOTH_VERSION >= 1.13.2
                            image=$worked_on.modifications.advancement[$last_advancement_index].image
#else
                            image=$worked_on.modifications.advance[$last_advancement_index].image
#endif
                            [option]
                                message=_"Yes"
                                [command]
#ifver WESNOTH_VERSION >= 1.13.2
                                    {CLEAR_VARIABLE worked_on.modifications.advancement[$last_advancement_index]}
#else
                                    {CLEAR_VARIABLE worked_on.modifications.advance[$last_advancement_index]}
#endif
                                    {CLEAR_VARIABLE worked_on.variables.achieved_amla}
                                    {VARIABLE experience_to_give $worked_on.experience}
                                    {VARIABLE_OP experience_to_give add $worked_on.max_experience}
                                    [unit]
                                        side=$worked_on.side
                                        x=$worked_on.x
                                        y=$worked_on.y
                                        experience=$experience_to_give
                                        max_experience=$worked_on.max_experience
                                        canrecruit=$worked_on.canrecruit
                                        variation=$worked_on.variation
                                        type=Advancing $worked_on.type
                                        id=$worked_on.id
                                        hitpoints=$worked_on.hitpoints
                                        gender=$worked_on.gender
                                        name=$worked_on.name
                                        facing=$worked_on.facing
                                        extra_recruit=$worked_on.extra_recruit
                                        underlying_id=$worked_on.underlying_id
                                        unrenamable=$worked_on.unrenamable
                                        overlays=$worked_on.overlays
                                        animate=no
                                        [insert_tag]
                                            name=status
                                            variable=worked_on.status
                                        [/insert_tag]
                                        [insert_tag]
                                            name=modifications
                                            variable=worked_on.modifications
                                        [/insert_tag]
                                        [insert_tag]
                                            name=variables
                                            variable=worked_on.variables
                                        [/insert_tag]
                                        to_variable=advancing_store
                                    [/unit]
                                    [unstore_unit]
                                        variable=advancing_store
                                        find_vacant=no
                                    [/unstore_unit]
                                    [store_unit]
                                        [filter]
                                            x,y=$x1,$y1
                                        [/filter]
                                        variable=advanced2
                                        kill=yes
                                    [/store_unit]
                                    [unit]
                                        side=$worked_on.side
                                        x=$worked_on.x
                                        y=$worked_on.y
                                        experience=$advanced2.experience
                                        canrecruit=$worked_on.canrecruit
                                        variation=$worked_on.variation
                                        type=$worked_on.type
                                        id=$worked_on.id
                                        moves=$worked_on.moves
                                        hitpoints=$worked_on.hitpoints
                                        gender=$worked_on.gender
                                        name=$worked_on.name
                                        facing=$worked_on.facing
                                        extra_recruit=$worked_on.extra_recruit
                                        underlying_id=$worked_on.underlying_id
                                        unrenamable=$worked_on.unrenamable
                                        animate=no
                                        attacks_left=$worked_on.attacks_left
                                        overlays=$worked_on.overlays
                                        [insert_tag]
                                            name=status
                                            variable=worked_on.status
                                        [/insert_tag]
                                        [insert_tag]
                                            name=modifications
                                            variable=advanced2.modifications
                                        [/insert_tag]
                                        [insert_tag]
                                            name=variables
                                            variable=worked_on.variables
                                        [/insert_tag]
                                        to_variable=advanced2
                                    [/unit]
                                    [fire_event]
                                        name=update_stats
                                        [primary_unit]
                                            id=$advanced2.id
                                        [/primary_unit]
                                    [/fire_event]
                                    {CLEAR_VARIABLE experience_to_give}
                                [/command]
                            [/option]
                            [option]
                                message=_"No"
                                [command]
                                [/command]
                            [/option]
                        [/message]
                    [/else]
                [/if]
                {CLEAR_VARIABLE worked_on,last_advancement_index}
            [/command]
        [/set_menu_item]
        [set_menu_item]
            id=9help
            description=_"Campaign help"
            [command]
                [message]
                    speaker=narrator
                    message=_"What do you need help with?"
                    side_for=$side_number
                    image="wesnoth-icon.png"
                    [option]
                        message=_"Interface"
                        [command]
                            [fire_event]
                                name=help_interface
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        message=_"Walkthroughs"
                        [command]
                            [fire_event]
                                name=help_walkthroughs_check
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        message=_"Frequently Asked Questions"
                        [command]
                            [fire_event]
                                name=help_faq
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        message=_"Exit"
                        [command]
                        [/command]
                    [/option]
                [/message]
            [/command]
        [/set_menu_item]
#ifver WESNOTH_VERSION >= 1.11.7
        [set_menu_item]
            use_hotkey=only
            id=xx_unit_info
            description=_"Unit information"
            [default_hotkey]
                key=c
                shift=yes
            [/default_hotkey]
            [show_if]
                [have_unit]
                    x,y=$x1,$y1
                    side=$side_number
                [/have_unit]
                [not]
                    [filter_wml]
                        [variables]
                            cant_pick=yes
                        [/variables]
                    [/filter_wml]
                [/not]
            [/show_if]
            [command]
                [fire_event]
                    name=unit information
                    [primary_unit]
                        find_in=unit
                    [/primary_unit]
                [/fire_event]
            [/command]
        [/set_menu_item]
#endif
        {VARIABLE items_dropped 0}
    [/event]

    #The following is an old code written by me (Dugi), it's quite gritty but gets the thing done, and in pure WML. It has been rewritten by fdsfsfdsjkljkl, it can be seen bellow.
    #I am leaving it here for didactic purposes
    #    [event]
    #        name=unit information
    #        first_time_only=no
    #	{VARIABLE desc_prefix ""}
    #	[if]
    #		[variable]
    #			name=unit.variables.max_devour_count
    #			greater_than=0
    #		[/variable]
    #		[then]
    #			[set_variable]
    #				name=desc_prefix
    #				value=_"$desc_prefix
#<b>Soul eater score:</b> $unit.variables.devour_count|/$unit.variables.max_devour_count
#"
    #			[/set_variable]
    #		[/then]
    #	[/if]
    #	[if]
    #		[variable]
    #			name=unit.variables.max_redeem_count
    #			greater_than=0
    #		[/variable]
    #		[then]
    #			[set_variable]
    #				name=desc_prefix
    #				value=_"$desc_prefix
#<b>Redeem score:</b> $unit.variables.redeem_count|/$unit.variables.max_redeem_count
#"
    #			[/set_variable]
    #		[/then]
    #	[/if]
    #	[if]
    #		[variable]
    #			name=unit.variables.max_lesser_redeem_count
    #			greater_than=0
    #		[/variable]
    #		[then]
    #			[set_variable]
    #				name=desc_prefix
    #				value=_"$desc_prefix
#<b>Lesser redeem score:</b> $unit.variables.lesser_redeem_count|/$unit.variables.max_lesser_redeem_count
#"
    #			[/set_variable]
    #		[/then]
    #	[/if]
    #	[if]
    #		[variable]
    #			name=unit.variables.starving
    #			greater_than=0
    #		[/variable]
    #		[then]
    #			[set_variable]
    #				name=desc_prefix
    #				value=_"$desc_prefix
#<b>Starving:</b> $unit.variables.starving
#"
    #			[/set_variable]
    #		[/then]
    #	[/if]
    #	[if]
    #		[variable]
    #			name=unit.variables.wrath
    #			equals=yes
    #		[/variable]
    #		[then]
    #			[set_variable]
    #				name=desc_prefix
    #				value=_"$desc_prefix
#<b>Wrath:</b> $unit.variables.wrath_intensity
#"
    #			[/set_variable]
    #		[/then]
    #	[/if]
    #	[if]
    #		[variable]
    #			name=unit.variables.from_the_ashes_used
    #			equals=yes
    #		[/variable]
    #		[then]
    #			[set_variable]
    #				name=desc_prefix
    #				value=_"$desc_prefix
#<b>Turns until From the Ashes will be usable:</b> $unit.variables.from_the_ashes_cooldown
#"
    #			[/set_variable]
    #		[/then]
    #	[/if]
    #        {FOREACH unit.attack i}
    #            {VARIABLE count nothing_yet}
    #            [while]
    #                [variable]
    #                    name=count
    #                    not_equals="poison"
    #                [/variable]
    #                [do]
    #                    {TEXT_COUNT count firststrike poison}
    #                    {TEXT_COUNT count attacks firststrike}
    #                    {TEXT_COUNT count slow attacks}
    #                    {TEXT_COUNT count plague slow}
    #                    {TEXT_COUNT count chance_to_hit plague}
    #                    {TEXT_COUNT count berserk chance_to_hit}
    #                    {TEXT_COUNT count damage berserk}
    #                    {TEXT_COUNT count dummy damage}
    #                    {TEXT_COUNT count drains dummy}
    #                    {TEXT_COUNT count swarm drains}
    #                    {TEXT_COUNT count nothing_yet swarm}
    #                    {VARIABLE variable_in_foreach "unit.attack[$i].specials.$count|.length"}
    #                    [set_variable]
    #                        name="foreach"
    #                        to_variable="$variable_in_foreach"
    #                    [/set_variable]
    #                    {VARIABLE j 0}
    #                    [while]
    #                        [variable]
    #                            name="j"
    #                            less_than="$foreach"
    #                        [/variable]
    #                        [do]
    #                            [set_variable]
    #                                name="name"
    #                                to_variable="unit.attack[$i].specials.$count|[$j].name"
    #                            [/set_variable]
    #                            [if]
    #                                [variable]
    #                                    name=name
    #                                    equals=""
    #                                [/variable]
    #                                [else]
    #                                    #														[set_variable]
    #                                    #															name="description"
    #                                    #															to_variable="unit.attack[$i].specials.$count|.description"
    #                                    #														[/set_variable]
    #                                    {VARIABLE specials[$specials.length].special "<span color='green'>$name|</span>"} #($description|)"}
    #                                [/else]
    #                            [/if]
    #                            {CLEAR_VARIABLE name}
    #                        {NEXT j}
    #                    [/do]
    #                [/while]
    #                [set_variable]
    #                    name=weapon_specials
    #                    [join]
    #                        variable=specials
    #                        key=special
    #                        separator=", "
    #                        remove_empty=yes
    #                    [/join]
    #                [/set_variable]
    #                {CLEAR_VARIABLE specials}
    #                [set_variable]
    #                    name=damage
    #                    to_variable=unit.attack[$i].damage
    #                    round=floor
    #                [/set_variable]
    #                [set_variable]
    #                    name=number
    #                    to_variable=unit.attack[$i].number
    #                    round=floor
    #                [/set_variable]
    #                [if]
    #                    [variable]
    #                        name=unit.attack[$i].attack_weight
    #                        equals="0"
    #                    [/variable]
    #                    [then]
    #                        [if]
    #                            [variable]
    #                                name=unit.attack[$i].defense_weight
    #                                equals="0"
    #                            [/variable]
    #                            [then]
    #                                {VARIABLE attacks[$attacks.length].attack _"<span color='red'>$unit.attack[$i].description|</span> ($damage|-$number| $unit.attack[$i].range| - $unit.attack[$i].type|, inactive): $weapon_specials"}
    #                            [/then]
    #                            [else]
    #                                {VARIABLE attacks[$attacks.length].attack _"<span color='red'>$unit.attack[$i].description|</span> ($damage|-$number| $unit.attack[$i].range| - $unit.attack[$i].type|, defend only): $weapon_specials"}
    #                            [/else]
    #                        [/if]
    #                    [/then]
    #                    [else]
    #                        [if]
    #                            [variable]
    #                                name=unit.attack[$i].defense_weight
    #                                equals="0"
    #                            [/variable]
    #                            [then]
    #                                {VARIABLE attacks[$attacks.length].attack _"<span color='red'>$unit.attack[$i].description|</span> ($damage|-$number| $unit.attack[$i].range| - $unit.attack[$i].type|, attack only): $weapon_specials"}
    #                            [/then]
    #                            [else]
    #                                {VARIABLE attacks[$attacks.length].attack _"<span color='red'>$unit.attack[$i].description|</span> ($damage|-$number| $unit.attack[$i].range| - $unit.attack[$i].type|): $weapon_specials"}
    #                            [/else]
    #                        [/if]
    #                    [/else]
    #                [/if]
    #                {CLEAR_VARIABLE damage,number}
    #            {NEXT i}
    #            [set_variable]
    #                name=attacks_list
    #                [join]
    #                    variable=attacks
    #                    key=attack
    #                    separator="
#"
    #                    remove_empty=yes
    #                [/join]
    #            [/set_variable]
    #            {CLEAR_VARIABLE attacks}
    #            {VARIABLE count nothing_yet}
    #            [while]
    #                [variable]
    #                    name=count
    #                    not_equals="hides"
    #                [/variable]
    #                [do]
    #                    {TEXT_COUNT count dummy hides}
    #                    {TEXT_COUNT count teleport dummy}
    #                    {TEXT_COUNT count illuminates teleport}
    #                    {TEXT_COUNT count skirmisher illuminates}
    #                    {TEXT_COUNT count leadership skirmisher}
    #                    {TEXT_COUNT count resistance leadership}
    #                    {TEXT_COUNT count regenerate resistance}
    #                    {TEXT_COUNT count heals regenerate}
    #                    {TEXT_COUNT count nothing_yet heals}
    #                    {VARIABLE variable_in_foreach "unit.abilities.$count|.length"}
    #                    [set_variable]
    #                        name="foreach"
    #                        to_variable="$variable_in_foreach"
    #                    [/set_variable]
    #                    {VARIABLE j 0}
    #                    [while]
    #                        [variable]
    #                            name="j"
    #                            less_than="$foreach"
    #                        [/variable]
    #                        [do]
    #                            [set_variable]
    #                                name="name"
    #                                to_variable="unit.abilities.$count|[$j].description"
    #                            [/set_variable]
    #                            [if]
    #                                [variable]
    #                                    name=name
    #                                    equals=""
    #                                [/variable]
    #                                [else]
    #				    [set_variables]
    #					name=ability_lines
    #					mode=replace
    #					[split]
    #						list=$name
    #						key=line
    #						separator="
#"
    #						remove_empty=yes
    #					[/split]
    #				    [/set_variables]
    #				    [set_variable]
    #					name=name
    #					[join]
    #						variable=ability_lines
    #						key=line
    #						separator="
#"
    #						remove_empty=yes
    #					[/join]
    #				    [/set_variable]
    #                                    {VARIABLE abilities[$abilities.length].ability "<i>$unit.abilities.$count|[$j].name|</i>:
#$name"}
    #                                [/else]
    #                            [/if]
    #                            {CLEAR_VARIABLE name,ability_lines}
    #                        {NEXT j}
    #                    [/do]
    #                [/while]
    #                [set_variable]
    #                    name=abilities_list
    #                    [join]
    #                        variable=abilities
    #                        key=ability
    #                        separator="
#
#"
    #                        remove_empty=yes
    #                    [/join]
    #                [/set_variable]
    #                [if]
    #                    [variable]
    #                        name=abilities.length
    #                        greater_than=0
    #                    [/variable]
    #                    [else]
    #                        {VARIABLE abilities_list _"none"}
    #                    [/else]
    #                [/if]
    #                {CLEAR_VARIABLE abilities}
    #                {FOREACH unit.abilities.resistance i}
    #                    [if]
    #                        [variable]
    #                            name=unit.abilities.resistance[$i].id
    #                            contains="_penetrate"
    #                        [/variable]
    #                        [then]
    #                            {VARIABLE penetrations[$penetrations.length].penetrate _"<span color='#60A0FF'>$unit.abilities.resistance[$i].apply_to|</span>: $unit.abilities.resistance[$i].sub"}
    #			[/then]
    #
    #		[/if]
    #	{NEXT i}
    #   	[set_variable]
    #		name=resistance_penetrations
    #		[join]
    #			variable=penetrations
    #			key=penetrate
    #			separator="
#
#"
    #			remove_empty=yes
    #		[/join]
    #	[/set_variable]
    #	[if]
    #		[variable]
    #			name=penetrations.length
    #			greater_than=0
    #		[/variable]
    #		[else]
    #			{VARIABLE resistance_penetrations _"none"}
    #		[/else]
    #
    #	[/if]
    #	{CLEAR_VARIABLE penetrations}
    #   	[set_variable]
    #		name=advancements_taken
    #		[join]
    #			variable=unit.modifications.advance
    #			key=description
    #			separator="
#"
    #			remove_empty=yes
    #		[/join]
    #	[/set_variable]
    #	[if]
    #		[variable]
    #			name=advancements_taken
    #			equals=""
    #		[/variable]
    #		[then]
    #			{VARIABLE advancements_taken _"none"}
    #		[/then]
    #
    #	[/if]
    #	{FOREACH unit.modifications.object i}
    #		[if]
    #			[variable]
    #				name=unit.modifications.object[$i].sort
    #				equals="limited"
    #			[/variable]
    #			[then]
    #				{VARIABLE limited_items[$limited_items.length].name $unit.modifications.object[$i].name}
    #			[/then]
    #
    #		[/if]
    #	{NEXT i}
    #   	[set_variable]
    #		name=limited_items_list
    #		[join]
    #			variable=limited_items
    #			key=name
    #			separator="
#"
    #			remove_empty=yes
    #		[/join]
    #	[/set_variable]
    #	[if]
    #		[variable]
    #			name=limited_items_list
    #			equals=""
    #		[/variable]
    #		[then]
    #			{VARIABLE limited_items_list _"none"}
    #		[/then]
    #
    #	[/if]
    #	{CLEAR_VARIABLE limited_items}
    #	[message]
    #		speaker=narrator
    #		message= _ "This panel shows information you might not have a direct access to, but it might be useful to know.
#$desc_prefix
#<b>Attacks:</b>
#$attacks_list
#
#<b>Resistance penetrations:</b>
#$resistance_penetrations
#
#<b>Abilities:</b>
#<span size='x-small'>$abilities_list|</span>
#
#<b>Resistances:</b>
#Blade: $(100-$unit.resistance.blade)%
#Pierce: $(100-$unit.resistance.pierce)%
#Impact: $(100-$unit.resistance.impact)%
#Fire: $(100-$unit.resistance.fire)%
#Cold: $(100-$unit.resistance.cold)%
#Arcane: $(100-$unit.resistance.arcane)%
#
#<b>Books and other items which can't be unequipped</b>
#$limited_items_list
#
#<b>Advancements taken:</b>
#$advancements_taken"
    #	[/message]
    #	{CLEAR_VARIABLE desc_prefix,attacks_list,description,weapon_specials,resistance_penetrations,advancements_taken,abilities_list,limited_items_list}
    #[/event]

    [event]
        name=unit information
        first_time_only=no
        # This is the rewrite from fdsfsfdsjkljkl, nicely improving the old code. See the code above to get an idea how could it be done in pure WML without lua, but it's not as good.

        # Compute any "special" state that a unit may have.  The vast majority of
        # units won't have anything reported by this section.
        [lua]
            code=<<
	unit_information_part_1()
  >>
        [/lua]

        # Some fairly tricky code to make a nicely formatted list of a unit's
        # attacks.  Most of the code is straightforward, but the specials parsing
        # requires some familiarity with the WML object to Lua table conversion
        # described here:
        # http://wiki.wesnoth.org/Luawml#Encoding_WML_objects_into_Lua_tables
        [lua]
            code=<<
	unit_information_part_2()
  >>
        [/lua]

        # Creates a cleaned up list of a unit's abilities
        [lua]
            code=<<
	unit_information_part_3()
  >>
        [/lua]

        # Create the resistances and penetrations table.  Monospace fonts are key
        # here to ensure that the columns of our "table" line up properly, since each
        # character takes up the same amount of space.
        [lua]
            code=<<
	unit_information_part_4()
  >>
        [/lua]

        # Generate the list of books read and limited use items used.
        # Simple enough -- no Lua needed.
        {FOREACH unit.modifications.object i}
            [if]
                [variable]
                    name=unit.modifications.object[$i].sort
                    equals="limited"
                [/variable]
                [then]
                    {VARIABLE limited_items[$limited_items.length].name $unit.modifications.object[$i].name}
                [/then]
            [/if]
            [if]
                [variable]
                    name=unit.modifications.object[$i].sort
                    equals="potion"
                [/variable]
                [then]
                    {VARIABLE potions[$potions.length].name $unit.modifications.object[$i].name}
                [/then]
            [/if]
        {NEXT i}
        [set_variable]
            name=limited_items_list
            [join]
                variable=limited_items
                key=name
                separator=", "
                remove_empty=yes
            [/join]
        [/set_variable]
        [if]
            [variable]
                name=limited_items_list
                equals=""
            [/variable]
            [then]
                {VARIABLE limited_items_list _"none"}
            [/then]
        [/if]

        [set_variable]
            name=potions_list
            [join]
                variable=potions
                key=name
                separator=", "
                remove_empty=yes
            [/join]
        [/set_variable]
        [if]
            [variable]
                name=potions_list
                equals=""
            [/variable]
            [then]
                {VARIABLE potions_list _"none"}
            [/then]
        [/if]
        {CLEAR_VARIABLE potions,limited_items}

        # Create a list of advancements with a count of how many times each was taken
        [lua]
            code=<<
	unit_information_part_5()
  >>
        [/lua]

        [message]
            speaker=narrator
            image=$unit.profile
            caption=$unit.name
            message= _ "
<span size='xx-large' weight='bold' underline='single'>$unit.name</span><span color='#88FCA0' size='x-large'> ($unit.language_name)</span>
$desc_prefix
<span size='large' weight='bold'>Attacks:</span>
$attacks_list

<span size='large' weight='bold'>Abilities:</span>
$abilities_list

<span size='large' weight='bold'>Resistances and Penetrations:</span>
$resistances_list

<span size='large' weight='bold'>Potions in effect:</span>
$potions_list

<span size='large' weight='bold'>Books Read and Non-Removable Items:</span>
$limited_items_list

<span size='large' weight='bold'>Advancements taken:</span>
$advancements_taken
$soul_eating"
        [/message]

        {CLEAR_VARIABLE desc_prefix,attacks_list,abilities_list,resistances_list,limited_items_list,advancements_taken,soul_eating,potions_list}
    [/event]

    [event]
        name=recall list items
        first_time_only=no
        {VARIABLE picked_id "uninitialised"}
        [set_variables]
            name=recall_message
            mode=replace
            [value]
                speaker=narrator
                message=_"You can look now what items are worn by units on your recall list. By selecting one of them, you can rename that unit to find it easier or to take its items to the item storage."
                [option]
                    message=_"Exit."
                [/option]
            [/value]
        [/set_variables]
        [store_unit]
            [filter]
                x=recall
                y=recall
                side=1
            [/filter]
            variable=unrecalled
            kill=no
        [/store_unit]
        {FOREACH unrecalled i}
            [set_variable]
                name=items_on
                [join]
                    variable=unrecalled[$i].modifications.object
                    key=name
                    separator=,
                    remove_empty=yes
                [/join]
            [/set_variable]
            {VARIABLE name $unrecalled[$i].name}
            [if]
                [variable]
                    name=name
                    not_equals=""
                [/variable]
                [else]
                    {VARIABLE name _"An unnamed unit"}
                [/else]
            [/if]
            [if]
                [variable]
                    name=items_on
                    not_equals=""
                [/variable]
                [then]
                    [set_variables]
                        name=recall_message.option[$recall_message.option.length]
                        mode=replace
                        [value]
                            message=_"$name has $items_on"
                            [command]
                                {VARIABLE picked_id $unrecalled[$i].id}
                            [/command]
                        [/value]
                    [/set_variables]
                [/then]
            [/if]
        {NEXT i}
        [insert_tag]
            name=message
            variable=recall_message
        [/insert_tag]
        [if]
            [variable]
                name=picked_id
                not_equals=uninitialised
            [/variable]
            [then]
                [message]
                    speaker=narrator
                    message=_"What do you want to do with this unit?"
                    [option]
                        message=_"Nothing."
                    [/option]
                    [option]
                        message=_"Rename to find it easier."
                        [show_if]
                            [variable]
                                name=picked.unrenamable
                                not_equals=yes
                            [/variable]
                        [/show_if]
                        [command]
                            [store_unit]
                                [filter]
                                    id=$picked_id
                                [/filter]
                                variable=picked
                                kill=yes
                            [/store_unit]
                            [message]
                                speaker=narrator
                                message=_"Suggest a name, then."
                                [text_input]
                                    variable=picked.name
                                    label=_"New name"
                                    max_length=100
                                    text="$picked.name"
                                [/text_input]
                            [/message]
                            [unstore_unit]
                                variable=picked
                            [/unstore_unit]
                        [/command]
                    [/option]
                    [option]
                        message=_"Unequip all items."
                        [command]
                            [store_unit]
                                [filter]
                                    id=$picked_id
                                [/filter]
                                variable=stripped
                                kill=yes
                            [/store_unit]
                            [fire_event]
                                name=unequip all items
                                [primary_unit]
                                    id=$picked_id
                                [/primary_unit]
                            [/fire_event]
                        [/command]
                    [/option]
                [/message]
            [/then]
        [/if]
        {CLEAR_VARIABLE picked_id,unrecalled,picked,recall_message,name}
    [/event]

    [event]
        name=unequip all items
        first_time_only=no
        {FOREACH stripped.modifications.object i}
            [if]
                [variable]
                    name=stripped.modifications.object[$i].sort
                    equals=sword
                [/variable]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=axe
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=staff
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=dagger
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=armour
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=amulet
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=ring
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=cloak
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=bow
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=xbow
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=knife
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=helm
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=gauntlets
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=boots
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=mace
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=spear
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=sling
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=polearm
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=thunderstick
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=claws
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=essence
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=stripped.modifications.object[$i].sort
                        equals=exotic
                    [/variable]
                [/or]
                [then]
                    [set_variable]
                        name=length
                        to_variable=item_storage.$stripped.modifications.object[$i].sort|.length
                    [/set_variable]
                    [set_variables]
                        name=item_storage.$stripped.modifications.object[$i].sort|[$length]
                        mode=replace
                        [value]
                            type=$stripped.modifications.object[$i].number
                        [/value]
                    [/set_variables]
                    {CLEAR_VARIABLE stripped.modifications.object[$i]}
                    {VARIABLE_OP i sub 1}
                    {CLEAR_VARIABLE length}
                [/then]
            [/if]
        {NEXT i}
        [unstore_unit]
            variable=stripped
        [/unstore_unit]
    [/event]

    [event]
        name=start
        # Remove recently picked gems on units on the recall list
        [store_unit]
            [filter]
#ifndef MULTIPLAYER
                side=1
#else
                side=1,2,3,4,5
#endif
            [/filter]
            variable=starters
            kill=yes
        [/store_unit]
        {FOREACH starters i}
            {FOREACH starters[$i].modifications.object j}
                [if]
                    [variable]
                        name=starters[$i].modifications.object[$j].number
                        greater_than_equal_to=521
                    [/variable]
                    [and]
                        [variable]
                            name=starters[$i].modifications.object[$j].number
                            less_than_equal_to=530
                        [/variable]
                    [/and]
                    [then]
                        {CLEAR_VARIABLE starters[$i].modifications.object[$j]}
                        {VARIABLE_OP j sub 1}
                    [/then]
                [/if]
            {NEXT j}
            [unstore_unit]
                variable=starters[$i]
            [/unstore_unit]
        {NEXT i}
    [/event]

    [event]
        name=turn refresh
        first_time_only=no
        #Workaround to make units newly created with plague behave properly.
        [store_unit]
            [filter]
                [not]
                    [filter_wml]
                        [variables]
                            updated=yes
                        [/variables]
                    [/filter_wml]
                [/not]
#ifndef MULTIPLAYER
                side=1
#else
                side=1,2,3,4,5
#endif
            [/filter]
            variable=updating_store
        [/store_unit]
        {FOREACH updating_store us_i}
            [set_variables]
                name=advanced2
                mode=replace
                to_variable=updating_store[$us_i]
            [/set_variables]
            [fire_event]
                name=update_stats
                [primary_unit]
                    id=$advanced2.id
                [/primary_unit]
            [/fire_event]
        {NEXT us_i}
        {CLEAR_VARIABLE updating_store}
    [/event]
    {HELP_EVENTS}
    [event]
        name=recruit
        first_time_only=no
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=advanced
            kill=no
        [/store_unit]
#ifndef MULTIPLAYER
        [if]
            [variable]
                name=side_number
                equals=1
            [/variable]
            [then]
                {VARIABLE_OP loyality rand (1..50)}
                [if]
                    [variable]
                        name=loyality
                        equals=1
                    [/variable]
                    [and]
                        [variable]
                            name=advanced.modifications.trait[0].availability
                            not_equals="musthave"
                        [/variable]
                    [/and]
                    [then]
                        {CLEAR_VARIABLE advanced.modifications.trait[0]}
                        {VARIABLE advanced.modifications.trait[1].id loyal}
                        {VARIABLE advanced.modifications.trait[1].male_name loyal}
                        {VARIABLE advanced.modifications.trait[1].female_name _"female^loyal"}
                        {VARIABLE advanced.modifications.trait[1].effect.apply_to loyal}
                        {VARIABLE advanced.modifications.trait[1].description _"Requires no upkeep"}
                    [/then]
                [/if]
                {VARIABLE_OP highlander rand (1..100)}
                [if]
                    [variable]
                        name=highlander
                        equals=1
                    [/variable]
                    [and]
                        [variable]
                            name=advanced.modifications.trait[0].availability
                            not_equals="musthave"
                        [/variable]
                    [/and]
                    [then]
                        {CLEAR_VARIABLE advanced.modifications.trait[0]}
                        {VARIABLE advanced.modifications.trait[1].id healthy}
                        {VARIABLE advanced.modifications.trait[1].male_name highlander}
                        {VARIABLE advanced.modifications.trait[1].female_name _"female^highlander"}	#Should be female^highlander, but I don't know how to make random contents of variables translatable.
#ifver WESNOTH_VERSION >= 1.11.8
                        {VARIABLE advanced.modifications.trait[1].generate_description false}
                        {VARIABLE advanced.modifications.trait[1].description _"Born better than others"}
#else
                        {VARIABLE advanced.modifications.trait[1].description _"Born better than others, 1 more damage per level, heals 2 HP every turn"}
#endif
                        {VARIABLE advanced.modifications.trait[1].effect.apply_to hitpoints}
                        {VARIABLE advanced.modifications.trait[1].effect.increase_total 5}
                        {VARIABLE advanced.modifications.trait[1].effect[1].apply_to hitpoints}
                        {VARIABLE advanced.modifications.trait[1].effect[1].increase_total 3}
                        {VARIABLE advanced.modifications.trait[1].effect[1].times "per level"}
                        {VARIABLE advanced.modifications.trait[1].effect[2].apply_to attack}
                        {VARIABLE advanced.modifications.trait[1].effect[2].increase_damage 1}
                        {VARIABLE advanced.modifications.trait[1].effect[2].times "per level"}
                        {VARIABLE advanced.hitpoints "$($advanced.max_hitpoints+5+3*$advanced.level)"}
                    [/then]
                [/if]
                [unstore_unit]
                    variable=advanced
                    find_vacant=no
                [/unstore_unit]
                [if]
                    [variable]
                        name=highlander
                        equals=1
                    [/variable]
                    [or]
                        [variable]
                            name=loyal
                            equals=1
                        [/variable]
                    [/or]
                    [then]
                        [store_unit]
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            variable=advanced2
                            kill=yes
                        [/store_unit]
                        [unit]	#Doesn't flash white like the previous way to do it
                            side=$advanced2.side
                            x=$advanced2.x
                            y=$advanced2.y
                            experience=$advanced2.experience
                            canrecruit=$advanced2.canrecruit
                            variation=$advanced2.variation
                            type=$advanced2.type
                            id=$advanced2.id
                            moves=$advanced2.moves
                            hitpoints=$advanced2.hitpoints
                            gender=$advanced2.gender
                            name=$advanced2.name
                            overlays=$advanced2.overlays
                            facing=$advanced2.facing
                            extra_recruit=$advanced2.extra_recruit
                            attacks_left=0
                            moves=0
                            underlying_id=$advanced2.underlying_id
                            unrenamable=$advanced2.unrenamable
                            animate=no
                            [insert_tag]
                                name=status
                                variable=advanced2.status
                            [/insert_tag]
                            [insert_tag]
                                name=modifications
                                variable=advanced2.modifications
                            [/insert_tag]
                            [insert_tag]
                                name=variables
                                variable=advanced2.variables
                            [/insert_tag]
                        [/unit]
                        {UPDATE_ATTACKS $advanced2.x $advanced2.y}
                    [/then]
                    [else]
                        {UPDATE_ATTACKS $x1 $y1}
                    [/else]
                [/if]
                [if]
                    [variable]
                        name=loyality
                        equals=1
                    [/variable]
                    [then]
                        [unit_overlay]
                            id=$advanced.id
                            image=misc/loyal-icon.png
                        [/unit_overlay]
                    [/then]
                [/if]
            [/then]
        [/if]
#endif
        {CLEAR_VARIABLE highlander}
        {CLEAR_VARIABLE advanced,advanced2}
        {CLEAR_VARIABLE loyality}
    [/event]
#ifndef EASY
    [event]
        name=recruit
        first_time_only=no
        [filter]
            side=$enemy_sides
        [/filter]
#ifdef NORMAL
        {VARIABLE_OP bonus rand (1..20)}
#endif
#ifdef HARD
        {VARIABLE_OP bonus rand (1..10)}
#endif
#ifdef MULTIPLAYER
        {VARIABLE_OP bonus rand (1..10)}
#endif
        [if]
            [variable]
                name=bonus
                equals=1
            [/variable]
            [then]
                {VARIABLE_OP type rand (1..10)}
                [switch]
                    variable=type
                    [case]
                        value=1
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=attack
                                increase_damage=80%
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(30,0,0)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=2
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=attack
                                increase_attacks=80%
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(0,0,30)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=3
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=attack
                                set_type=arcane
                                [set_specials]
                                    mode=append
                                    {WEAPON_SPECIAL_DRAIN}
                                [/set_specials]
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(-30,-30,-30)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=4
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=resistance
                                replace=false
                                [resistance]
                                    blade=-40
                                    impact=-40
                                    pierce=-40
                                [/resistance]
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="O(50%)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=5
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=movement
                                increase=5
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(0,30,30)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=6
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    {ABILITY_REGENERATES_OTHER 32}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(30,30,30)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=7
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    {ABILITY_SKIRMISHER}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=movement
                                increase=2
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(0,20,40)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=8
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    {ABILITY_REFLECT}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(40,20,0)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=9
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    {ABILITY_TEMPTATION}
                                [/abilities]
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(50,20,10)"
                            [/effect]
                        [/object]
                    [/case]
                    [case]
                        value=10
                        [object]
                            silent=yes
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [effect]
                                apply_to=resistance
                                replace=false
                                [resistance]
                                    fire=-40
                                    cold=-40
                                    arcane=-40
                                [/resistance]
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="O(50%)"
                            [/effect]
                            [effect]
                                apply_to=image_mod
                                add="CS(0,20,40)"
                            [/effect]
                        [/object]
                    [/case]
                [/switch]
            [/then]
        [/if]
        {CLEAR_VARIABLE bonus,type}
    [/event]
#endif
    [event]
        name=recall
        first_time_only=no
        [filter]
            side=1
        [/filter]
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=advanced
            kill=no
        [/store_unit]
        [if]
            [variable]
                name=advanced.variables.updated
                equals=yes
            [/variable]
            [else]
                {UPDATE_ATTACKS_STUFF}
                {VARIABLE advanced.variables.updated yes}
            [/else]
        [/if]
        {CLEAR_VARIABLE advanced.variables.starving}
        [unstore_unit]
            variable=advanced
            find_vacant=no
        [/unstore_unit]
        {CLEAR_VARIABLE advanced}
        [allow_undo]
        [/allow_undo]
    [/event]

    [event]
        name=start
        [store_unit]
            [filter]
                race=demon-loti
                canrecruit=yes
                [or]
                    race=demon lord-loti
                    canrecruit=yes
                [/or]
                [or]
                    race=imp-loti
                    canrecruit=yes
                [/or]
            [/filter]
            variable=leader
            kill=yes
        [/store_unit]
        {FOREACH leader i}
            [unit]
                x=$leader[$i].x
                y=$leader[$i].y
                id=$leader[$i].id
                side=$leader[$i].side
                canrecruit=no
                type=$leader[$i].type
                random_traits=yes
                name=$leader[$i].name
                gender=$leader[$i].gender
                to_variable=leader_store
                [insert_tag]
                    name=modifications
                    variable=$leader[$i].modifications
                [/insert_tag]
                [insert_tag]
                    name=variables
                    variable=$leader[$i].variables
                [/insert_tag]
                [insert_tag]
                    name=status
                    variable=$leader[$i].status
                [/insert_tag]
            [/unit]
            {VARIABLE leader_store.canrecruit yes}
            [unstore_unit]
                variable=leader_store
            [/unstore_unit]
            {CLEAR_VARIABLE leader_store}
        {NEXT i}
        {CLEAR_VARIABLE leader}
    [/event]
    [event]
        name=turn refresh
        first_time_only=no
        [if]
            [variable]
                name=side_number
                equals=1
            [/variable]
#ifdef MULTIPLAYER
            [or]
                [variable]
                    name=side_number
                    equals=2
                [/variable]
            [/or]
            [or]
                [variable]
                    name=side_number
                    equals=3
                [/variable]
            [/or]
            [or]
                [variable]
                    name=side_number
                    equals=4
                [/variable]
            [/or]
            [or]
                [variable]
                    name=side_number
                    equals=5
                [/variable]
            [/or]
#endif
            [then]
                [store_unit]
                    [filter]
                        side=$side_number
                        [filter_wml]
                            [variables]
                                may_need_respec=yes
                            [/variables]
                        [/filter_wml]
                    [/filter]
                    variable=advanced
                    kill=no
                [/store_unit]
                {FOREACH advanced ak}
                    [fire_event]
                        name=force respec
                        [primary_unit]
                            id=$advanced[$ak].id
                        [/primary_unit]
                    [/fire_event]
                {NEXT ak}
                {CLEAR_VARIABLE advanced}
            [/then]
        [/if]
    [/event]
    [event]
        name=force respec
        first_time_only=no
        {CLEAR_VARIABLE unit.variables.may_need_respec}
        {VARIABLE times_advanced 0}
#ifver WESNOTH_VERSION >= 1.13.2
        {FOREACH unit.modifications.advancement i}
#else
#ifver WESNOTH_VERSION >= 1.13.2
        {FOREACH unit.modifications.advancement i}
#else
        {FOREACH unit.modifications.advance i}
#endif
#endif
            [if]
                [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                    name=unit.modifications.advancement[$i].id
#else
#ifver WESNOTH_VERSION >= 1.13.2
                    name=unit.modifications.advancement[$i].id
#else
                    name=unit.modifications.advance[$i].id
#endif
#endif
                    equals=backup_amla
                [/variable]
                [then]
                    {VARIABLE_OP times_advanced add 1}
#ifver WESNOTH_VERSION >= 1.13.2
                    {CLEAR_VARIABLE unit.modifications.advancement[$i]}
#else
#ifver WESNOTH_VERSION >= 1.13.2
                    {CLEAR_VARIABLE unit.modifications.advancement[$i]}
#else
                    {CLEAR_VARIABLE unit.modifications.advance[$i]}
#endif
#endif
                    {VARIABLE_OP i sub 1}
                [/then]
            [/if]
        {NEXT i}
        [if]	#For the case if something went wrong
            [variable]
                name=times_advanced
                equals=0
            [/variable]
            [else]
                [while]
                    [variable]
                        name=times_advanced
                        greater_than=0
                    [/variable]
                    [do]
                        {VARIABLE experience_to_give $unit.experience}
                        {VARIABLE_OP experience_to_give add $unit.max_experience}
                        {CLEAR_VARIABLE unit.variables.may_need_respec}
                        [unit]
                            side=$unit.side
                            x=$unit.x
                            y=$unit.y
                            experience=$experience_to_give
                            max_experience=$unit.max_experience
                            canrecruit=$unit.canrecruit
                            variation=$unit.variation
                            type=Advancing $unit.type
                            id=$unit.id
                            hitpoints=$unit.hitpoints
                            gender=$unit.gender
                            name=$unit.name
                            facing=$unit.facing
                            extra_recruit=$unit.extra_recruit
                            underlying_id=$unit.underlying_id
                            unrenamable=$unit.unrenamable
                            overlays=$unit.overlays
                            animate=no
                            [insert_tag]
                                name=status
                                variable=unit.status
                            [/insert_tag]
                            [insert_tag]
                                name=modifications
                                variable=unit.modifications
                            [/insert_tag]
                            [insert_tag]
                                name=variables
                                variable=unit.variables
                            [/insert_tag]
                            to_variable=advancing_store
                        [/unit]
                        [unstore_unit]
                            variable=advancing_store
                            find_vacant=no
                        [/unstore_unit]
                        [store_unit]
                            [filter]
                                id=$advancing_store.id
                            [/filter]
                            variable=advanced
                            kill=yes
                        [/store_unit]
                        [unit]
                            side=$unit.side
                            x=$unit.x
                            y=$unit.y
                            experience=$advanced.experience
                            canrecruit=$unit.canrecruit
                            variation=$unit.variation
                            type=$unit.type
                            id=$unit.id
                            moves=$unit.moves
                            hitpoints=$unit.hitpoints
                            gender=$unit.gender
                            name=$unit.name
                            facing=$unit.facing
                            extra_recruit=$unit.extra_recruit
                            underlying_id=$unit.underlying_id
                            unrenamable=$unit.unrenamable
                            animate=no
                            attacks_left=$unit.attacks_left
                            overlays=$unit.overlays
                            [insert_tag]
                                name=status
                                variable=unit.status
                            [/insert_tag]
                            [insert_tag]
                                name=modifications
                                variable=advanced.modifications
                            [/insert_tag]
                            [insert_tag]
                                name=variables
                                variable=unit.variables
                            [/insert_tag]
                            to_variable=advanced2
                        [/unit]
                        {VARIABLE_OP times_advanced sub 1}
                    [/do]
                [/while]
                [fire_event]
                    name=update_stats
                    [primary_unit]
                        id=$advanced2.id
                    [/primary_unit]
                [/fire_event]
            [/else]
        [/if]
        {CLEAR_VARIABLE experience_to_give,times_advanced,advancing_store}
    [/event]

    [event]
        name=make black soul
        first_time_only=no
        [set_variable]
            name=blackening_store.level
            multiply=3
        [/set_variable]
        [set_variable]
            name=blackening_store.variables.black_soul
            set=yes
        [/set_variable]
        [set_variable]
            name=blackening_store.level
            add=2
        [/set_variable]
        [set_variable]
            name=blackening_store.race
            value="black soul-loti"
        [/set_variable]
        [set_variable]
            name=blackening_store.alignment
            value=chaotic
        [/set_variable]
        [set_variable]
            name=blackening_store.status.unplagueable
            value=yes
        [/set_variable]
        [unstore_unit]
            variable=blackening_store
            find_vacant=yes
        [/unstore_unit]
        [object]
            [filter]
                id=$blackening_store.id
            [/filter]
            silent=yes
            duration=forever
            [effect]
                apply_to=image_mod
                replace="CS(-255,-255,-255)"
            [/effect]
            [effect]
                apply_to=max_experience
                increase=150%
            [/effect]
            [effect]
                apply_to=attack
                increase_damage=110%
                {QUANTITY increase_damage 40% 75% 110%}
                increase_attacks=50%
                [set_specials]
                    mode=append
                    {WEAPON_SPECIAL_LETHARGY}
                [/set_specials]
            [/effect]
            [effect]
                apply_to=hitpoints
                increase=100%
                increase_total=100%
            [/effect]
            [effect]
                apply_to=resistance
                replace=false
                [resistance]
                    fire=-30
                    cold=-30
                    arcane=50
                    blade=-30
                    pierce=-30
                    impact=-30
                [/resistance]
            [/effect]
        [/object]
    [/event]

    [event]
	name=make doppelganger
	first_time_only=no
	[set_variables]
		name=doppel_stats
		[value]
			[effect]
				apply_to=hitpoints
				increase_total="$(0.5*$unit.max_hitpoints)"
			[/effect]
			[effect]
				apply_to=new_ability
				[insert_tag]
					name=abilities
					variable=unit.abilities
				[/insert_tag]
			[/effect]
		[/value]
	[/set_variables]
	{FOREACH doppel_stats.effect[1].abilities.dummy i}
		[if]
			[variable]
				name=doppel_stats.effect[1].abilities.dummy[$i].id
				equals=soul eater
			[/variable]
			[then]
				{CLEAR_VARIABLE doppel_stats.effect[1].abilities.dummy[$i]}
			[/then]
		[/if]
	{NEXT i}
	{FOREACH unit.attack i}
		[set_variables]
			name=doppel_stats.effect[$doppel_stats.effect.length]
			to_variable=unit.attack[$i]
			mode=replace
		[/set_variables]
		{VARIABLE "doppel_stats.effect[$($doppel_stats.effect.length-1)].apply_to" new_attack}
		{VARIABLE_OP "doppel_stats.effect[$($doppel_stats.effect.length-1)].damage" divide 2}
	{NEXT i}
	[if]
		[variable]
			name=unit.type
			contains=Lethalia
		[/variable]
		[then]
			{GENERIC_UNIT $unit.side Lethalia_doppelganger $unit.x $unit.y}
			[+unit]
				[modifications]
						[insert_tag]
#ifver WESNOTH_VERSION >= 1.13.2
							name=advancement
#else
							name=advance
#endif
							variable=doppel_stats
						[/insert_tag]
				[/modifications]
			[/unit]
		[/then]
		[else]
			{GENERIC_UNIT $unit.side Efraim_doppelganger $unit.x $unit.y}
			[+unit]
				[modifications]
						[insert_tag]
#ifver WESNOTH_VERSION >= 1.13.2
							name=advancement
#else
							name=advance
#endif
							variable=doppel_stats
						[/insert_tag]
				[/modifications]
			[/unit]
		[/else]
	[/if]
	{CLEAR_VARIABLE doppel_stats}
    [/event]

    [event]
        name=attack_end
        first_time_only=no
        [if]
            [variable]
                name=unit.hitpoints
                greater_than=0
            [/variable]
            [then]
                {VARIABLE_OP unit.experience add $unit.variables.lua_delayed_exp}
                {CLEAR_VARIABLE unit.variables.lua_delayed_exp}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                    advance=no
                [/unstore_unit]
            [/then]
        [/if]
        [if]
            [variable]
                name=second_unit.hitpoints
                greater_than=0
            [/variable]
            [then]
                {VARIABLE_OP second_unit.experience add $second_unit.variables.lua_delayed_exp}
                {CLEAR_VARIABLE second_unit.variables.lua_delayed_exp}
                [unstore_unit]
                    variable=second_unit
                    find_vacant=no
                    advance=no
                [/unstore_unit]
            [/then]
        [/if]
    [/event]

    [event]
        name=new turn,victory
        first_time_only=no
        [store_unit]
            [filter]
                [filter_wml]
                    [variables]
                        healed_this_turn=yes
                    [/variables]
                [/filter_wml]
            [/filter]
            variable=no_longer
        [/store_unit]
        {FOREACH no_longer i}
            {CLEAR_VARIABLE no_longer[$i].variables.healed_this_turn}
            [unstore_unit]
                variable=no_longer[$i]
                find_vacant=no
                advance=no
            [/unstore_unit]
        {NEXT i}
        {CLEAR_VARIABLE no_longer}
    [/event]

#ifndef NO_LOTI
    [event]
        name=victory
        [store_turns]
            variable=turns
        [/store_turns]
        [if]
            [variable]
                name=turns
                not_equals=-1
            [/variable]
            [then]
                [if]
                    # Initialise variable if necessary
                    [variable]
                        name=saved_turns
                        greater_than=0
                    [/variable]
                    [else]
                        {VARIABLE saved_turns 0}
                    [/else]
                [/if]
                {VARIABLE turns_multiplied "$($turns-$turn_number)"}
                {VARIABLE_OP turns_multiplied multiply 100}
                {VARIABLE_OP turns_multiplied divide $turns}
                {VARIABLE old_saved_turns $saved_turns}
                {VARIABLE_OP saved_turns add $turns_multiplied}
                [if]
                    [variable]
                        name=saved_turns
                        greater_than_equal_to=500
                    [/variable]
                    [and]
                        [variable]
                            name=old_saved_turns
                            less_than=500
                        [/variable]
                    [/and]
                    [then]
                        [message]
                            speaker=narrator
                            message=_"Your rapid progress has caused your enemies to panic. Horribly desperate to stop your progress, they looked into ancient archives of forbidden lore and found a solution. They cast a spell that exploited a small weakness in the barrier separating Inferno, reached in and summoned one of its most horrid entities, Beelzebub. They made a pact so that the hellspawn would chase you. Fortunately, Beelzebub is not very good at pursuing."
                            side_for=$side_number
                            image="wesnoth-icon.png"
                        [/message]
                    [/then]
                [/if]
            [/then]
        [/if]
        {CLEAR_VARIABLE turns_multiplied,turns,old_saved_turns}
    [/event]
#endif

#ifdef ACCELERATE_AI
    [event]
        name=start
        [if]
            [variable]
                name=no_fast_ai
                equals=yes
            [/variable]
            [else]
                [store_side]
                    [filter]
                    [/filter]
                    variable=ai_sides
                [/store_side]
                {FOREACH ai_sides i}
                    [if]
                        [variable]
                            name=ai_sides[$i].controller
                            equals=ai
                        [/variable]
                        [then]
#ifver WESNOTH_VERSION >= 1.13.2
                           [micro_ai]
                                side=$ai_sides[$i].side
                                ai_type=fast_ai
                                action=add
                           [/micro_ai]
#else
                           [micro_ai_fast]
                                side=$ai_sides[$i].side
                                ai_type=fast_ai
                                action=add
                           [/micro_ai_fast]
#endif
 
                        [/then]
                    [/if]
                {NEXT i}
                {CLEAR_VARIABLE ai_sides}
            [/else]
        [/if]
    [/event]
#endif

#enddef
