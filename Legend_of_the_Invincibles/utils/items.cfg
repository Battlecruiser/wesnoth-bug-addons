#textdomain wesnoth-loti
#define INSERT_INTO_ITEMS ARRAY SORT ITEM_NUMBER
    # Code donated by matsjoyce
    # Use these to shorten code below
    {VARIABLE sort {SORT}}
    {VARIABLE item {ITEM_NUMBER}}
    [set_variable]
        name=high
        to_variable={ARRAY}.$sort|.length
    [/set_variable]
    {VARIABLE_OP high sub 1}
    # Insert into the item storage using a binary search to find the position
    [if]
        # First check if the array is empty or item is greater than the last element
        [variable]
            name=high
            equals=-1
        [/variable]
        [or]
            [variable]
                name={ARRAY}.$sort|[$high].type
                less_than=$item
            [/variable]
        [/or]
        [then]
            # Append item to the end of the array
            {VARIABLE_OP high add 1}
            [set_variables]
                name={ARRAY}.$sort|[$high]
                mode=replace
                [value]
                    type={ITEM_NUMBER}
                [/value]
            [/set_variables]
        [/then]
        [else][if]
            # Then check if item is less than the first element (we know the array is not empty)
            [variable]
                name={ARRAY}.$sort|[0].type
                greater_than_equal_to=$item
            [/variable]
            [then]
                # Insert at position 0
                [set_variables]
                    name={ARRAY}.$sort|[0]
                    mode=insert
                    [value]
                        type={ITEM_NUMBER}
                    [/value]
                [/set_variables]
            [/then]
            [else]
                # Binary search bit. High is the upper bound, low is the lower bound
                # Iterate until the difference is 1, at which point item should go between positions low and high
                {VARIABLE low 0}
                {VARIABLE diff $high}
                {VARIABLE_OP diff sub $low}
                [while]
                    {VARIABLE_CONDITIONAL diff not_equals 1}
                    [do]
                        # mid = (low + high) // 2
                        {VARIABLE mid $high}
                        {VARIABLE_OP mid add $low}
                        {VARIABLE_OP mid divide 2}
                        {VARIABLE_OP mid round floor}
                        [if]
                            [variable]
                                name={ARRAY}.$sort|[$mid].type
                                greater_than_equal_to=$item
                            [/variable]
                            [then]
                                {VARIABLE high $mid}
                            [/then]
                            [else]
                                {VARIABLE low $mid}
                            [/else]
                        [/if]
                        {VARIABLE diff $high}
                        {VARIABLE_OP diff sub $low}
                        {CLEAR_VARIABLE mid}
                    [/do]
                [/while]
                {CLEAR_VARIABLE low}
                {CLEAR_VARIABLE diff}
                # insert at high to put item between low and high
                [set_variables]
                    name={ARRAY}.$sort|[$high]
                    mode=insert
                    [value]
                        type=$item
                    [/value]
                [/set_variables]
            [/else]
        [/if][/else]
    [/if]
    {CLEAR_VARIABLE high}
    {CLEAR_VARIABLE sort}
    {CLEAR_VARIABLE item}
#enddef
#define DESCRIBE_SPECIAL SPECIAL
    {FOREACH item_list.object[$item_number].specials.{SPECIAL} v}
        [if]
            [variable]
                name=item_list.object[$item_number].specials.{SPECIAL}[$v].name
                not_equals=""
            [/variable]
            [then]
                [set_variable]
                    name=object_description[$object_description.length].effect
                    value=_"<span color='green'>New weapon special: " + "$item_list.object[$item_number].specials.{SPECIAL}[$v].name </span>"
                [/set_variable]
            [/then]
        [/if]
    {NEXT v}
    {FOREACH item_list.object[$item_number].specials_melee.{SPECIAL} v}
        [if]
            [variable]
                name=item_list.object[$item_number].specials_melee.{SPECIAL}[$v].name
                not_equals=""
            [/variable]
            [then]
                [set_variable]
                    name=object_description[$object_description.length].effect
                    value=_"<span color='green'>New weapon special: " + "$item_list.object[$item_number].specials_melee.{SPECIAL}[$v].name" + _" (melee weapons only)</span>"
                [/set_variable]
            [/then]
        [/if]
    {NEXT v}
    {FOREACH item_list.object[$item_number].specials_ranged.{SPECIAL} v}
        [if]
            [variable]
                name=item_list.object[$item_number].specials_ranged.{SPECIAL}[$v].name
                not_equals=""
            [/variable]
            [then]
                [set_variable]
                    name=object_description[$object_description.length].effect
                    value= _"<span color='green'>New weapon special: " + "$item_list.object[$item_number].specials_ranged.{SPECIAL}[$v].name" + _" (ranged weapons only)</span>"
                [/set_variable]
            [/then]
        [/if]
    {NEXT v}
#enddef
#define DESCRIBE_RESIST TYPE PLAYER_TYPE
    [if]
        [variable]
            name=item_list.object[$item_number].{TYPE}_resist
            not_equals=""
        [/variable]
        [then]
            [if]
                [variable]
                    name=item_list.object[$item_number].{TYPE}_resist
                    greater_than=0
                [/variable]
                [then]
                    [set_variable]
                        name=object_description[$object_description.length].effect
                        value=_"<span color='#60A0FF'>Resistance to " + {PLAYER_TYPE} + _" increased by $item_list.object[$item_number].{TYPE}_resist|% </span>"
                    [/set_variable]
                [/then]
                [else]
                    [set_variable]
                        name=object_description[$object_description.length].effect
                        value=_"<span color='#60A0FF'>Resistance to " + {PLAYER_TYPE} + _" decreased by $(-1*$item_list.object[$item_number].{TYPE}_resist)% </span>"
                    [/set_variable]
                [/else]
            [/if]
        [/then]
    [/if]
#enddef
#define DESCRIBE_PENETRATE TYPE PLAYER_TYPE
    [if]
        [variable]
            name=item_list.object[$item_number].{TYPE}_penetrate
            not_equals=""
        [/variable]
        [then]
            [set_variable]
                name=object_description[$object_description.length].effect
                value=_"<span color='green'>Enemy resistances to " + {PLAYER_TYPE} + _" decreased by " + "$item_list.object[$item_number].{TYPE}_penetrate|% </span>"
            [/set_variable]
        [/then]
    [/if]
#enddef
#define DESCRIBE_ABILITY NAME
    {FOREACH item_list.object[$item_number].effect[$p].abilities.{NAME} v}
        [if]
            [variable]
                name=item_list.object[$item_number].effect[$p].abilities.{NAME}.name
                not_equals=""
            [/variable]
            [then]
                [set_variable]
                    name=object_description[$object_description.length].effect
                    value=_"<span color='#60A0FF'>New ability: " + "$item_list.object[$item_number].effect[$p].abilities.{NAME}[$v].name </span>"
                [/set_variable]
            [/then]
        [/if]
    {NEXT v}
#enddef
#define DESCRIBE_DEFENSE NAME NAME_PLAYER
    [if]
        [variable]
            name=item_list.object[$item_number].effect[$p].defense.{NAME}
            not_equals=""
        [/variable]
        [then]
            [if]
                [variable]
                    name=item_list.object[$item_number].effect[$p].defense.{NAME}
                    greater_than=0
                [/variable]
                [then]
                    [set_variable]
                        name=object_description[$object_description.length].effect
                        value=_"<span color='#60A0FF'>Chance to get hit " + {NAME_PLAYER} + _" increased by " + "$item_list.object[$item_number].effect[$p].defense.{NAME} </span>"
                    [/set_variable]
                [/then]
                [else]
                    [set_variable]
                        name=object_description[$object_description.length].effect
                        value=_"<span color='#60A0FF'>Chance to get hit " + {NAME_PLAYER} + _" reduced by " + "$(-1*$item_list.object[$item_number].effect[$p].defense.{NAME}) </span>"
                    [/set_variable]
                [/else]
            [/if]
        [/then]
    [/if]
#enddef
#define DESCRIBE_MOVEMENT_COSTS NAME NAME_PLAYER
    [if]
        [variable]
            name=item_list.object[$item_number].effect[$p].movement_costs.{NAME}
            not_equals=""
        [/variable]
        [then]
            [set_variable]
                name=object_description[$object_description.length].effect
                value=_"<span color='#60A0FF'>Movement costs " + {NAME_PLAYER} + _" set to " + "$item_list.object[$item_number].effect[$p].movement_costs.{NAME} </span>"
            [/set_variable]
        [/then]
    [/if]
#enddef
#define GEM_CASE NUMBER VARIABLE_NAME
    [case]
        value={NUMBER}
        [if]
            [variable]
                name={VARIABLE_NAME}
                greater_than=0
            [/variable]
            [then]
                {VARIABLE_OP {VARIABLE_NAME} add 1}
            [/then]
            [else]
                {VARIABLE {VARIABLE_NAME} 1}
            [/else]
        [/if]
    [/case]
#enddef
#define CANNOT_TAKE_OPTIONS
    [option]
        message=_"Store it."
        [show_if]
            [not]
                [variable]
                    name=no_inventory
                    equals=yes
                [/variable]
            [/not]
        [/show_if]
        [command]
            {INSERT_INTO_ITEMS item_storage $item_list.object[$item_number].sort| $item_list.object[$item_number].number|}
            [remove_item]
                x,y=$x1,$y1
                image=$item_list.object[$item_number].image
            [/remove_item]
            {CLEAR_VARIABLE items[$k]}
            {VARIABLE_OP l add -1}
            {VARIABLE picked 1}
        [/command]
    [/option]
    [option]
        message=_"Leave it on the ground."
        [command]
        [/command]
    [/option]
#enddef

#define GENERATE_ITEM_LIST
    [set_variables]
        name=item_list
        mode=replace
        [literal]
            {ITEM_LIST}
        [/literal]
    [/set_variables]
    {FOREACH item_list.object item_number}
        {CLEAR_VARIABLE object_description}
        [if]
            [variable]
                name=item_list.object[$item_number].defence
                not_equals=""
            [/variable]
            [then]
                [if]
                    [variable]
                        name=item_list.object[$item_number].defence
                        greater_than=0
                    [/variable]
                    [then]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>Increases physical resistances by $item_list.object[$item_number].defence|% </span>"}
                    [/then]
                    [else]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>Decreases physical resistances by $(-1*$item_list.object[$item_number].defence)% </span>"}
                    [/else]
                [/if]
            [/then]
        [/if]
        [if]
            [variable]
                name=item_list.object[$item_number].damage
                not_equals=""
            [/variable]
            [then]
                [if]
                    [variable]
                        name=item_list.object[$item_number].damage
                        greater_than=0
                    [/variable]
                    [then]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Damage increased by $item_list.object[$item_number].damage|%</span>"}
                    [/then]
                    [else]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Damage decreased by $(-1*$item_list.object[$item_number].damage)%</span>"}
                    [/else]
                [/if]
            [/then]
        [/if]
        [if]
            [variable]
                name=item_list.object[$item_number].damage_plus
                not_equals=""
            [/variable]
            [then]
                [if]
                    [variable]
                        name=item_list.object[$item_number].damage_plus
                        greater_than=0
                    [/variable]
                    [then]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Damage increased by $item_list.object[$item_number].damage_plus|</span>"}
                    [/then]
                    [else]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Damage decreased by $(-1*$item_list.object[$item_number].damage_plus)</span>"}
                    [/else]
                [/if]
            [/then]
        [/if]
        [if]
            [variable]
                name=item_list.object[$item_number].damage_melee
                not_equals=""
            [/variable]
            [then]
                [if]
                    [variable]
                        name=item_list.object[$item_number].damage_melee
                        greater_than=0
                    [/variable]
                    [then]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Damage increased by $item_list.object[$item_number].damage_melee|% (melee attacks only)</span>"}
                    [/then]
                    [else]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Damage decreased by $(-1*$item_list.object[$item_number].damage_melee)% (melee attacks only)</span>"}
                    [/else]
                [/if]
            [/then]
        [/if]
        [if]
            [variable]
                name=item_list.object[$item_number].damage_melee_plus
                not_equals=""
            [/variable]
            [then]
                [if]
                    [variable]
                        name=item_list.object[$item_number].damage_melee_plus
                        greater_than=0
                    [/variable]
                    [then]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Damage increased by $item_list.object[$item_number].damage_melee_plus| (melee attacks only)</span>"}
                    [/then]
                    [else]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Damage decreased by $(-1*$item_list.object[$item_number].damage_melee_plus) (melee attacks only)</span>"}
                    [/else]
                [/if]
            [/then]
        [/if]
        [if]
            [variable]
                name=item_list.object[$item_number].damage_ranged
                not_equals=""
            [/variable]
            [then]
                [if]
                    [variable]
                        name=item_list.object[$item_number].damage_ranged
                        greater_than=0
                    [/variable]
                    [then]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Damage increased by $item_list.object[$item_number].damage_ranged|% (ranged attacks only)</span>"}
                    [/then]
                    [else]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Damage decreased by $(-1*$item_list.object[$item_number].damage_ranged)% (ranged attacks only)</span>"}
                    [/else]
                [/if]
            [/then]
        [/if]
        [if]
            [variable]
                name=item_list.object[$item_number].damage_ranged_plus
                not_equals=""
            [/variable]
            [then]
                [if]
                    [variable]
                        name=item_list.object[$item_number].damage_ranged_plus
                        greater_than=0
                    [/variable]
                    [then]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Damage increased by $item_list.object[$item_number].damage_ranged_plus| (ranged attacks only)</span>"}
                    [/then]
                    [else]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Damage decreased by $(-1*$item_list.object[$item_number].damage_ranged_plus) (ranged attacks only)</span>"}
                    [/else]
                [/if]
            [/then]
        [/if]
        [if]
            [variable]
                name=item_list.object[$item_number].attacks
                not_equals=""
            [/variable]
            [then]
                [if]
                    [variable]
                        name=item_list.object[$item_number].sort
                        equals=sword
                    [/variable]
                    [or]
                        [variable]
                            name=item_list.object[$item_number].sort
                            equals=axe
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=item_list.object[$item_number].sort
                            equals=bow
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=item_list.object[$item_number].sort
                            equals=mace
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=item_list.object[$item_number].sort
                            equals=xbow
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=item_list.object[$item_number].sort
                            equals=spear
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=item_list.object[$item_number].sort
                            equals=dagger
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=item_list.object[$item_number].sort
                            equals=knife
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=item_list.object[$item_number].sort
                            equals=staff
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=item_list.object[$item_number].sort
                            equals=weaponword
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=item_list.object[$item_number].sort
                            equals=polearm
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=item_list.object[$item_number].sort
                            equals=sling
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=item_list.object[$item_number].sort
                            equals=thunderstick
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=item_list.object[$item_number].sort
                            equals=claws
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=item_list.object[$item_number].sort
                            equals=essence
                        [/variable]
                    [/or]
                    [or]
                        [variable]
                            name=item_list.object[$item_number].sort
                            equals=exotic
                        [/variable]
                    [/or]
                    [then]
                        [if]
                            [variable]
                                name=item_list.object[$item_number].attacks
                                greater_than=0
                            [/variable]
                            [then]
                                {VARIABLE object_description[$object_description.length].effect _"<span color='green'>$item_list.object[$item_number].attacks|% more attacks </span>"}
                            [/then]
                            [else]
                                {VARIABLE object_description[$object_description.length].effect _"<span color='green'>$(-1*$item_list.object[$item_number].attacks)% fewer attacks </span>"}
                            [/else]
                        [/if]
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=item_list.object[$item_number].attacks
                                equals=1
                            [/variable]
                            [then]
                                {VARIABLE object_description[$object_description.length].effect _"<span color='green'>1 more attack</span>"}
                            [/then]
                            [else]
                                [if]
                                    [variable]
                                        name=item_list.object[$item_number].attacks
                                        greater_than=0
                                    [/variable]
                                    [then]
                                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>$item_list.object[$item_number].attacks more attacks</span>"}
                                    [/then]
                                    [else]
                                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>$(-1*$item_list.object[$item_number].attacks) fewer attacks</span>"}
                                    [/else]
                                [/if]
                            [/else]
                        [/if]
                    [/else]
                [/if]
            [/then]
        [/if]
        [if]
            [variable]
                name=item_list.object[$item_number].merge
                equals=yes
            [/variable]
            [then]
                {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Merges attacks</span>"}
            [/then]
        [/if]
        [if]
            [variable]
                name=item_list.object[$item_number].damage_type
                not_equals=""
            [/variable]
            [then]
                [switch]
                    variable=item_list.object[$item_number].damage_type
                    [case]
                        value=fire
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Sets weapon damage type to fire </span>"}
                    [/case]
                    [case]
                        value=cold
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Sets weapon damage type to cold </span>"}
                    [/case]
                    [case]
                        value=arcane
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Sets weapon damage type to arcane </span>"}
                    [/case]
                    [case]
                        value=blade
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Sets weapon damage type to blade </span>"}
                    [/case]
                    [case]
                        value=impact
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Sets weapon damage type to impact </span>"}
                    [/case]
                    [case]
                        value=pierce
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Sets weapon damage type to pierce </span>"}
                    [/case]
                    [case]
                        value=lightning
                        {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Sets weapon damage type to lightning </span>"}
                    [/case]
                [/switch]
            [/then]
        [/if]
        [if]
            [variable]
                name=item_list.object[$item_number].suck
                greater_than=0
            [/variable]
            [then]
                {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>Sucks $item_list.object[$item_number].suck health from targets with each hit</span>"}
            [/then]
        [/if]
        [if]
            [variable]
                name=item_list.object[$item_number].spell_suck
                greater_than=0
            [/variable]
            [then]
                {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>Spells suck $item_list.object[$item_number].spell_suck health from targets with each hit</span>"}
            [/then]
        [/if]
        [if]
            [variable]
                name=item_list.object[$item_number].devastating_blow
                greater_than=0
            [/variable]
            [then]
                {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>$item_list.object[$item_number].devastating_blow|% chance to strike a devastating blow</span>"}
            [/then]
        [/if]
        {DESCRIBE_PENETRATE blade _"blade"}
        {DESCRIBE_PENETRATE impact _"impact"}
        {DESCRIBE_PENETRATE pierce _"pierce"}
        {DESCRIBE_PENETRATE fire _"fire"}
        {DESCRIBE_PENETRATE cold _"cold"}
        {DESCRIBE_PENETRATE arcane _"arcane"}
        {DESCRIBE_SPECIAL berserk}
        {DESCRIBE_SPECIAL plague}
        {DESCRIBE_SPECIAL drains}
        {DESCRIBE_SPECIAL damage}
        {DESCRIBE_SPECIAL slow}
        {DESCRIBE_SPECIAL dummy}
        {DESCRIBE_SPECIAL chance_to_hit}
        {DESCRIBE_SPECIAL poison}
        {DESCRIBE_SPECIAL swarm}
        {DESCRIBE_SPECIAL firststrike}
        {DESCRIBE_SPECIAL attacks}
        [if]
            [variable]
                name=item_list.object[$item_number].magic
                not_equals=""
            [/variable]
            [then]
                {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Increases all magical damages by $item_list.object[$item_number].magic|% </span>"}
            [/then]
        [/if]
        [if]
            [variable]
                name=item_list.object[$item_number].dodge
                not_equals=""
            [/variable]
            [then]
                {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>Chance to get hit decreased by $item_list.object[$item_number].dodge|%</span>"}
            [/then]
        [/if]
        {DESCRIBE_RESIST blade _"blade"}
        {DESCRIBE_RESIST impact _"impact"}
        {DESCRIBE_RESIST pierce _"pierce"}
        {DESCRIBE_RESIST fire _"fire"}
        {DESCRIBE_RESIST cold _"cold"}
        {DESCRIBE_RESIST arcane _"arcane"}
        [if]
            [variable]
                name=item_list.object[$item_number].vision
                not_equals=""
            [/variable]
            [then]
                [if]
                    [variable]
                        name=item_list.object[$item_number].vision
                        greater_than=0
                    [/variable]
                    [then]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>Increases vision range by $item_list.object[$item_number].vision </span>"}
                    [/then]
                    [else]
                        {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>Decreases vision range by $(-1*$item_list.object[$item_number].vision) </span>"}
                    [/else]
                [/if]
            [/then]
        [/if]
        {FOREACH item_list.object[$item_number].effect p}
            [if]
                [variable]
                    name=item_list.object[$item_number].effect[$p].apply_to
                    equals=new_ability
                [/variable]
                [then]
                    {DESCRIBE_ABILITY heals}
                    {DESCRIBE_ABILITY regenerate}
                    {DESCRIBE_ABILITY resistance}
                    {DESCRIBE_ABILITY leadership}
                    {DESCRIBE_ABILITY skirmisher}
                    {DESCRIBE_ABILITY illuminates}
                    {DESCRIBE_ABILITY teleport}
                    {DESCRIBE_ABILITY hides}
                    {DESCRIBE_ABILITY dummy}
                [/then]
            [/if]
            [if]
                [variable]
                    name=item_list.object[$item_number].effect[$p].apply_to
                    equals=movement
                [/variable]
                [then]
                    [if]
                        [variable]
                            name=item_list.object[$item_number].effect[$p].increase
                            greater_than_equal_to=0
                        [/variable]
                        [then]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].effect[$p].increase
                                    equals=1
                                [/variable]
                                [then]
                                    {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>1 extra movement point </span>"}
                                [/then]
                                [else]
                                    {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>$item_list.object[$item_number].effect[$p].increase more movement points </span>"}
                                [/else]
                            [/if]
                        [/then]
                        [else]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].effect[$p].increase
                                    equals=-1
                                [/variable]
                                [then]
                                    {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>1 fewer movement point </span>"}
                                [/then]
                                [else]
                                    {VARIABLE negated "$(-1*$item_list.object[$item_number].effect[$p].increase)"}
                                    {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>$negated fewer movement points </span>"}
                                    {CLEAR_VARIABLE negated}
                                [/else]
                            [/if]
                        [/else]
                    [/if]
                [/then]
            [/if]
            [if]
                [variable]
                    name=item_list.object[$item_number].effect[$p].apply_to
                    equals=hitpoints
                [/variable]
                [then]
                    [if]
                        [variable]
                            name=item_list.object[$item_number].effect[$p].increase_total
                            greater_than_equal_to=0
                        [/variable]
                        [then]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].effect[$p].times
                                    equals=per level
                                [/variable]
                                [then]
                                    {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>$item_list.object[$item_number].effect[$p].increase_total more hitpoints per level</span>"}
                                [/then]
                                [else]
                                    {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>$item_list.object[$item_number].effect[$p].increase_total more hitpoints</span>"}
                                [/else]
                            [/if]
                        [/then]
                        [else]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].effect[$p].times
                                    equals=per level
                                [/variable]
                                [then]
                                    {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>$(-1*$item_list.object[$item_number].effect[$p].increase_total) fewer hitpoints per level</span>"}
                                [/then]
                                [else]
                                    {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>$(-1*$item_list.object[$item_number].effect[$p].increase_total) fewer hitpoints</span>"}
                                [/else]
                            [/if]
                        [/else]
                    [/if]
                [/then]
            [/if]
            [if]
                [variable]
                    name=item_list.object[$item_number].effect[$p].apply_to
                    equals=defense
                [/variable]
                [then]
                    {DESCRIBE_DEFENSE forest _"in forests"}
                    {DESCRIBE_DEFENSE frozen _"on frozen places"}
                    {DESCRIBE_DEFENSE flat _"on flat terrains"}
                    {DESCRIBE_DEFENSE cave _"in caves"}
                    {DESCRIBE_DEFENSE fungus _"in mushroom groves"}
                    {DESCRIBE_DEFENSE village _"in villages"}
                    {DESCRIBE_DEFENSE castle _"in castles"}
                    {DESCRIBE_DEFENSE shallow_water _"in shallow waters"}
                    {DESCRIBE_DEFENSE reef _"on coastal reefs"}
                    {DESCRIBE_DEFENSE deep_water _"in deep water"}
                    {DESCRIBE_DEFENSE swamp_water _"in swamps"}
                    {DESCRIBE_DEFENSE hills _"on hills"}
                    {DESCRIBE_DEFENSE mountains _"on mountains"}
                    {DESCRIBE_DEFENSE sand _"on sands"}
                    {DESCRIBE_DEFENSE unwalkable _"above unwalkable places"}
                    {DESCRIBE_DEFENSE impassable _"inside impassable walls"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=item_list.object[$item_number].effect[$p].apply_to
                    equals=movement_costs
                [/variable]
                [then]
                    {DESCRIBE_MOVEMENT_COSTS forest _"through forests"}
                    {DESCRIBE_MOVEMENT_COSTS frozen _"on frozen lands"}
                    {DESCRIBE_MOVEMENT_COSTS flat _"on flat terrains"}
                    {DESCRIBE_MOVEMENT_COSTS cave _"through dark caves"}
                    {DESCRIBE_MOVEMENT_COSTS fungus _"through mushroom groves"}
                    {DESCRIBE_MOVEMENT_COSTS village _"through villages"}
                    {DESCRIBE_MOVEMENT_COSTS castle _"through castles"}
                    {DESCRIBE_MOVEMENT_COSTS shallow_water _"in shallow waters"}
                    {DESCRIBE_MOVEMENT_COSTS reef _"on coastal reefs"}
                    {DESCRIBE_MOVEMENT_COSTS deep_water _"in deep waters"}
                    {DESCRIBE_MOVEMENT_COSTS swamp_water _"through swampy places"}
                    {DESCRIBE_MOVEMENT_COSTS hills _"on hills"}
                    {DESCRIBE_MOVEMENT_COSTS mountains _"on mountains"}
                    {DESCRIBE_MOVEMENT_COSTS sand "across sands"}
                    {DESCRIBE_MOVEMENT_COSTS unwalkable _"above unwalkable places"}
                    {DESCRIBE_MOVEMENT_COSTS impassable _"through impassable walls"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=item_list.object[$item_number].effect[$p].apply_to
                    equals=alignment
                [/variable]
                [then]
                    [switch]
                        variable=item_list.object[$item_number].effect[$p].alignment
                        [case]
                            value=chaotic
                            {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Sets alignment to chaotic </span>"}
                        [/case]
                        [case]
                            value=liminal
                            {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Sets alignment to liminal </span>"}
                        [/case]
                        [case]
                            value=lawful
                            {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Sets alignment to lawful </span>"}
                        [/case]
                        [case]
                            value=neutral
                            {VARIABLE object_description[$object_description.length].effect _"<span color='green'>Sets alignment to neutral </span>"}
                        [/case]
                    [/switch]
                [/then]
            [/if]
            [if]
                [variable]
                    name=item_list.object[$item_number].effect[$p].apply_to
                    equals=status
                [/variable]
                [and]
                    [variable]
                        name=item_list.object[$item_number].effect[$p].add
                        equals=not_living
                    [/variable]
                [/and]
                [then]
                    {VARIABLE object_description[$object_description.length].effect _"<span color='#60A0FF'>Unlife (immunity to poison, plague and drain)</span>"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=item_list.object[$item_number].effect[$p].apply_to
                    equals=new_attack
                [/variable]
                [then]
                    {VARIABLE object_description[$object_description.length].effect _"<span color='green'>New attack: $item_list.object[$item_number].effect[$p].name ($item_list.object[$item_number].effect[$p].damage - $item_list.object[$item_number].effect[$p].number|)</span>"}
                [/then]
            [/if]
            [if]
                [variable]
                    name=item_list.object[$item_number].effect[$p].apply_to
                    equals=new_advancement
                [/variable]
                [then]
                    {VARIABLE object_description[$object_description.length].effect _"<span color='yellow'>New advancements: $item_list.object[$item_number].effect[$p].description|</span>"}
                [/then]
            [/if]
        {NEXT p}
        {FOREACH item_list.object[$item_number].latent p}
            [if]
                [variable]
                    name=item_list.object[$item_number].latent[$p].desc
                    not_equals=""
                [/variable]
                [then]
                    {VARIABLE object_description[$object_description.length].effect $item_list.object[$item_number].latent[$p].desc}
                [/then]
            [/if]
        {NEXT p}
        [if]	# Some items already possess a description
            [variable]
                name=item_list.object[$item_number].description
                equals=""
            [/variable]
            [then]
                [set_variable]
                    name=item_list.object[$item_number].description
                    [join]
                        variable=object_description
                        key=effect
                        separator="
"
                        remove_empty=yes
                    [/join]
                [/set_variable]
            [/then]
        [/if]
        {CLEAR_VARIABLE object_description}
        #			    [set_variable]
        #				name=item_list.object[$item_number].short_description
        #				[join]
        #					variable=object_description
        #					key=effect
        #					separator="/"
        #					remove_empty=yes
        #				[/join]
        #			    [/set_variable]
    {NEXT item_number}
    [set_variables]		#Item types are used in the code, and translating them will cause errors. This should make the usage of language names easy
        name=item_type_translations
        [value]
            [armour]
                translation= _ "armour"
            [/armour]
            [helm]
                translation= _ "helm"
            [/helm]
            [gauntlets]
                translation= _ "gauntlets"
            [/gauntlets]
            [boots]
                translation= _ "boots"
            [/boots]
            [sword]
                translation= _ "sword"
            [/sword]
            [axe]
                translation= _ "axe"
            [/axe]
            [staff]
                translation= _ "staff"
            [/staff]
            [bow]
                translation= _ "bow"
            [/bow]
            [dagger]
                translation= _ "dagger"
            [/dagger]
            [xbow]
                translation= _ "crossbow"
            [/xbow]
            [knife]
                translation= _ "knife"
            [/knife]
            [mace]
                translation= _ "mace"
            [/mace]
            [spear]
                translation= _ "spear"
            [/spear]
            [polearm]
                translation= _ "polearm"
            [/polearm]
            [sling]
                translation= _ "sling"
            [/sling]
            [thunderstick]
                translation= _ "thunderstick"
            [/thunderstick]
            [claws]
                translation= _ "metal claws"
            [/claws]
            [essence]
                translation= _ "otherworldly essence"
            [/essence]
            [amulet]
                translation= _ "amulet"
            [/amulet]
            [ring]
                translation= _ "ring"
            [/ring]
            [cloak]
                translation= _ "cloak"
            [/cloak]
            [limited]
                translation= _ "limited"
            [/limited]
            [potion]
                translation= _ "potion"
            [/potion]
        [/value]
    [/set_variables]
#enddef

#define REMOVE_OBJECT SORT
    [store_unit]
        [filter]
            x,y=$x1,$y1
        [/filter]
        variable=gifted
        kill=no
    [/store_unit]
    {VARIABLE i 0}
    [while]
        [variable]
            name=i
            less_than=$gifted.modifications.object.length
        [/variable]
        [do]
            [if]
                [variable]
                    name=gifted.modifications.object[$i].sort
                    equals={SORT}
                [/variable]
                [then]
                    [item]
                        x,y=$x1,$y1
                        image=$gifted.modifications.object[$i].image
                        halo=halo/misc/leadership-flare-1.png:20,halo/misc/leadership-flare-2.png:20,halo/misc/leadership-flare-3.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-4.png:20,halo/misc/leadership-flare-6.png:20,halo/misc/leadership-flare-7.png:20,halo/misc/leadership-flare-8.png:20,halo/misc/leadership-flare-9.png:20,halo/misc/leadership-flare-10.png:20,halo/misc/leadership-flare-11.png:20,halo/misc/leadership-flare-12.png:20,halo/misc/leadership-flare-13.png:20,misc/blank-hex.png:1000
                    [/item]
                    {VARIABLE_OP items_dropped add 1}
                    [set_variables]
                        name=items_to_add
                        mode=append
                        [value]
                            x=$x1
                            y=$y1
                            type=$gifted.modifications.object[$i].number
                            sort={SORT}
                        [/value]
                    [/set_variables]
                    {PLACE_ITEM_EVENT $x1 $y1}
                    {CLEAR_VARIABLE gifted.modifications.object[$i]}
                [/then]
                [else]
                    [set_variable]
                        name=i
                        add=1
                    [/set_variable]
                [/else]
            [/if]
        [/do]
    [/while]
    {CLEAR_VARIABLE i}
    [unstore_unit]
        variable=gifted
        find_vacant=no
    [/unstore_unit]
    {CLEAR_VARIABLE gifted}
#enddef

#define ITEM_PICK
    [event]
        name=item_pick
        first_time_only=no
        {VARIABLE picked 0}
        {FOREACH items k}
            [if]
                [variable]
                    name=x1
                    equals=$items[$k].x
                [/variable]
                [and]
                    [variable]
                        name=y1
                        equals=$items[$k].y
                    [/variable]
                [/and]
                [then]
                    [set_variable]
                        name=l
                        value=$k
                    [/set_variable]
                    [while]
                        [variable]
                            name=o
                            less_than=$item_list.object.length
                        [/variable]
                        [do]
                            [if]
                                [variable]
                                    name=item_list.object[$o].number
                                    equals=$items[$l].type
                                [/variable]
                                [then]
                                    {VARIABLE item_number $o}
                                [/then]
                            [/if]
                            [set_variable]
                                name=o
                                add=1
                            [/set_variable]
                        [/do]
                    [/while]
                    {CLEAR_VARIABLE o}
                    [if]
                        [variable]
                            name=item_list.object[$item_number].number
                            greater_than=530
                        [/variable]
                        [and]
                            [variable]
                                name=item_list.object[$item_number].number
                                less_than_equal_to=600
                            [/variable]
                        [/and]
                        [then]
                            {VARIABLE item_list.object[$item_number].sort $items[$l].sort}
                        [/then]
                    [/if]
                    {VARIABLE can_take 1}

                    [switch]
                        variable=item_list.object[$item_number].sort
                        [case]
                            value=armour
                            [if]
                                [variable]
                                    name=unit.type
                                    not_equals="Ghost"
                                [/variable]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Wraith"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Spectre"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Shadow"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Nightgaunt"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Reaper"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Dark Shade"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Blood Bat"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Vampire Bat"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Dread Bat"
                                    [/variable]
                                [/and]
                                [not]
                                    [variable]
                                        name=unit.type
                                        contains="doppelganger"
                                    [/variable]
                                [/not]
                                [else]
                                    {VARIABLE can_take _"This unit cannot wear armours."}
                                [/else]
                            [/if]
                        [/case]
                        [case]
                            value=helm
                            [if]
                                [variable]
                                    name=unit.type
                                    not_equals="Ghost"
                                [/variable]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Wraith"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Spectre"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Shadow"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Nightgaunt"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Reaper"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Dark Shade"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Blood Bat"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Vampire Bat"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Dread Bat"
                                    [/variable]
                                [/and]
                                [not]
                                    [variable]
                                        name=unit.type
                                        contains="doppelganger"
                                    [/variable]
                                [/not]
                                [else]
                                    {VARIABLE can_take _"This unit cannot wear armours, not even helms."}
                                    {VARIABLE diminishing 3}
                                [/else]
                            [/if]
                        [/case]
                        [case]
                            value=gauntlets
                            [if]
                                [variable]
                                    name=unit.type
                                    not_equals="Ghost"
                                [/variable]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Wraith"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Spectre"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Shadow"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Nightgaunt"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Reaper"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Dark Shade"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Blood Bat"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Vampire Bat"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Dread Bat"
                                    [/variable]
                                [/and]
                                [not]
                                    [variable]
                                        name=unit.type
                                        contains="doppelganger"
                                    [/variable]
                                [/not]
                                [else]
                                    {VARIABLE can_take _"This unit cannot wear armours, not even gauntlets."}
                                    {VARIABLE diminishing 3}
                                [/else]
                            [/if]
                        [/case]
                        [case]
                            value=boots
                            [if]
                                [variable]
                                    name=unit.type
                                    not_equals="Ghost"
                                [/variable]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Wraith"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Spectre"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Shadow"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Nightgaunt"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Reaper"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Dark Shade"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Blood Bat"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Vampire Bat"
                                    [/variable]
                                [/and]
                                [and]
                                    [variable]
                                        name=unit.type
                                        not_equals="Dread Bat"
                                    [/variable]
                                [/and]
                                [not]
                                    [variable]
                                        name=unit.type
                                        contains="doppelganger"
                                    [/variable]
                                [/not]
                                [else]
                                    {VARIABLE can_take _"This unit cannot wear armours, not even boots. It's a sad person, having to walk barefoot all the time..."}
                                    {VARIABLE diminishing 3}
                                [/else]
                            [/if]
                        [/case]
                        [case]
                            value=ring
                            [if]
                                [not]
                                    [variable]
                                        name=unit.type
                                        contains="doppelganger"
                                    [/variable]
                                [/not]
                                [else]
                                    {VARIABLE can_take _"This unit cannot wear rings. It might make marriage problematic."}
                                    {VARIABLE diminishing 3}
                                [/else]
                            [/if]
                        [/case]
                        [case]
                            value=amulet
                            [if]
                                [not]
                                    [variable]
                                        name=unit.type
                                        contains="doppelganger"
                                    [/variable]
                                [/not]
                                [else]
                                    {VARIABLE can_take _"This unit cannot wear amulets."}
                                    {VARIABLE diminishing 3}
                                [/else]
                            [/if]
                        [/case]
                        [case]
                            value=cloak
                            [if]
                                [not]
                                    [variable]
                                        name=unit.type
                                        contains="doppelganger"
                                    [/variable]
                                [/not]
                                [else]
                                    {VARIABLE can_take _"This unit cannot wear cloaks. Winter is not coming, fortunately."}
                                    {VARIABLE diminishing 3}
                                [/else]
                            [/if]
                        [/case]
                        [case]
                            value=sword
                            {VARIABLE can_take_this_weapon 0}
                            {FOREACH unit.attack attack_number}
                                [if]
                                    [variable]
                                        name=unit.attack[$attack_number].name
                                        equals="sword"
                                    [/variable]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="short sword"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="greatsword"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="saber"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="war talon"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="war blade"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="mberserk"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="whirlwind"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="lichsword"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="long sword"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="spectral blades"
                                        [/variable]
                                    [/or]
                                    [not]
                                        [variable]
                                            name=unit.type
                                            contains="doppelganger"
                                        [/variable]
                                    [/not]
                                    [then]
                                        {VARIABLE can_take_this_weapon 1}
                                    [/then]
                                [/if]
                            {NEXT attack_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit cannot use swords."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=axe
                            {VARIABLE can_take_this_weapon 0}
                            {FOREACH unit.attack attack_number}
                                [if]
                                    [variable]
                                        name=unit.attack[$attack_number].name
                                        equals="axe"
                                    [/variable]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="battle axe"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="berserker frenzy"
                                        [/variable]
                                    [/or]
                                    [not]
                                        [variable]
                                            name=unit.type
                                            contains="doppelganger"
                                        [/variable]
                                    [/not]
                                    [then]
                                        {VARIABLE can_take_this_weapon 1}
                                    [/then]
                                [/if]
                            {NEXT attack_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit cannot use axes."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=bow
                            {VARIABLE can_take_this_weapon 0}
                            {FOREACH unit.attack attack_number}
                                [if]
                                    [variable]
                                        name=unit.attack[$attack_number].name
                                        equals="bow"
                                    [/variable]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="longbow"
                                        [/variable]
                                    [/or]
                                    [not]
                                        [variable]
                                            name=unit.type
                                            contains="doppelganger"
                                        [/variable]
                                    [/not]
                                    [then]
                                        {VARIABLE can_take_this_weapon 1}
                                    [/then]
                                [/if]
                            {NEXT attack_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit cannot use bows."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=staff
                            {VARIABLE can_take_this_weapon 0}
                            [if]	#Exceptions to the rule
                                [variable]
                                    name=unit.type
                                    equals="Lich"
                                [/variable]
                                [or]
                                    [variable]
                                        name=unit.type
                                        equals="09 Ancient Lich"
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=unit.type
                                        equals="Lich King"
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=unit.type
                                        equals="Dark Adept"
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=unit.type
                                        equals="Elvish Shyde"
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=unit.type
                                        equals="Elvish Seer"
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=unit.type
                                        equals="Elvish Sylph"
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=unit.type
                                        equals="Celestial Messenger"
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=unit.type
                                        equals="Prophet"
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=unit.type
                                        equals="Mage of Light"
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=unit.type
                                        equals="Stormrider"
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=unit.type
                                        equals="Sword Mage"
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=unit.type
                                        equals="Knight of Magic"
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=unit.type
                                        equals="Warlock"
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=unit.type
                                        equals="Faerie Incarnation"
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=unit.type
                                        equals="Elvish Overlord"
                                    [/variable]
                                [/or]
                                [not]
                                     [variable]
                                         name=unit.type
                                         contains="doppelganger"
                                     [/variable]
                                [/not]
                                [then]
                                    {VARIABLE can_take_this_weapon 1}
                                [/then]
                            [/if]
                            {FOREACH unit.attack attack_number}
                                [if]
                                    [variable]
                                        name=unit.attack[$attack_number].name
                                        equals="staff"
                                    [/variable]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="plague staff"
                                        [/variable]
                                    [/or]
                                    [then]
                                        {VARIABLE can_take_this_weapon 1}
                                    [/then]
                                [/if]
                            {NEXT attack_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit cannot use staves."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=xbow
                            {VARIABLE can_take_this_weapon 0}
                            # This was in a patch, but I have no idea what's it for - I need to clarify it with the author, Ashes
                            # 				[if]	#Exceptions to the rule
                            # 					[variable]
                            # 						name=unit.type
                            # 						equals="Chaos Rider"
                            # 					[/variable]
                            # 					[then]
                            # 						{VARIABLE can_take_this_weapon 1}
                            # 					[/then]
                            # 				[/if]
                            {FOREACH unit.attack attack_number}
                                [if]
                                    [variable]
                                        name=unit.attack[$attack_number].name
                                        equals="crossbow"
                                    [/variable]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="slurbow"
                                        [/variable]
                                    [/or]
                                    [not]
                                        [variable]
                                            name=unit.type
                                            contains="doppelganger"
                                        [/variable]
                                    [/not]
                                    [then]
                                        {VARIABLE can_take_this_weapon 1}
                                    [/then]
                                [/if]
                            {NEXT attack_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit cannot use crossbows."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=dagger
                            {VARIABLE can_take_this_weapon 0}
                            {FOREACH unit.attack attack_number}
                                [if]
                                    [variable]
                                        name=unit.attack[$attack_number].name
                                        equals="dagger"
                                    [/variable]
                                    [not]
                                        [variable]
                                            name=unit.type
                                            contains="doppelganger"
                                        [/variable]
                                    [/not]
                                    [then]
                                        {VARIABLE can_take_this_weapon 1}
                                    [/then]
                                [/if]
                            {NEXT attack_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit cannot use daggers. Probably prefers more honest combat tactics."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=knife
                            {VARIABLE can_take_this_weapon 0}
                            {FOREACH unit.attack attack_number}
                                [if]
                                    [variable]
                                        name=unit.attack[$attack_number].name
                                        equals="knife"
                                    [/variable]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="throwing knives"
                                        [/variable]
                                    [/or]
                                    [not]
                                        [variable]
                                            name=unit.type
                                            contains="doppelganger"
                                        [/variable]
                                    [/not]
                                    [then]
                                        {VARIABLE can_take_this_weapon 1}
                                    [/then]
                                [/if]
                            {NEXT attack_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit cannot throw knives."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=mace
                            {VARIABLE can_take_this_weapon 0}
                            {FOREACH unit.attack attack_number}
                                [if]
                                    [variable]
                                        name=unit.attack[$attack_number].name
                                        equals="mace"
                                    [/variable]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="mace-spiked"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="morning star"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="club"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="flail"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="scourge"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="mace_berserk"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="hammer"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="hammer_runic"
                                        [/variable]
                                    [/or]
                                    [not]
                                        [variable]
                                            name=unit.type
                                            contains="doppelganger"
                                        [/variable]
                                    [/not]
                                    [then]
                                        {VARIABLE can_take_this_weapon 1}
                                    [/then]
                                [/if]
                            {NEXT attack_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit cannot use maces."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=polearm
                            {VARIABLE can_take_this_weapon 0}
                            {FOREACH unit.attack attack_number}
                                [if]
                                    [variable]
                                        name=unit.attack[$attack_number].name
                                        equals="halberd"
                                    [/variable]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="scythe"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="scythe-whirlwind"
                                        [/variable]
                                    [/or]
                                    [not]
                                        [variable]
                                            name=unit.type
                                            contains="doppelganger"
                                        [/variable]
                                    [/not]
                                    [then]
                                        {VARIABLE can_take_this_weapon 1}
                                    [/then]
                                [/if]
                            {NEXT attack_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit cannot use polearms."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=claws
                            {VARIABLE can_take_this_weapon 0}
                            {FOREACH unit.attack attack_number}
                                [if]
                                    [variable]
                                        name=unit.attack[$attack_number].name
                                        equals="claws"
                                    [/variable]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="battle claws"
                                        [/variable]
                                    [/or]
                                    [not]
                                        [variable]
                                            name=unit.type
                                            contains="doppelganger"
                                        [/variable]
                                    [/not]
                                    [then]
                                        {VARIABLE can_take_this_weapon 1}
                                    [/then]
                                [/if]
                            {NEXT attack_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit cannot use metal claws."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=sling
                            {VARIABLE can_take_this_weapon 0}
                            {FOREACH unit.attack attack_number}
                                [if]
                                    [variable]
                                        name=unit.attack[$attack_number].name
                                        equals="sling"
                                    [/variable]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="bolas"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="net"
                                        [/variable]
                                    [/or]
                                    [not]
                                        [variable]
                                            name=unit.type
                                            contains="doppelganger"
                                        [/variable]
                                    [/not]
                                    [then]
                                        {VARIABLE can_take_this_weapon 1}
                                    [/then]
                                [/if]
                            {NEXT attack_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit cannot use slings."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=essence
                            {VARIABLE can_take_this_weapon 0}
                            {FOREACH unit.attack attack_number}
                                [if]
                                    [variable]
                                        name=unit.attack[$attack_number].name
                                        equals="touch"
                                    [/variable]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="baneblade"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="faerie touch"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="vine"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="torch"
                                        [/variable]
                                    [/or]
                                    [not]
                                        [variable]
                                            name=unit.type
                                            contains="doppelganger"
                                        [/variable]
                                    [/not]
                                    [then]
                                        {VARIABLE can_take_this_weapon 1}
                                    [/then]
                                [/if]
                            {NEXT attack_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit cannot use otherworldly essences."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=thunderstick
                            {VARIABLE can_take_this_weapon 0}
                            {FOREACH unit.attack attack_number}
                                [if]
                                    [variable]
                                        name=unit.attack[$attack_number].name
                                        equals="thunderstick"
                                    [/variable]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="dragonstaff"
                                        [/variable]
                                    [/or]
                                    [not]
                                        [variable]
                                            name=unit.type
                                            contains="doppelganger"
                                        [/variable]
                                    [/not]
                                    [then]
                                        {VARIABLE can_take_this_weapon 1}
                                    [/then]
                                [/if]
                            {NEXT attack_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit cannot use weapons that are so advanced."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=spear
                            {VARIABLE can_take_this_weapon 0}
                            {FOREACH unit.attack attack_number}
                                [if]
                                    [variable]
                                        name=unit.attack[$attack_number].name
                                        equals="spear"
                                    [/variable]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="javelin"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="lance"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="spike"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="pike"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="trident"
                                        [/variable]
                                    [/or]
                                    [or]
                                        [variable]
                                            name=unit.attack[$attack_number].name
                                            equals="trident-blade"
                                        [/variable]
                                    [/or]
                                    [not]
                                        [variable]
                                            name=unit.type
                                            contains="doppelganger"
                                        [/variable]
                                    [/not]
                                    [then]
                                        {VARIABLE can_take_this_weapon 1}
                                    [/then]
                                [/if]
                            {NEXT attack_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit cannot use spears. Seems to prefer more advanced weapons."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=limited
                            {VARIABLE can_take_this_weapon 1}
                            {FOREACH unit.object thing_number}
                                [if]
                                    [variable]
                                        name=unit.modifications.object[$thing_number].number
                                        equals=$item_list.object[$item_number].number
                                    [/variable]
                                    [then]
                                        {VARIABLE can_take_this_weapon 0}
                                    [/then]
                                [/if]
                            {NEXT thing_number}
                            [if]
                                [variable]
                                    name=can_take_this_weapon
                                    equals=0
                                [/variable]
                                [then]
                                    {VARIABLE can_take _"This unit already has this item."}
                                [/then]
                            [/if]
                        [/case]
                        [case]
                            value=gem
                            [remove_item]
                                x,y=$x1,$y1
                                image=$item_list.object[$item_number].image
                            [/remove_item]
                            [insert_tag]
                                name=object
                                variable=item_list.object[$item_number]
                            [/insert_tag]
                            {VARIABLE been_a_gem 1}
                            [switch]
                                variable=item_list.object[$item_number].number
                                {GEM_CASE 521 obsidians}
                                {GEM_CASE 522 topazes}
                                {GEM_CASE 523 opals}
                                {GEM_CASE 524 pearls}
                                {GEM_CASE 525 diamonds}
                                {GEM_CASE 526 rubies}
                                {GEM_CASE 527 emeralds}
                                {GEM_CASE 528 amethysts}
                                {GEM_CASE 529 sapphires}
                                {GEM_CASE 530 black_pearls}
                            [/switch]
                            {CLEAR_VARIABLE items[$l]}
                            {VARIABLE_OP l add -1}
                            {VARIABLE picked 1}
                        [/case]
                        [case]
                            value=gold
                            [remove_item]
                                x,y=$x1,$y1
                                image=$item_list.object[$item_number].image
                            [/remove_item]
                            {VARIABLE been_a_gem 1}
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    equals=24
                                [/variable]
                                [then]
                                    [gold]
                                        side=$side_number
                                        amount=200
                                    [/gold]
                                [/then]
                            [/if]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    equals=37
                                [/variable]
                                [then]
                                    [gold]
                                        side=$side_number
                                        amount=100
                                    [/gold]
                                [/then]
                            [/if]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    equals=44
                                [/variable]
                                [then]
                                    [gold]
                                        side=$side_number
                                        amount=50
                                    [/gold]
                                [/then]
                            [/if]
                            {CLEAR_VARIABLE items[$l]}
                            {VARIABLE_OP l add -1}
                            {VARIABLE picked 1}
                        [/case]
                        [case]
                            value=potion
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    equals=106
                                [/variable]
                                [then]
                                    [if]
                                        [variable]
                                            name=unit.variables.healed_this_turn
                                            equals=yes
                                        [/variable]
                                        [then]
                                            {VARIABLE can_take _"This unit had already a healing potion in this turn."}
                                        [/then]
                                        [else]
                                            {VARIABLE fully_healed 1}
                                        [/else]
                                    [/if]
                                [/then]
                            [/if]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    equals=43
                                [/variable]
                                [or]
                                    [variable]
                                        name=item_list.object[$item_number].number
                                        equals=205
                                    [/variable]
                                [/or]
                                [then]
                                    [if]
                                        [variable]
                                            name=unit.variables.healed_this_turn
                                            equals=yes
                                        [/variable]
                                        [then]
                                            {VARIABLE can_take _"This unit had already a healing potion in this turn."}
                                        [/then]
                                        [else]
                                            {VARIABLE healed 1}
                                        [/else]
                                    [/if]
                                [/then]
                            [/if]
                        [/case]
                    [/switch]
                    [if]
                        [variable]
                            name=been_a_gem
                            not_equals=1
                        [/variable]
                        [then]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].sort
                                    contains="potion"
                                [/variable]
                                [or]
                                    [variable]
                                        name=item_list.object[$item_number].sort
                                        equals="limited"
                                    [/variable]
                                [/or]
                                [then]
                                    {VARIABLE name_unequipped _"irrelevant"}
                                [/then]
                                [else]
                                    {VARIABLE name_unequipped _"none"}
                                    {FOREACH unit.modifications.object ot}
                                        [if]
                                            [variable]
                                                name=unit.modifications.object[$ot].sort
                                                equals=$item_list.object[$item_number].sort
                                            [/variable]
                                            [then]
                                                {VARIABLE name_unequipped $unit.modifications.object[$ot].name}
                                            [/then]
                                        [/if]
                                    {NEXT ot}
                                [/else]
                            [/if]
                            {VARIABLE in_foreach "item_storage.$item_list.object[$item_number].sort"}
                            [set_variable]
                                name=in_foreach_length
                                to_variable=$in_foreach|.length
                            [/set_variable]
                            {VARIABLE identical_count 0}
                            {VARIABLE ot 0}
                            [while]
                                [variable]
                                    name=ot
                                    less_than=$in_foreach_length
                                [/variable]
                                [do]
                                    [if]
                                        [variable]
                                            name=$in_foreach|[$ot].type
                                            equals=$item_list.object[$item_number].number
                                        [/variable]
                                        [then]
                                            {VARIABLE_OP identical_count add 1}
                                        [/then]
                                    [/if]
                                    [set_variable]
                                        name=ot
                                        add=1
                                    [/set_variable]
                                [/do]
                            [/while]
                            {CLEAR_VARIABLE in_foreach,in_foreach_length,ot}
                            [if]
                                [variable]
                                    name=can_take
                                    equals=1
                                [/variable]
                                [then]
                                    [message]
                                        speaker=narrator
                                        caption=$item_list.object[$item_number].name
                                        message= _"$item_list.object[$item_number].description
<span color='#808080'><i>$item_list.object[$item_number].flavour</i></span>

Item of the same type that will be unequipped: $name_unequipped
Take this item?"
                                        image=$item_list.object[$item_number].image
                                        side_for=$side_number
                                        [option]
                                            message=_"Take it."
                                            [command]
                                                {VARIABLE shall_take 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            message=_"Store it. Currently having $identical_count such items stored."
                                            [show_if]
                                                [not]
                                                    [variable]
                                                        name=no_inventory
                                                        equals=yes
                                                    [/variable]
                                                [/not]
                                            [/show_if]
                                            [command]
                                                {VARIABLE shall_take 0}
                                                {INSERT_INTO_ITEMS item_storage $item_list.object[$item_number].sort| $item_list.object[$item_number].number}
                                                [remove_item]
                                                    x,y=$x1,$y1
                                                    image=$item_list.object[$item_number].image
                                                [/remove_item]
                                                {CLEAR_VARIABLE items[$k]}
                                                {VARIABLE_OP l add -1}
                                                {VARIABLE picked 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            message=_"Smash it to get random gem."
                                            [show_if]
                                                [variable]
                                                    name=item_list.object[$item_number].sort
                                                    not_equals="limited"
                                                [/variable]
                                                [and]
                                                    [not]
                                                        [variable]
                                                            name=item_list.object[$item_number].sort
                                                            contains="potion"
                                                        [/variable]
                                                    [/not]
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [remove_item]
                                                    x,y=$x1,$y1
                                                    image=$item_list.object[$item_number].image
                                                [/remove_item]
                                                {VARIABLE_OP item_type rand (521,521,521,521,521,521,521,521,521,521,522,522,522,522,522,522,523,523,523,523,523,524,524,524,524,524,524)}
                                                [if]
                                                    [variable]
                                                        name=item_type
                                                        equals=524
                                                    [/variable]
                                                    [then]
#ifdef LOTI_LOW_DROPS
                                                        {VARIABLE_OP item_type rand (524,524,524,524,524,524,524,524,524,525,525,525,525,526,526,527,527)}
#else
                                                        {VARIABLE_OP item_type rand (524,524,524,524,524,524,524,524,524,525,525,525,525,525,525,526,526,526,526,527,527,527,527,527,527)}
#endif
                                                        [if]
                                                            [variable]
                                                                name=item_type
                                                                equals=527
                                                            [/variable]
                                                            [then]
                                                                {VARIABLE_OP item_type rand (530,530,529,529,529,528,528,528,528,528,527,527,527,527,527,527,527,527)}
                                                            [/then]
                                                        [/if]
                                                    [/then]
                                                [/if]
                                                {FOREACH item_list.object cv}
                                                    [if]
                                                        [variable]
                                                            name=item_list.object[$cv].number
                                                            equals=$item_type
                                                        [/variable]
                                                        [then]
                                                            {VARIABLE gem_number $cv}
                                                        [/then]
                                                    [/if]
                                                {NEXT cv}
                                                [insert_tag]
                                                    name=object
                                                    variable=item_list.object[$gem_number]
                                                [/insert_tag]
                                                {VARIABLE been_a_gem 1}
                                                [switch]
                                                    variable=item_list.object[$gem_number].number
                                                    {GEM_CASE 521 obsidians}
                                                    {GEM_CASE 522 topazes}
                                                    {GEM_CASE 523 opals}
                                                    {GEM_CASE 524 pearls}
                                                    {GEM_CASE 525 diamonds}
                                                    {GEM_CASE 526 rubies}
                                                    {GEM_CASE 527 emeralds}
                                                    {GEM_CASE 528 amethysts}
                                                    {GEM_CASE 529 sapphires}
                                                    {GEM_CASE 530 black_pearls}
                                                [/switch]
                                                {CLEAR_VARIABLE item_type,gem_number}
                                                {CLEAR_VARIABLE items[$l]}
                                                {VARIABLE_OP l add -1}
                                                {VARIABLE picked 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            message=_"Leave it on the ground."
                                            [command]
                                                {VARIABLE shall_take 0}
                                            [/command]
                                        [/option]
                                    [/message]
                                [/then]
                                [else]
                                    {VARIABLE shall_take 0}
                                    [message]
                                        speaker=narrator
                                        caption=$item_list.object[$item_number].name
                                        message="$item_list.object[$item_number].description
<span color='red'>$can_take </span>"
                                        image=$item_list.object[$item_number].image
                                        side_for=$side_number
                                        [option]
                                            message=_"Store it. Currently having $identical_count such items stored."
                                            [show_if]
                                                [not]
                                                    [variable]
                                                        name=no_inventory
                                                        equals=yes
                                                    [/variable]
                                                [/not]
                                            [/show_if]
                                            [command]
                                                {INSERT_INTO_ITEMS item_storage $item_list.object[$item_number].sort| $item_list.object[$item_number].number}
                                                [remove_item]
                                                    x,y=$x1,$y1
                                                    image=$item_list.object[$item_number].image
                                                [/remove_item]
                                                {CLEAR_VARIABLE items[$k]}
                                                {VARIABLE_OP l add -1}
                                                {VARIABLE picked 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            message=_"Smash it to get random gem."
                                            [command]
                                                [remove_item]
                                                    x,y=$x1,$y1
                                                    image=$item_list.object[$item_number].image
                                                [/remove_item]
                                                {VARIABLE_OP item_type rand (521,521,521,521,521,521,521,521,521,521,522,522,522,522,522,522,523,523,523,523,523,524,524,524,524,524,524)}
                                                [if]
                                                    [variable]
                                                        name=item_type
                                                        equals=524
                                                    [/variable]
                                                    [then]
#ifdef LOTI_LOW_DROPS
                                                        {VARIABLE_OP item_type rand (524,524,524,524,524,524,524,524,524,525,525,525,525,526,526,527,527)}
#else
                                                        {VARIABLE_OP item_type rand (524,524,524,524,524,524,524,524,524,525,525,525,525,525,525,526,526,526,526,527,527,527,527,527,527)}
#endif
                                                        [if]
                                                            [variable]
                                                                name=item_type
                                                                equals=527
                                                            [/variable]
                                                            [then]
                                                                {VARIABLE_OP item_type rand (530,530,529,529,529,528,528,528,528,528,527,527,527,527,527,527,527,527)}
                                                            [/then]
                                                        [/if]
                                                    [/then]
                                                [/if]
                                                {FOREACH item_list.object cv}
                                                    [if]
                                                        [variable]
                                                            name=item_list.object[$cv].number
                                                            equals=$item_type
                                                        [/variable]
                                                        [then]
                                                            {VARIABLE gem_number $cv}
                                                        [/then]
                                                    [/if]
                                                {NEXT cv}
                                                [insert_tag]
                                                    name=object
                                                    variable=item_list.object[$gem_number]
                                                [/insert_tag]
                                                {VARIABLE been_a_gem 1}
                                                [switch]
                                                    variable=item_list.object[$gem_number].number
                                                    {GEM_CASE 521 obsidians}
                                                    {GEM_CASE 522 topazes}
                                                    {GEM_CASE 523 opals}
                                                    {GEM_CASE 524 pearls}
                                                    {GEM_CASE 525 diamonds}
                                                    {GEM_CASE 526 rubies}
                                                    {GEM_CASE 527 emeralds}
                                                    {GEM_CASE 528 amethysts}
                                                    {GEM_CASE 529 sapphires}
                                                    {GEM_CASE 530 black_pearls}
                                                [/switch]
                                                {CLEAR_VARIABLE item_type,gem_number}
                                                {CLEAR_VARIABLE items[$l]}
                                                {VARIABLE_OP l add -1}
                                                {VARIABLE picked 1}
                                            [/command]
                                        [/option]
                                        [option]
                                            message=_"Leave it on the ground."
                                            [command]
                                            [/command]
                                        [/option]
                                    [/message]
                                [/else]
                            [/if]
                            {CLEAR_VARIABLE identical_count}
                            [if]
                                [variable]
                                    name=shall_take
                                    equals=1
                                [/variable]
                                [then]
                                    [remove_item]
                                        x,y=$x1,$y1
                                        image=$item_list.object[$item_number].image
                                    [/remove_item]
                                    [if]
                                        [variable]
                                            name=item_list.object[$item_number].sort
                                            contains=potion
                                        [/variable]
                                        [or]
                                            [variable]
                                                name=item_list.object[$item_number].sort
                                                equals=limited
                                            [/variable]
                                        [/or]
                                        [else]
                                            {REMOVE_OBJECT $item_list.object[$item_number].sort}
                                        [/else]
                                    [/if]
                                    [if]
                                        [variable]
                                            name=item_list.object[$item_number].number
                                            greater_than=530
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=item_list.object[$item_number].number
                                                less_than_equal_to=600
                                            [/variable]
                                        [/and]
                                        [then]
                                            [if]
                                                [variable]
                                                    name=item_list.object[$item_number].sort
                                                    equals=helm
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=item_list.object[$item_number].sort
                                                        equals=boots
                                                    [/variable]
                                                [/or]
                                                [or]
                                                    [variable]
                                                        name=item_list.object[$item_number].sort
                                                        equals=gauntlets
                                                    [/variable]
                                                [/or]
                                                [then]
                                                    {VARIABLE former_defence $item_list.object[$item_number].defence}
                                                    {VARIABLE_OP item_list.object[$item_number].defence divide 3}
                                                [/then]
                                            [/if]
                                        [/then]
                                    [/if]
                                    [set_variables]
                                        name=added_object
                                        to_variable=item_list.object[$item_number]
                                    [/set_variables]
                                    [if]
                                        [variable]
                                            name=added_object.flavour
                                            equals=""
                                        [/variable]
                                        [else]
                                            [set_variable]
                                                name=added_object.description
                                                value="$item_list.object[$item_number].description
<span color='#808080'><i>$added_object.flavour</i></span>"
                                            [/set_variable]
                                        [/else]
                                    [/if]
                                    [insert_tag]
                                        name=object
                                        variable=added_object
                                    [/insert_tag]
                                    {CLEAR_VARIABLE added_object}
                                    [if]	#A few hacks to check some items that need some special code when picked up
                                        [variable]
                                            name=item_list.object[$item_number].number
                                            equals=16
                                        [/variable]
                                        [then]
                                            [store_unit]
                                                [filter]
                                                    x,y=$x1,$y1
                                                [/filter]
                                                variable=advanced
                                            [/store_unit]
                                            {CLEAR_VARIABLE advanced.variables.starving}
                                            [unstore_unit]
                                                variable=advanced
                                                find_vacant=no
                                            [/unstore_unit]
                                            {CLEAR_VARIABLE advanced}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
                                            name=item_list.object[$item_number].number
                                            equals=89
                                        [/variable]
                                        [then]
                                            [store_unit]
                                                [filter]
                                                    x,y=$x1,$y1
                                                [/filter]
                                                variable=advanced
                                            [/store_unit]
                                            [set_variables]
                                                name=advanced.modifications.trait[$advanced.modifications.trait.length]
                                                mode=replace
                                                [value]
                                                    id=fearless
                                                    male_name= _ "fearless"
                                                    female_name= _ "female^fearless"
                                                    description= _ "Fights normally during unfavorable times of day/night"
                                                [/value]
                                            [/set_variables]
                                            [unstore_unit]
                                                variable=advanced
                                                find_vacant=no
                                            [/unstore_unit]
                                            {CLEAR_VARIABLE advanced}
                                        [/then]
                                    [/if]
                                    {CLEAR_VARIABLE items[$k]}
                                    {VARIABLE_OP l add -1}
                                    {VARIABLE picked 1}
                                    [if]
                                        [variable]
                                            name=item_list.object[$item_number].number
                                            greater_than=530
                                        [/variable]
                                        [and]
                                            [variable]
                                                name=item_list.object[$item_number].number
                                                less_than_equal_to=600
                                            [/variable]
                                        [/and]
                                        [then]
                                            [if]
                                                [variable]
                                                    name=item_list.object[$item_number].sort
                                                    equals=helm
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=item_list.object[$item_number].sort
                                                        equals=boots
                                                    [/variable]
                                                [/or]
                                                [or]
                                                    [variable]
                                                        name=item_list.object[$item_number].sort
                                                        equals=gauntlets
                                                    [/variable]
                                                [/or]
                                                [then]
                                                    {VARIABLE item_list.object[$item_number].defence $former_defence}
                                                    {CLEAR_VARIABLE former_defence}
                                                [/then]
                                            [/if]
                                        [/then]
                                    [/if]
                                    {UPDATE_STATS}
                                [/then]
                            [/if]
                            {CLEAR_VARIABLE shall_take}
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    greater_than=530
                                [/variable]
                                [and]
                                    [variable]
                                        name=item_list.object[$item_number].number
                                        less_than_equal_to=560
                                    [/variable]
                                [/and]
                                [then]
                                    {VARIABLE item_list.object[$item_number].sort armourword}
                                [/then]
                            [/if]
                            [if]
                                [variable]
                                    name=item_list.object[$item_number].number
                                    greater_than=560
                                [/variable]
                                [and]
                                    [variable]
                                        name=item_list.object[$item_number].number
                                        less_than_equal_to=600
                                    [/variable]
                                [/and]
                                [then]
                                    {VARIABLE item_list.object[$item_number].sort weaponword}
                                [/then]
                            [/if]
                        [/then]
                    [/if]
                    [set_variable]
                        name=k
                        value=$l
                    [/set_variable]
                [/then]
            [/if]
        {NEXT k}
        {CLEAR_VARIABLE been_a_gem}
        {FOREACH items_to_add i}
            [if]
                [variable]
                    name=$items_to_add[$i].sort
                    contains=potion
                [/variable]
                [or]
                    [variable]
                        name=$items_to_add[$i].sort
                        equals=limited
                    [/variable]
                [/or]
                [else]
                    [set_variables]
                        name=items
                        mode=append
                        [value]
                            x=$x1
                            y=$y1
                            type=$items_to_add[$i].type
                            sort=$items_to_add[$i].sort
                        [/value]
                    [/set_variables]
                [/else]
            [/if]
        {NEXT i}
        [if]
            [variable]
                name=picked
                equals=0
            [/variable]
            [or]
                [variable]
                    name=been_a_gem
                    equals=1
                [/variable]
            [/or]
            [then]
                [if]
                    [variable]
                        name=been_a_gem
                        equals=1
                    [/variable]
                    [then]
                        [fire_event]
                            name=item_pick
                            [primary_unit]
                                id=$unit.id
                            [/primary_unit]
                        [/fire_event]
                    [/then]
                    [else]
                        [allow_undo]
                        [/allow_undo]
                    [/else]
                [/if]
            [/then]
            [else]
                [fire_event]	#Just for the case if collecting items was meant to be used for something
                    name=item picked
                    [primary_unit]
                        id=$unit.id
                    [/primary_unit]
                [/fire_event]
            [/else]
        [/if]
        {CLEAR_VARIABLE items_to_add}
        {CLEAR_VARIABLE picked}
        {CLEAR_VARIABLE l}
        {CLEAR_VARIABLE item_number,healed,fully_healed,name_unequipped}
        {CLEAR_VARIABLE can_take,can_take_this_weapon}
    [/event]
#enddef
