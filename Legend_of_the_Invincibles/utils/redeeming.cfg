#textdomain wesnoth-loti
#define WEAPON_SPECIAL_REDEEM_1
    [damage]
        id=redeem 1
        name= _ "redeem (1)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any level 0 or level 1 target, level 2 targets are absorbed with a 50% chance and level 3 targets are absorbed with a 25% chance. Experience is not gained. 6 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_2
    [damage]
        id=redeem 2
        name= _ "redeem (2)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 2 or lower, level 3 targets are absorbed with a 50% chance and level 4 targets are absorbed with a 25% chance. Experience is not gained. 8 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_3
    [damage]
        id=redeem 3
        name= _ "redeem (3)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 2 or lower, level 3 targets are absorbed with a 75% chance, level 4 targets are absorbed with a 50% chance, level 5 targets are absorbed with a 25% chance and the chance to absorb level 6 targets is only 10%. Experience is not gained. 10 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_4
    [damage]
        id=redeem 4
        name= _ "redeem (4)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 3 or lower, level 4 targets are absorbed with a 75% chance, level 5 targets are absorbed with a 50% chance, level 6 targets are absorbed with a 25% chance and the chance to absorb level 7 targets is only 10%. Experience is not gained. 13 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_5
    [damage]
        id=redeem 5
        name= _ "redeem (5)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 3 or lower, level 4 targets are absorbed with a 75% chance, level 5 targets are absorbed with a 50% chance, level 6 targets are absorbed with a 25% chance and the chance to absorb level 7 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 0 or less, 50% chance if their level is 1 and 25% chance if their level is 2. Experience is not gained. 17 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_6
    [damage]
        id=redeem 6
        name= _ "redeem (6)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 4 or lower, level 5 targets are absorbed with a 75% chance, level 6 targets are absorbed with a 50% chance, level 7 targets are absorbed with a 25% chance and the chance to absorb level 8 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 1 or less, 50% chance if their level is 2 and 25% chance if their level is 3. Experience is not gained. 22 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_7
    [damage]
        id=redeem 7
        name= _ "redeem (7)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 5 or lower, level 6 targets are absorbed with a 75% chance, level 7 targets are absorbed with a 50% chance, level 8 targets are absorbed with a 25% chance and the chance to absorb level 9 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 1 or less, 50% chance if their level is 2 and 25% chance if their level is 3. Experience is not gained. 29 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_8
    [damage]
        id=redeem 8
        name= _ "redeem (8)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 6 or lower, level 7 targets are absorbed with a 75% chance, level 8 targets are absorbed with a 50% chance, level 9 targets are absorbed with a 25% chance and the chance to absorb level 10 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 2 or less, 50% chance if their level is 3 and 25% chance if their level is 4. Experience is not gained. 38 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_9
    [damage]
        id=redeem 9
        name= _ "redeem (9)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 5 or lower, level 6 targets are absorbed with a 90% chance, level 7 targets are absorbed with a 60% chance, level 8 targets are absorbed with a 40% chance, level 9 targets are absorbed with a 30% chance, level 10 targets are absorbed with a 20% chance and the chance to absorb level 11 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 2 or less, 50% chance if their level is 3 and 25% chance if their level is 4. Experience is not gained. 50 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_10
    [damage]
        id=redeem 10
        name= _ "redeem (10)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 6 or lower, level 7 targets are absorbed with a 90% chance, level 8 targets are absorbed with a 60% chance, level 9 targets are absorbed with a 40% chance, level 10 targets are absorbed with a 30% chance, level 11 targets are absorbed with a 20% chance and the chance to absorb level 12 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 3 or less, 50% chance if their level is 4 and 25% chance if their level is 5. Experience is not gained. 66 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_11
    [damage]
        id=redeem 11
        name= _ "redeem (11)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 7 or lower, level 8 targets are absorbed with a 90% chance, level 9 targets are absorbed with a 60% chance, level 10 targets are absorbed with a 40% chance, level 11 targets are absorbed with a 30% chance, level 12 targets are absorbed with a 20% chance and the chance to absorb level 13 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 3 or less, 50% chance if their level is 4 and 25% chance if their level is 5. Experience is not gained. 88 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_12
    [damage]
        id=redeem 12
        name= _ "redeem (12)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 6 or lower, level 7 targets are absorbed with a 90% chance, level 8 targets are absorbed with an 80% chance, level 9 targets are absorbed with a 70% chance, level 10 targets are absorbed with a 60% chance, level 11 targets are absorbed with a 50%, level 12 targets are absorbed with a 40%, level 13 targets are absorbed with a 30% chance, level 14 targets are absorbed with a 20% and the chance to absorb level 15 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 4 or less, 50% chance if their level is 5 and 25% chance if their level is 6. Experience is not gained. 117 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_13
    [damage]
        id=redeem 13
        name= _ "redeem (13)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 7 or lower, level 8 targets are absorbed with a 90% chance, level 9 targets are absorbed with an 80% chance, level 10 targets are absorbed with a 70% chance, level 11 targets are absorbed with a 60% chance, level 12 targets are absorbed with a 50%, level 13 targets are absorbed with a 40%, level 14 targets are absorbed with a 30% chance, level 15 targets are absorbed with a 20% and the chance to absorb level 16 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 4 or less, 50% chance if their level is 5 and 25% chance if their level is 6. Experience is not gained. 156 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_14
    [damage]
        id=redeem 14
        name= _ "redeem (14)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 8 or lower, level 9 targets are absorbed with a 90% chance, level 10 targets are absorbed with an 80% chance, level 11 targets are absorbed with a 70% chance, level 12 targets are absorbed with a 60% chance, level 13 targets are absorbed with a 50%, level 14 targets are absorbed with a 40%, level 15 targets are absorbed with a 30% chance, level 16 targets are absorbed with a 20% and the chance to absorb level 17 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 5 or less, 50% chance if their level is 6 and 25% chance if their level is 7. Experience is not gained. 208 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_15
    [damage]
        id=redeem 15
        name= _ "redeem (15)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 9 or lower, level 10 targets are absorbed with a 90% chance, level 11 targets are absorbed with an 80% chance, level 12 targets are absorbed with a 70% chance, level 13 targets are absorbed with a 60% chance, level 14 targets are absorbed with a 50%, level 15 targets are absorbed with a 40%, level 16 targets are absorbed with a 30% chance, level 17 targets are absorbed with a 20% and the chance to absorb level 18 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 5 or less, 50% chance if their level is 7 and 25% chance if their level is 8. Experience is not gained. 277 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_16
    [damage]
        id=redeem 16
        name= _ "redeem (16)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 10 or lower, level 11 targets are absorbed with a 90% chance, level 12 targets are absorbed with an 80% chance, level 13 targets are absorbed with a 70% chance, level 14 targets are absorbed with a 60% chance, level 15 targets are absorbed with a 50%, level 16 targets are absorbed with a 40%, level 17 targets are absorbed with a 30% chance, level 18 targets are absorbed with a 20% and the chance to absorb level 19 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 6 or less, 50% chance if their level is 8 and 25% chance if their level is 9. Experience is not gained. 369 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_17
    [damage]
        id=redeem 17
        name= _ "redeem (17)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 11 or lower, level 12 targets are absorbed with a 90% chance, level 13 targets are absorbed with an 80% chance, level 14 targets are absorbed with a 70% chance, level 15 targets are absorbed with a 60% chance, level 16 targets are absorbed with a 50%, level 17 targets are absorbed with a 40%, level 18 targets are absorbed with a 30% chance, level 19 targets are absorbed with a 20% and the chance to absorb level 20 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 6 or less, 50% chance if their level is 9 and 25% chance if their level is 10. Experience is not gained. 492 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_18
    [damage]
        id=redeem 18
        name= _ "redeem (18)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 12 or lower, level 13 targets are absorbed with a 90% chance, level 14 targets are absorbed with an 80% chance, level 15 targets are absorbed with a 70% chance, level 16 targets are absorbed with a 60% chance, level 17 targets are absorbed with a 50%, level 18 targets are absorbed with a 40%, level 19 targets are absorbed with a 30% chance, level 20 targets are absorbed with a 20% and the chance to absorb level 21 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 7 or less, 50% chance if their level is 10 and 25% chance if their level is 11. Experience is not gained. 656 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_19
    [damage]
        id=redeem 19
        name= _ "redeem (19)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 13 or lower, level 14 targets are absorbed with a 90% chance, level 15 targets are absorbed with an 80% chance, level 16 targets are absorbed with a 70% chance, level 17 targets are absorbed with a 60% chance, level 18 targets are absorbed with a 50%, level 19 targets are absorbed with a 40%, level 20 targets are absorbed with a 30% chance, level 21 targets are absorbed with a 20% and the chance to absorb level 22 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 7 or less, 50% chance if their level is 11 and 25% chance if their level is 12. Experience is not gained. 874 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef
#define WEAPON_SPECIAL_REDEEM_20
    [damage]
        id=redeem 20
        name= _ "redeem (20)"
        description= _ "The target of this attack is fully absorbed into the attacker's soul, a much better place than the world he was taken from. The attacker may get new advancements unlocked thanks to this. This attack kills any target of level 14 or lower, level 15 targets are absorbed with a 90% chance, level 16 targets are absorbed with an 80% chance, level 17 targets are absorbed with a 70% chance, level 18 targets are absorbed with a 60% chance, level 19 targets are absorbed with a 50%, level 20 targets are absorbed with a 40%, level 21 targets are absorbed with a 30% chance, level 22 targets are absorbed with a 20% and the chance to absorb level 23 targets is only 10%. Targets adjacent to the target are absorbed with a 100% chance if their level is 8 or less, 50% chance if their level is 12 and 25% chance if their level is 14. Experience is not gained. 1165 redeems are required to get new advancements. This attack may be used only once per three turns."
    [/damage]
#enddef

#define REDEEM_COOLDOWN
    [store_unit]
        [filter]
            id=$unit.id
        [/filter]
        variable=redeemer
        kill=no
    [/store_unit]
    {VARIABLE redeemer.variables.redeem_wait 2}
    {VARIABLE redeemer.status.redeem_waiting yes}
    {FOREACH redeemer.attack l}
        [if]
            [variable]
                name=redeemer.attack[$l].name
                equals=redeem
            [/variable]
            [then]
                {VARIABLE redeemer.attack[$l].attack_weight "0"}
            [/then]
        [/if]
    {NEXT l}
    [unstore_unit]
        variable=redeemer
        {COLOR_HEAL}
        find_vacant=no
    [/unstore_unit]
    {CLEAR_VARIABLE redeemer}
#enddef

#define REDEEM_SURE_LEVEL LEVEL
    [if]
        [variable]
            name=second_unit.level
            less_than_equal_to={LEVEL}
        [/variable]
        [then]
            {VARIABLE redeemed 1}
        [/then]
    [/if]
#enddef

#define REDEEM_UNSURE_LEVEL LEVEL PROBABILITY
    [if]
        [variable]
            name=second_unit.level
            equals={LEVEL}
        [/variable]
        [and]
            [variable]
                name=luck
                greater_than={PROBABILITY}
            [/variable]
        [/and]
        [then]
            {VARIABLE redeemed 1}
        [/then]
    [/if]
#enddef

#define REDEEMING

    [event]
        name=attacker hits
        first_time_only=no
        [filter_attack]
            name=redeem
        [/filter_attack]
        [set_variables]
            name=redeem_level_raw
            mode=replace
            [split]
                list=$weapon.specials.damage.id
                key=identified
                separator=" "
                remove_empty=yes
            [/split]
        [/set_variables]
        {VARIABLE redeem_level $redeem_level_raw[1].identified}
        {VARIABLE redeemed_in_total 0}
        [if]
            [variable]
                name=redeem_level
                greater_than=4
            [/variable]
            [then]
                {VARIABLE_OP redeem_level sub 4}
                [set_variable]
                    name=redeem_level
                    divide=2
                    round=ceil
                [/set_variable]
                [store_unit]
                    [filter]
                        [filter_adjacent]
                            id=$second_unit.id
                        [/filter_adjacent]
                        [not]
                            [filter_wml]
                                [variables]
                                    unredeemable=yes
                                [/variables]
                            [/filter_wml]
                        [/not]
                        side=$enemy_sides
                    [/filter]
                    variable=redeem_store
                    kill=no
                [/store_unit]
                {FOREACH redeem_store i}
                    {VARIABLE_OP luck rand (0,1,2,3)}
                    {VARIABLE redeemed 0}
                    [if]
                        [variable]
                            name=redeem_store[$i].level
                            less_than_equal_to=$redeem_level
                        [/variable]
                        [then]
                            {VARIABLE redeemed 1}
                        [/then]
                    [/if]
                    {VARIABLE redeem_level_higher "$($redeem_level+1)"}
                    [if]
                        [variable]
                            name=redeem_store[$i].level
                            equals=$redeem_level_higher
                        [/variable]
                        [and]
                            [variable]
                                name=luck
                                greater_than=1
                            [/variable]
                        [/and]
                        [then]
                            {VARIABLE redeemed 1}
                        [/then]
                    [/if]
                    {VARIABLE redeem_level_higher "$($redeem_level+2)"}
                    [if]
                        [variable]
                            name=redeem_store[$i].level
                            equals=$redeem_level_higher
                        [/variable]
                        [and]
                            [variable]
                                name=luck
                                greater_than=2
                            [/variable]
                        [/and]
                        [then]
                            {VARIABLE redeemed 1}
                        [/then]
                    [/if]
                    [if]
                        [variable]
                            name=redeemed
                            equals=1
                        [/variable]
                        [then]
                            [kill]
                                id=$redeem_store[$i].id
                                animate=no
                                fire_event=yes
                            [/kill]
                            {VARIABLE_OP redeemed_in_total add 1}
                        [/then]
                    [/if]
                {NEXT i}
                {CLEAR_VARIABLE redeem_level_higher,redeem_store}
                {VARIABLE redeem_level $redeem_level_raw[1].identified}
            [/then]
        [/if]
        [if]
            [variable]
                name=redeem_level
                less_than_equal_to=2
            [/variable]
            [then]
                {VARIABLE_OP luck rand (0,1,2,3)}
                {VARIABLE redeemed 0}
                {REDEEM_SURE_LEVEL $redeem_level}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+1)" 1}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+2)" 2}
            [/then]
        [/if]
        [if]
            [variable]
                name=redeem_level
                equals=5
            [/variable]
            [then]	#Redeem level 5's direct effect is identical to level 4, it has an extra AoE
                {VARIABLE redeem_level 4}
            [/then]
        [/if]
        [if]
            [variable]
                name=redeem_level
                less_than_equal_to=4
            [/variable]
            [and]
                [variable]
                    name=redeem_level
                    greater_than=2
                [/variable]
            [/and]
            [then]
                {VARIABLE_OP luck rand (1..20)}
                {VARIABLE redeemed 0}
                {REDEEM_SURE_LEVEL "$($redeem_level-1)"}
                {REDEEM_UNSURE_LEVEL "$redeem_level" 4}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+1)" 9}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+2)" 14}
                # Redeem level 5 was set to 4 to simplify calculations, so we should correct it back
                {VARIABLE redeem_level $redeem_level_raw[1].identified}
            [/then]
        [/if]
        [if]
            [variable]
                name=redeem_level
                less_than_equal_to=8
            [/variable]
            [and]
                [variable]
                    name=redeem_level
                    greater_than=5
                [/variable]
            [/and]
            [then]
                {VARIABLE_OP luck rand (1..20)}
                {VARIABLE redeemed 0}
                {REDEEM_SURE_LEVEL "$($redeem_level-2)"}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-1)" 4}
                {REDEEM_UNSURE_LEVEL "$redeem_level" 9}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+1)" 14}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+2)" 18}
            [/then]
        [/if]
        [if]
            [variable]
                name=redeem_level
                less_than_equal_to=11
            [/variable]
            [and]
                [variable]
                    name=redeem_level
                    greater_than=8
                [/variable]
            [/and]
            [then]
                {VARIABLE_OP luck rand (1..20)}
                {VARIABLE redeemed 0}
                {REDEEM_SURE_LEVEL "$($redeem_level-4)"}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-3)" 2}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-2)" 8}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-1)" 12}
                {REDEEM_UNSURE_LEVEL "$($redeem_level)" 14}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+1)" 16}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+2)" 18}
            [/then]
        [/if]
        [if]
            [variable]
                name=redeem_level
                greater_than=11
            [/variable]
            [then]
                {VARIABLE_OP luck rand (1..20)}
                {VARIABLE redeemed 0}
                {REDEEM_SURE_LEVEL "$($redeem_level-6)"}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-5)" 2}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-4)" 4}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-3)" 6}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-2)" 8}
                {REDEEM_UNSURE_LEVEL "$($redeem_level-1)" 10}
                {REDEEM_UNSURE_LEVEL "$redeem_level" 12}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+1)" 14}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+2)" 16}
                {REDEEM_UNSURE_LEVEL "$($redeem_level+3)" 18}
            [/then]
        [/if]
        [if]
            [variable]
                name=redeemed
                greater_than_equal_to=1
            [/variable]
            [not]
                [variable]
                    name=second_unit.variables.unredeemable
                    equals=yes
                [/variable]
            [/not]
            [then]
                [kill]
                    id=$second_unit.id
                    animate=yes
                    experience=no
                    fire_event=yes
                [/kill]
                [if]
                    [variable]
                        name=redeemed_in_total
                        greater_than_equal_to=1
                    [/variable]
                    [else]
                        [fire_event]
                            name=redeem
                            [primary_unit]
                                id=$unit.id
                            [/primary_unit]
                        [/fire_event]
                    [/else]
                [/if]
            [/then]
            [else]
                [floating_text]
                    text="Redeem failed!"
                    x,y=$x1,$y1
                [/floating_text]
            [/else]
        [/if]
        [if]
            [variable]
                name=redeemed_in_total
                greater_than_equal_to=1
            [/variable]
            [then]
                [if]
                    [variable]
                        name=redeemed
                        equals=0
                    [/variable]
                    [then]
                        {VARIABLE_OP redeemed_in_total sub 1}
                    [/then]
                [/if]
                [store_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    variable=redeemer
                    kill=no
                [/store_unit]
                [if]
                    [variable]
                        name=redeemer.variables.redeem_count
                        greater_than=0
                    [/variable]
                    [then]
                        {VARIABLE_OP redeemer.variables.redeem_count add $redeemed_in_total}
                    [/then]
                    [else]
                        {VARIABLE redeemer.variables.redeem_count $redeemed_in_total}
                    [/else]
                [/if]
                [unstore_unit]
                    variable=redeemer
                    find_vacant=no
                [/unstore_unit]
                [fire_event]
                    name=redeem
                    [primary_unit]
                        id=$unit.id
                    [/primary_unit]
                [/fire_event]
            [/then]
        [/if]
        {CLEAR_VARIABLE redeemed,luck,redeem_level,redeemed_in_total,redeem_level_raw}
        {REDEEM_COOLDOWN}
    [/event]

    [event]
        name=redeem
        first_time_only=no
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=redeemer
        [/store_unit]
        [if]
            [variable]
                name=redeemer.variables.max_redeem_count
                greater_than=0
            [/variable]
            [else]
                {VARIABLE redeemer.variables.max_redeem_count 5}
#ifver WESNOTH_VERSION >= 1.13.2
                {FOREACH redeemer.modifications.advancement i}
#else
                {FOREACH redeemer.modifications.advance i}
#endif
                    [if]
                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                            name=redeemer.modifications.advancement[$i].id
#else
                            name=redeemer.modifications.advance[$i].id
#endif
                            equals="lightning"
                        [/variable]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="fireblast"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="firestorm"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="arcticblast"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="blizzard"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="entropy"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="particlestorm"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="resist_fire"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="resist_cold"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="resist_arcane"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="resist_blade"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="resist_pierce"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="resist_impact"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="health"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="regeneration"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="absorb"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="heal"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="leadership"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="spirit"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="fire_penetrate"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="cold_penetrate"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="arcane_penetrate"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="blade_penetrate"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="impact_penetrate"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="pierce_penetrate"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="weapons"
                            [/variable]
                        [/or]
                        [or]
                            [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                name=redeemer.modifications.advancement[$i].id
#else
                                name=redeemer.modifications.advance[$i].id
#endif
                                equals="magic"
                            [/variable]
                        [/or]
                        [then]
                            {VARIABLE_OP redeemer.variables.max_redeem_count multiply 4}
                            [set_variable]
                                name=redeemer.variables.max_redeem_count
                                divide=3
                                round=floor
                            [/set_variable]
                        [/then]
                    [/if]
                {NEXT i}
            [/else]
        [/if]
        [if]
            [variable]
                name=redeemer.variables.redeem_count
                greater_than=0
            [/variable]
            [then]
                {VARIABLE_OP redeemer.variables.redeem_count add 1}
                [if]
                    [variable]
                        name=redeemer.variables.redeem_count
                        greater_than_equal_to=$redeemer.variables.max_redeem_count
                    [/variable]
                    [then]
#ifdef MULTIPLAYER
                        [if]
                            [variable]
                                name=side_number
                                equals=$redeemer.side
                            [/variable]
                            [then]
#endif
                                {VARIABLE upgrade_count 1}
                                {VARIABLE question.question "<span size='large'>Which new advancement path should our victorious unit get?</span>"}

#ifver WESNOTH_VERSION >= 1.13.2
                                {FOREACH redeemer.modifications.advancement i}
#else
                                {FOREACH redeemer.modifications.advance i}
#endif
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="lightning"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.lightning 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="fireblast"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.fireblast 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="firestorm"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.firestorm 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="blizzard"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.blizzard 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="arcticblast"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.arcticblast 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="entropy"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.entropy 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="particlestorm"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.particlestorm 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="resist_fire"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.resist_fire 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="resist_cold"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.resist_cold 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="resist_arcane"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.resist_arcane 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="resist_blade"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.resist_blade 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="resist_pierce"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.resist_pierce 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="resist_impact"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.resist_impact 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="health"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.health 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="regeneration"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.regeneration 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="absorb"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.absorb 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="heal"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.heal 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="spirit"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.spirit 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="leadership"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.leadership 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="fire_penetrate"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.fire_penetrate 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="cold_penetrate"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.cold_penetrate 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="arcane_penetrate"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.arcane_penetrate 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="blade_penetrate"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.blade_penetrate 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="impact_penetrate"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.impact_penetrate 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="pierce_penetrate"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.pierce_penetrate 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="weapons"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.weapons 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                    [if]
                                        [variable]
#ifver WESNOTH_VERSION >= 1.13.2
                                            name=redeemer.modifications.advancement[$i].id
#else
                                            name=redeemer.modifications.advance[$i].id
#endif
                                            equals="magic"
                                        [/variable]
                                        [then]
                                            {VARIABLE has.magic 1}
                                            {VARIABLE_OP upgrade_count add 1}
                                        [/then]
                                    [/if]
                                {NEXT i}
                                [if]
                                    [variable]
                                        name=has.fireblast
                                        equals=1
                                    [/variable]
                                    [else]
                                        {VARIABLE question[$question.length].question "Firestorm requires Fire Blast"}
                                        {VARIABLE question[$question.length].question "Resist fire requires Fire Blast"}
                                    [/else]
                                [/if]
                                [if]
                                    [variable]
                                        name=has.firestorm
                                        equals=1
                                    [/variable]
                                    [else]
                                        {VARIABLE question[$question.length].question "Fire resistance penetration requires Firestorm"}
                                    [/else]
                                [/if]
                                [if]
                                    [variable]
                                        name=has.arcticblast
                                        equals=1
                                    [/variable]
                                    [else]
                                        {VARIABLE question[$question.length].question "Blizzard requires Arctic Blast"}
                                        {VARIABLE question[$question.length].question "Resist cold requires Arctic Blast"}
                                    [/else]
                                [/if]
                                [if]
                                    [variable]
                                        name=has.blizzard
                                        equals=1
                                    [/variable]
                                    [else]
                                        {VARIABLE question[$question.length].question "Cold resistance penetration requires Blizzard"}
                                    [/else]
                                [/if]
                                [if]
                                    [variable]
                                        name=has.entropy
                                        equals=1
                                    [/variable]
                                    [and]
                                        [variable]
                                            name=has.blizzard
                                            equals=1
                                        [/variable]
                                    [/and]
                                    [and]
                                        [variable]
                                            name=has.firestorm
                                            equals=1
                                        [/variable]
                                    [/and]
                                    [else]
                                        {VARIABLE question[$question.length].question "Particle Storm Requires Blizzard, Firestorm and Entropy"}
                                    [/else]
                                [/if]
                                [if]
                                    [variable]
                                        name=has.health
                                        equals=1
                                    [/variable]
                                    [else]
                                        {VARIABLE question[$question.length].question "Resist blade requires health"}
                                        {VARIABLE question[$question.length].question "Resist pierce requires health"}
                                        {VARIABLE question[$question.length].question "Resist impact requires health"}
                                        {VARIABLE question[$question.length].question "Regeneration requires health"}
                                    [/else]
                                [/if]
                                [if]
                                    [variable]
                                        name=has.weapons
                                        equals=1
                                    [/variable]
                                    [else]
                                        {VARIABLE question[$question.length].question "Blade resistance penetration requires weapons"}
                                        {VARIABLE question[$question.length].question "Pierce resistance penetration requires weapons"}
                                        {VARIABLE question[$question.length].question "Impact resistance penetration requires weapons"}
                                    [/else]
                                [/if]
                                [if]
                                    [variable]
                                        name=has.health
                                        equals=1
                                    [/variable]
                                    [and]
                                        [variable]
                                            name=has.regeneration
                                            equals=1
                                        [/variable]
                                    [/and]
                                    [else]
                                        {VARIABLE question[$question.length].question "Absorb requires regeneration"}
                                    [/else]
                                [/if]
                                [if]
                                    [variable]
                                        name=has.weapons
                                        equals=1
                                    [/variable]
                                    [and]
                                        [variable]
                                            name=has.absorb
                                            equals=1
                                        [/variable]
                                    [/and]
                                    [else]
                                        {VARIABLE question[$question.length].question "Spiritual transformation requires absorb and weapons"}
                                    [/else]
                                [/if]
                                [if]
                                    [variable]
                                        name=has.magic
                                        equals=1
                                    [/variable]
                                    [else]
                                        {VARIABLE question[$question.length].question "Arcane resistance penetration requires magic"}
                                        {VARIABLE question[$question.length].question "Resist arcane requires magic"}
                                    [/else]
                                [/if]
                                [set_variable]
                                    name=question_asked
                                    [join]
                                        variable=question
                                        key=question
                                        separator="
"
                                        remove_empty=yes
                                    [/join]
                                [/set_variable]
                                {VARIABLE chose 0}
                                [message]
                                    speaker=narrator
                                    message= _ "$question_asked"
                                    [option]
                                        message=_ "Spiritual transformation (a very powerful combat technique)"
                                        [command]
                                            {VARIABLE chose spirit}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.absorb
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.spirit
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                            [and]
                                                [variable]
                                                    name=has.weapons
                                                    equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Particle Storm (a very powerful offensive spell)"
                                        [command]
                                            {VARIABLE chose particlestorm}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.blizzard
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.particlestorm
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                            [and]
                                                [variable]
                                                    name=has.firestorm
                                                    equals=1
                                                [/variable]
                                            [/and]
                                            [and]
                                                [variable]
                                                    name=has.entropy
                                                    equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Absorption (advancements that allow the unit heal from enemy attacks)"
                                        [command]
                                            {VARIABLE chose absorb}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.health
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.absorb
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                            [and]
                                                [variable]
                                                    name=has.regeneration
                                                    equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Firestorm (great damage and range)"
                                        [command]
                                            {VARIABLE chose firestorm}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.fireblast
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.firestorm
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Blizzard (slows a lot of units, moves them over the place)"
                                        [command]
                                            {VARIABLE chose blizzard}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.blizzard
                                                not_equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.arcticblast
                                                    equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Regeneration (advancements improving the regeneration)"
                                        [command]
                                            {VARIABLE chose regeneration}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.health
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.regeneration
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Lightning (high damage, few attacks, can get firststrike)"
                                        [command]
                                            {VARIABLE chose lightning}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.lightning
                                                not_equals=1
                                            [/variable]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Fire Blast (quite powerful fiery attack)"
                                        [command]
                                            {VARIABLE chose fireblast}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.fireblast
                                                not_equals=1
                                            [/variable]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Fire resistance penetration"
                                        [command]
                                            {VARIABLE chose fire_penetrate}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.firestorm
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.fire_penetrate
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Arctic Blast (capable to slow a lot of units)"
                                        [command]
                                            {VARIABLE chose arcticblast}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.arcticblast
                                                not_equals=1
                                            [/variable]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Cold resistance penetration"
                                        [command]
                                            {VARIABLE chose cold_penetrate}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.blizzard
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.cold_penetrate
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Entropy (a powerful arcane attack, good for retaliation)"
                                        [command]
                                            {VARIABLE chose entropy}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.entropy
                                                not_equals=1
                                            [/variable]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Arcane resistance penetration"
                                        [command]
                                            {VARIABLE chose arcane_penetrate}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.magic
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.arcane_penetrate
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Resist fire"
                                        [command]
                                            {VARIABLE chose resist_fire}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.fireblast
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.resist_fire
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Resist cold"
                                        [command]
                                            {VARIABLE chose resist_cold}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.arcticblast
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.resist_cold
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Resist arcane"
                                        [command]
                                            {VARIABLE chose resist_arcane}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.magic
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.resist_arcane
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Health (+10 to HP advancements)"
                                        [command]
                                            {VARIABLE chose health}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.health
                                                not_equals=1
                                            [/variable]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Leadership"
                                        [command]
                                            {VARIABLE chose leadership}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.leadership
                                                not_equals=1
                                            [/variable]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Healing others"
                                        [command]
                                            {VARIABLE chose heal}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.heal
                                                not_equals=1
                                            [/variable]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Blade resistance penetration"
                                        [command]
                                            {VARIABLE chose blade_penetrate}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.weapons
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.blade_penetrate
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Impact resistance penetration"
                                        [command]
                                            {VARIABLE chose impact_penetrate}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.weapons
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.impact_penetrate
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Pierce resistance penetration"
                                        [command]
                                            {VARIABLE chose pierce_penetrate}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.weapons
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.pierce_penetrate
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Resist blade"
                                        [command]
                                            {VARIABLE chose resist_blade}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.health
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.resist_blade
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Resist pierce"
                                        [command]
                                            {VARIABLE chose resist_pierce}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.health
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.resist_pierce
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Resist impact"
                                        [command]
                                            {VARIABLE chose resist_impact}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.health
                                                equals=1
                                            [/variable]
                                            [and]
                                                [variable]
                                                    name=has.resist_impact
                                                    not_equals=1
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Weapons (improved advancements to weapons' damage)"
                                        [command]
                                            {VARIABLE chose weapons}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.weapons
                                                not_equals=1
                                            [/variable]
                                        [/show_if]
                                    [/option]
                                    [option]
                                        message=_ "Magic (improved advancements to magical damage)"
                                        [command]
                                            {VARIABLE chose magic}
                                        [/command]
                                        [show_if]
                                            [variable]
                                                name=has.magic
                                                not_equals=1
                                            [/variable]
                                        [/show_if]
                                    [/option]
                                [/message]
                                [if]
                                    [variable]
                                        name=chose
                                        equals=0
                                    [/variable]
                                    [then]
                                        {VARIABLE question_asked "$redeemer.variables.redeem_count|/$redeemer.variables.max_redeem_count"}
                                    [/then]
                                    [else]
                                        {VARIABLE_OP redeemer.variables.redeem_count sub $redeemer.variables.max_redeem_count}
                                        [if]
                                            [variable]
                                                name=redeemer.variables.redeem_count
                                                less_than=0
                                            [/variable]
                                            [then]
                                                {VARIABLE redeemer.variables.redeem_count 0}
                                            [/then]
                                        [/if]
                                        {VARIABLE_OP redeemer.variables.max_redeem_count multiply 3}
                                        [set_variable]
                                            name=redeemer.variables.max_redeem_count
                                            divide=2
                                            round=floor
                                        [/set_variable]
                                        {VARIABLE question_asked "$redeemer.variables.redeem_count|/$redeemer.variables.max_redeem_count"}
                                        {CLEAR_VARIABLE redeemer.variables.max_redeem_count}	#Will be reviewed later, for possible errors
                                        [if]
                                            [variable]
                                                name=upgrade_count
                                                greater_than=20
                                            [/variable]
                                            [then]
                                                {VARIABLE upgrade_count 20}
                                            [/then]
                                        [/if]
                                        [switch]
                                            variable=upgrade_count
                                            [case]
                                                value=1		#Clone of the following one for the case if something went wrong
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 1
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_2}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=2
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 1
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_2}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=3
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 2
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_3}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=4
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 3,magical
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_4}
                                                                {WEAPON_SPECIAL_FOCUSED}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=5
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 4
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_5}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=6
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 5
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_6}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=7
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 6
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_7}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=8
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 7,focused
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_8}
                                                                {WEAPON_SPECIAL_GUIDED}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=9
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 8
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_9}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=10
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 9
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_10}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=11
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 10
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_11}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=12
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 11
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_12}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=13
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 12
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_13}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=14
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 13
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_14}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=15
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 14
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_15}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=16
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 15
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_16}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=17
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 16
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_17}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=18
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 17
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_18}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=19
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 18
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_19}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                            [case]
                                                value=20
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                        [effect]
                                                            apply_to=attack
                                                            name="redeem"
                                                            remove_specials=redeem 19
                                                            [set_specials]
                                                                mode=append
                                                                {WEAPON_SPECIAL_REDEEM_20}
                                                            [/set_specials]
                                                        [/effect]
                                                    [/value]
                                                [/set_variables]
                                            [/case]
                                        [/switch]
                                        [if]
                                            [variable]
                                                name=upgrade_count
                                                greater_than=20
                                            [/variable]
                                            [then]
                                                [set_variables]
#ifver WESNOTH_VERSION >= 1.13.2
                                                    name=redeemer.modifications.advancement[$redeemer.modifications.advancement.length]
#else
                                                    name=redeemer.modifications.advance[$redeemer.modifications.advance.length]
#endif
                                                    mode=replace
                                                    [value]
                                                        id=$chose
                                                    [/value]
                                                [/set_variables]
                                            [/then]
                                        [/if]
                                    [/else]
                                [/if]
                                [unstore_unit]
                                    variable=redeemer
                                    {COLOR_HEAL}
                                    text="$question_asked"
                                    find_vacant=no
                                [/unstore_unit]
#ifdef MULTIPLAYER
                            [/then]
                            [else]
                                [unstore_unit]
                                    variable=redeemer
                                    {COLOR_HEAL}
                                    text="$redeemer.variables.redeem_count|/$redeemer.variables.max_redeem_count"
                                    find_vacant=no
                                [/unstore_unit]
                            [/else]
                        [/if]
#endif
                        {UPDATE_STATS}
                    [/then]
                    [else]
                        [unstore_unit]
                            variable=redeemer
                            {COLOR_HEAL}
                            text="$redeemer.variables.redeem_count|/$redeemer.variables.max_redeem_count"
                            find_vacant=no
                        [/unstore_unit]
                    [/else]
                [/if]
            [/then]
            [else]
                {VARIABLE redeemer.variables.redeem_count 1}
                [unstore_unit]
                    variable=redeemer
                    {COLOR_HEAL}
                    text="$redeemer.variables.redeem_count|/$redeemer.variables.max_redeem_count"
                    find_vacant=no
                [/unstore_unit]
            [/else]
        [/if]
        {CLEAR_VARIABLE redeemer,has,question,question_asked,upgrade_count,chose}
    [/event]

    [event]
        name=side turn
        first_time_only=no

        [store_unit]
            [filter]
                [filter_wml]
                    [status]
                        redeem_waiting=yes
                    [/status]
                [/filter_wml]
                side=$side_number
            [/filter]
            variable=redeemer
        [/store_unit]

        {FOREACH redeemer i}
            [if]
                [variable]
                    name=redeemer[$i].variables.redeem_wait
                    equals=0
                [/variable]
                [then]
                    {CLEAR_VARIABLE redeemer[$i].status.redeem_waiting}
                    {CLEAR_VARIABLE redeemer[$i].variables.redeem_wait}
                    {FOREACH redeemer[$i].attack l}
                        [if]
                            [variable]
                                name=redeemer[$i].attack[$l].name
                                equals=redeem
                            [/variable]
                            [then]
                                {CLEAR_VARIABLE redeemer[$i].attack[$l].attack_weight}
                            [/then]
                        [/if]
                    {NEXT l}
                    [unstore_unit]
                        variable=redeemer[$i]
                        {COLOR_HEAL}
                        text= _ "Redeem recharged!"
                    [/unstore_unit]
                [/then]
            [/if]
            [if]
                [variable]
                    name=redeemer[$i].variables.redeem_wait
                    greater_than=0
                [/variable]
                [then]
                    {VARIABLE_OP redeemer[$i].variables.redeem_wait sub 1}
                    [unstore_unit]
                        variable=redeemer[$i]
                    [/unstore_unit]
                [/then]
            [/if]
        {NEXT i}

        {CLEAR_VARIABLE redeemer}
    [/event]
#enddef
